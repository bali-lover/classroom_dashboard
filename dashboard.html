<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•™ìŠµ ì§„ë„íŒ ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f5f7fa;
            overflow-x: hidden;
            zoom: 0.8;
        }

        /* í—¤ë” ìŠ¤íƒ€ì¼ */
        .header {
            background-color: white;
            color: #333;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            margin: 0 0 4px 0;
            font-size: 20px;
            color: #333;
            display: flex;
            align-items: center;
        }

        .header h1::before {
            content: "ğŸ“Š";
            margin-right: 10px;
            font-size: 24px;
        }

        .header-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            align-items: center;
        }

        .btn {
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            display: flex;
            padding: 12px;
            gap: 15px;
            height: calc(100vh - 65px);
        }

        /* ì¢Œì¸¡ ì§„í–‰ìƒí™© ì˜ì—­ */
        .progress-section {
            flex: 2;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            min-height: 780px;
        }

        /* íƒ­ ë²„íŠ¼ */
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 12px;
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 8px;
        }

        .tab-btn {
            padding: 12px 24px;
            border: none;
            background: transparent;
            color: #6b7280;
            border-radius: 0;
            font-size: 24px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
        }

        .tab-btn.active {
            background: transparent;
            color: #047857;
            border-bottom: 3px solid #047857;
            font-weight: 600;
        }

        .tab-btn:hover:not(.active) {
            color: #374151;
            background: rgba(0,0,0,0.05);
        }

        /* ê°œë³„ ëª¨ë“œ ê·¸ë¦¬ë“œ (7x5 = 35ëª…) */
        .individual-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 15px;
            padding: 10px 0;
        }

        /* ì¡°ë³„ ëª¨ë“œ ê·¸ë¦¬ë“œ (2x4 = 8ê°œ ì¡°) */
        .group-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            padding: 10px 0;
        }

        .group-grid .student-card {
            height: 280px;
        }

        /* í•™ìƒ/ì¡° ì¹´ë“œ */
        .student-card {
            border: 2px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            background-color: #f8f9fa;
            text-align: center;
            transition: all 0.3s ease;
            cursor: pointer;
            height: 108px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .student-card.inactive {
            background: #f9fafb;
            border-color: #d1d5db;
            color: #9ca3af;
        }

        .student-card.inactive::after {
            content: "ë¯¸ì‚¬ìš©";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 12px;
            color: #9ca3af;
        }

        .student-card:not(.inactive):hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        /* ì§„í–‰ë¥ ì— ë”°ë¥¸ ë‹¨ì¼ ìƒ‰ìƒ ì§„í–‰ (ì²­ë¡ìƒ‰ ê³„ì—´) */
        .student-card.progress-0 { 
            background: #f8fafc; 
            color: #000 !important; 
        }
        .student-card.progress-20 { 
            background: #f0fdfa; 
            color: #000 !important; 
        }
        .student-card.progress-40 { 
            background: #ccfbf1; 
            color: #000 !important; 
        }
        .student-card.progress-60 { 
            background: #99f6e4; 
            color: #000 !important; 
        }
        .student-card.progress-80 { 
            background: #5eead4; 
            color: #000 !important; 
        }
        .student-card.progress-100 { 
            background: #2dd4bf; 
            color: #000 !important; 
        }

        /* ì ‘ì† ìƒíƒœì— ë”°ë¥¸ í…Œë‘ë¦¬ ìƒ‰ìƒ */
        .student-card.connected { 
            border-color: #6b7280; 
            border-width: 3px;
        }
        
        .student-card:not(.connected) { 
            border-color: #d1d5db; 
        }

        
        /* ë„ì›€ ìš”ì²­ ìŠ¤íƒ€ì¼ */
        .student-card.help-needed {
            border-color: #ef4444;
            border-width: 3px;
            animation: pulse-red 2s infinite;
        }

        
        @keyframes pulse-red {
            0%, 100% { border-color: #ef4444; }
            50% { border-color: #dc2626; }
        }

        @keyframes pulse-teal {
            0%, 100% { border-color: #14b8a6; }
            50% { border-color: #0d9488; }
        }
        
        .student-card .help-indicator {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #ef4444;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            z-index: 15;
        }
        
        .student-card .memo-badge {
            position: absolute;
            top: -10px;
            right: -10px;
            background: #3b82f6;
            color: white;
            border-radius: 50%;
            font-size: 12px;
            font-weight: bold;
            width: 22px;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 999;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.4);
            border: 2px solid white;
            line-height: 1;
        }
        
        .memos-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            padding: 12px;
            background: #f9fafb;
        }

        .memo-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .memo-item:last-child {
            margin-bottom: 0;
        }

        .memo-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .memo-mission {
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .memo-date {
            font-size: 12px;
            color: #6b7280;
        }

        .memo-content {
            color: #4b5563;
            line-height: 1.4;
            font-size: 14px;
        }
        
        /* ë©”ì‹œì§€ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .message-item {
            background: white;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            border-left: 4px solid #e5e7eb;
        }
        
        .message-item.unread {
            border-left-color: #3b82f6;
            background: #eff6ff;
        }
        
        .message-item.read {
            border-left-color: #10b981;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            font-size: 12px;
        }
        
        .message-type {
            font-weight: 600;
            color: #374151;
        }
        
        .message-date {
            color: #6b7280;
        }
        
        .message-status.unread {
            background: #3b82f6;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .message-status.read {
            background: #10b981;
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: 600;
        }
        
        .message-content {
            color: #374151;
            line-height: 1.4;
            font-size: 14px;
            margin-bottom: 8px;
        }
        
        .message-actions {
            text-align: right;
            margin-top: 8px;
        }

        .student-number {
            position: absolute;
            top: 8px;
            left: 8px;
            font-size: 19px;
            font-weight: bold;
            color: #333;
        }

        .progress-100 .student-number {
            color: black;
            background: rgba(255, 255, 255, 0.8);
            padding: 2px 6px;
            border-radius: 4px;
        }
        
        .progress-80 .student-number,
        .progress-60 .student-number {
            color: black;
            background: rgba(255, 255, 255, 0.7);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .student-name {
            font-size: 12px;
            color: #6b7280;
            margin-bottom: 8px;
        }

        .progress-100 .student-name,
        .progress-80 .student-name,
        .progress-60 .student-name {
            color: rgba(255,255,255,0.9);
        }

        .progress-percent {
            font-size: 20px;
            font-weight: 700;
            color: #374151;
            margin-bottom: 5px;
        }

        .progress-100 .progress-percent,
        .progress-80 .progress-percent,
        .progress-60 .progress-percent {
            color: #374151;
        }

        .progress-status {
            font-size: 11px;
            display: flex;
            justify-content: center;
            gap: 3px;
        }

        .status-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #d1d5db;
        }

        .status-dot.completed {
            background: #10b981;
        }

        .status-dot.in-progress {
            background: #f59e0b;
        }

        /* ìš°ì¸¡ ê¸°ëŠ¥ íŒ¨ë„ */
        .function-panel {
            flex: 1;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            min-height: 780px;
        }

        .function-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .function-section:last-child {
            border-bottom: none;
        }

        .function-title {
            font-size: 16px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .mission-section .function-title {
            font-size: 32px;
        }

        .function-title::before {
            margin-right: 8px;
            font-size: 18px;
        }

        .mission-section .function-title::before { content: "ğŸ¯"; }
        .today-section .function-title::before { content: "âœ…"; }

        /* ë¯¸ì…˜ ê´€ë¦¬ UI */
        .mission-controls {
            margin-bottom: 15px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .empty-message {
            color: #9ca3af;
            font-style: italic;
            text-align: center;
            padding: 20px 0;
        }

        /* ìˆ˜ì—… ë¶ˆëŸ¬ì˜¤ê¸° ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .load-tab-buttons {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            margin-bottom: 20px;
        }

        .tab-btn {
            flex: 1;
            padding: 10px 15px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 20px;
            color: #6b7280;
            transition: all 0.2s ease;
        }

        .tab-btn.active {
            color: #3b82f6;
            border-bottom: 2px solid #3b82f6;
            font-weight: 600;
        }

        .tab-btn:hover {
            color: #1f2937;
            background: #f9fafb;
        }

        .load-tab-content {
            min-height: 200px;
        }

        .class-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .class-item {
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            background: #f9fafb;
        }

        .class-item:hover {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .class-item.selected {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .class-item-title {
            font-size: 16px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 5px;
        }

        .class-item-info {
            font-size: 14px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .class-item-meta {
            display: flex;
            gap: 10px;
        }

        .class-item-badge {
            background: #ddd6fe;
            color: #5b21b6;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .class-item-badge.individual {
            background: #dbeafe;
            color: #1e40af;
        }

        .class-item-badge.team {
            background: #dcfce7;
            color: #166534;
        }

        .class-item-delete {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #fee2e2;
            color: #dc2626;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0.7;
            transition: all 0.2s ease;
        }

        .class-item-delete:hover {
            background: #fecaca;
            opacity: 1;
            transform: scale(1.1);
        }

        .class-item {
            position: relative;
        }

        .loading-message {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        .mission-item {
            display: flex;
            align-items: center;
            padding: 12px;
            margin-bottom: 10px;
            background: #f9fafb;
            border-radius: 10px;
            border: 2px solid transparent;
            transition: all 0.3s ease;
            cursor: move;
            position: relative;
        }

        .mission-item:hover {
            background: #f3f4f6;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .mission-item.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }

        .mission-item.drag-over {
            border-color: #3b82f6;
            background: #eff6ff;
        }

        .mission-item.today-selected {
            border-color: #10b981;
            background: #ecfdf5;
        }

        .mission-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            z-index: 1000;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .drag-handle {
            color: #9ca3af;
            font-size: 16px;
            margin-right: 8px;
            cursor: grab;
            user-select: none;
            line-height: 1;
        }

        .drag-handle:hover {
            color: #6b7280;
        }

        .drag-handle:active {
            cursor: grabbing;
        }

        .mission-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .mission-number:hover {
            background: #d1d5db;
        }

        .mission-number.today-active {
            background: #10b981;
            color: white;
        }

        .mission-text {
            flex: 1;
            font-size: 14px;
            color: #374151;
        }

        .mission-text input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 14px;
            color: #374151;
            padding: 4px 0;
            outline: none;
            cursor: text;
        }

        .mission-text input:focus {
            background: white;
            padding: 6px 10px;
            border-radius: 6px;
            border: 2px solid #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .mission-text:hover input:not(:focus) {
            background: rgba(255, 255, 255, 0.7);
            padding: 4px 8px;
            border-radius: 4px;
        }

        .mission-actions {
            display: flex;
            gap: 4px;
        }

        .btn-icon {
            width: 24px;
            height: 24px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            transition: all 0.2s ease;
        }

        .btn-delete {
            background: #fee2e2;
            color: #dc2626;
        }

        .btn-delete:hover {
            background: #fecaca;
        }
        
        .btn-add-detail {
            background: #d1fae5;
            color: #059669;
        }
        
        .btn-add-detail:hover {
            background: #a7f3d0;
        }

        /* ë¯¸ì…˜ ìƒíƒœ */
        .mission-step {
            display: flex;
            align-items: center;
            padding: 14px 0;
            font-size: 24px;
        }

        .mission-step-number {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            margin-right: 10px;
        }

        .mission-step.completed .mission-step-number {
            background: #10b981;
            color: white;
        }

        .mission-step.current .mission-step-number {
            background: #f59e0b;
            color: white;
        }

        .mission-step.pending .mission-step-number {
            background: #e5e7eb;
            color: #6b7280;
        }
        
        .all-mission-steps .mission-step-number {
            background: #e5e7eb;
            color: #6b7280;
        }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border-radius: 12px;
            padding: 30px;
            width: 480px;
            max-width: 90vw;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: #374151;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 24px;
            color: #6b7280;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
        }

        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px 12px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-select:focus, .form-textarea:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-textarea {
            resize: vertical;
            min-height: 120px;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 8px;
        }

        .radio-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .modal-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 1px solid #e5e7eb;
        }

        /* ë‹¨ê³„ í‘œì‹œ */
        .step-indicator {
            display: flex;
            justify-content: center;
            margin-bottom: 25px;
        }

        .step {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: #e5e7eb;
            color: #6b7280;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin: 0 10px;
            position: relative;
        }

        .step.active {
            background: #3b82f6;
            color: white;
        }

        .step.completed {
            background: #10b981;
            color: white;
        }

        .step:not(:last-child)::after {
            content: "";
            position: absolute;
            right: -25px;
            top: 50%;
            transform: translateY(-50%);
            width: 15px;
            height: 2px;
            background: #e5e7eb;
        }

        .step.completed:not(:last-child)::after {
            background: #10b981;
        }

        /* íƒ­ ì½˜í…ì¸  */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            height: calc(100% - 60px);
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
        }

        /* QR ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #qrModal .modal-body {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        #qr-container {
            width: 250px;
            height: 250px;
            margin-bottom: 20px;
        }

        /* ë©”ì‹œì§€ ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #messageModal .modal-body {
            padding-bottom: 10px;
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1200px) {
            .individual-grid {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                height: auto;
            }
            
            .individual-grid {
                grid-template-columns: repeat(3, 1fr);
            }
            
            .group-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
    <script src="https://cdn.rawgit.com/davidshimjs/qrcodejs/gh-pages/qrcode.min.js"></script>
</head>
<body>
    <div class="header">
        <h1>í•™ìŠµ ì§„ë„íŒ ê´€ë¦¬ ì‹œìŠ¤í…œ</h1>
        <div class="header-buttons">
            <button class="btn btn-info" onclick="openQRModal()">ğŸ“± QR ì½”ë“œ</button>
            <button class="btn btn-success" onclick="openMessageModal()">ğŸ’¬ ë©”ì‹œì§€</button>
            <button class="btn btn-warning" onclick="openNewClassModal()">ìƒˆ ìˆ˜ì—… ì‹œì‘</button>
            <button class="btn btn-danger" onclick="openLoadClassModal()">ìˆ˜ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
        </div>
    </div>

    <div class="main-container">
        <div class="progress-section">
            <div class="tab-buttons">
                <button class="tab-btn active" onclick="switchTab('individual')">í•™ìƒ ê°œë³„</button>
                <button class="tab-btn" onclick="switchTab('group')">ì¡°ë³„</button>
            </div>

            <div id="individual-tab" class="tab-content active">
                <div class="individual-grid" id="individual-grid">
                    </div>
            </div>

            <div id="group-tab" class="tab-content">
                <div class="group-grid" id="group-grid">
                    </div>
            </div>
        </div>

        <div class="function-panel">
            <div class="function-section mission-section">
                <div class="function-title">ì „ì²´ ë¯¸ì…˜ ë‹¨ê³„</div>
                <div class="mission-controls">
                    <button class="btn btn-success btn-sm add-mission-btn" onclick="addNewMission()">â• ìƒˆ ë¯¸ì…˜ ì¶”ê°€</button>
                </div>
                <div id="all-mission-steps">
                    <div class="empty-message">ìƒˆ ìˆ˜ì—…ì„ ìƒì„±í•˜ê±°ë‚˜ ê¸°ì¡´ ìˆ˜ì—…ì„ ë¶ˆëŸ¬ì™€ì£¼ì„¸ìš”.</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="newClassModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ìƒˆ ìˆ˜ì—… ì„¤ì •</h3>
                <button class="close-btn" onclick="closeModal('newClassModal')">&times;</button>
            </div>

            <!-- ë‹¨ê³„ í‘œì‹œ ì œê±° (1ë‹¨ê³„ë§Œ ìˆìœ¼ë¯€ë¡œ ë¶ˆí•„ìš”) -->

            <div id="modal-step1" class="modal-step">
                <div class="form-group">
                    <label class="form-label">ìˆ˜ì—… ì œëª©</label>
                    <input type="text" class="form-input" id="classTitle" placeholder="ì˜ˆ: êµ­ì–´ 1ë‹¨ì› í•™ìŠµ">
                </div>

                <div class="form-group">
                    <label class="form-label">ìˆ˜ì—… ëª¨ë“œ</label>
                    <div class="radio-group">
                        <div class="radio-item">
                            <input type="radio" name="classMode" id="individual" value="individual" checked>
                            <label for="individual">ê°œë³„ ëª¨ë“œ</label>
                        </div>
                        <div class="radio-item">
                            <input type="radio" name="classMode" id="group" value="group">
                            <label for="group">ì¡°ë³„ ëª¨ë“œ</label>
                        </div>
                    </div>
                </div>

                <div class="form-group" id="studentCountGroup">
                    <label class="form-label">í•™ìƒ ìˆ˜</label>
                    <input type="number" class="form-input" id="studentCount" min="1" max="50" value="35">
                </div>

                <div class="form-group" id="groupCountGroup" style="display: none;">
                    <label class="form-label">ì¡° ê°œìˆ˜</label>
                    <input type="number" class="form-input" id="groupCount" min="1" max="8" value="4">
                </div>
            </div>


            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeModal('newClassModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="startNewClass()">ìˆ˜ì—… ìƒì„±</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="qrModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">í•™ìƒ ì ‘ì†ìš© QR ì½”ë“œ</h3>
                <button class="close-btn" onclick="closeModal('qrModal')">&times;</button>
            </div>
            <div class="modal-body">
                <p>í•™ìƒë“¤ì—ê²Œ ì´ QR ì½”ë“œë¥¼ ê³µìœ í•˜ì—¬ í•™ìŠµ ì‹œìŠ¤í…œì— ì ‘ì†í•˜ê²Œ í•˜ì„¸ìš”.</p>
                <div id="qr-container"></div>
                <div style="font-size: 14px; margin-top: 10px; color: #6b7280;">
                    <a id="qr-url" href="#" target="_blank"></a>
                </div>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="messageModal">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">í•™ìƒë“¤ì—ê²Œ ë©”ì‹œì§€ ë³´ë‚´ê¸°</h3>
                <button class="close-btn" onclick="closeModal('messageModal')">&times;</button>
            </div>
            <div class="modal-body">
                <textarea class="form-textarea" id="messageInput" placeholder="í•™ìƒë“¤ì—ê²Œ ì „ë‹¬í•  ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."></textarea>
            </div>
            <div class="modal-buttons" style="justify-content: flex-end;">
                <button class="btn btn-primary" onclick="sendMessage()">ë©”ì‹œì§€ ì „ì†¡</button>
            </div>
        </div>
    </div>

    <div class="modal-overlay" id="loadClassModal">
        <div class="modal" style="max-width: 600px; max-height: 70vh;">
            <div class="modal-header">
                <h3 class="modal-title">ê¸°ì¡´ ìˆ˜ì—… ë¶ˆëŸ¬ì˜¤ê¸°</h3>
                <button class="close-btn" onclick="closeModal('loadClassModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <div class="load-options">
                    <div class="load-tab-buttons">
                        <button class="tab-btn active" onclick="switchLoadTab('list')">ìˆ˜ì—… ëª©ë¡</button>
                        <button class="tab-btn" onclick="switchLoadTab('id')">í´ë˜ìŠ¤ ID ì…ë ¥</button>
                    </div>
                    
                    <!-- ìˆ˜ì—… ëª©ë¡ íƒ­ -->
                    <div id="class-list-tab" class="load-tab-content">
                        <div id="class-list-loading" class="loading-message" style="display: none;">
                            <div class="loading-spinner"></div>
                            <p>í™œì„± ìˆ˜ì—…ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                        </div>
                        <div id="class-list-container" class="class-list">
                            <div class="empty-message">í™œì„± ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>
                        </div>
                    </div>
                    
                    <!-- í´ë˜ìŠ¤ ID ì…ë ¥ íƒ­ -->
                    <div id="class-id-tab" class="load-tab-content" style="display: none;">
                        <div class="form-group">
                            <label class="form-label">í´ë˜ìŠ¤ ID</label>
                            <input type="text" class="form-input" id="loadClassId" 
                                   placeholder="í´ë˜ìŠ¤ IDë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: class_abc123_xyz)">
                        </div>
                        <div class="form-group">
                            <p style="font-size: 14px; color: #6b7280; margin-top: 10px;">
                                ğŸ’¡ í´ë˜ìŠ¤ IDëŠ” ìˆ˜ì—… ìƒì„±ì‹œ í‘œì‹œë˜ì—ˆë˜ ê³ ìœ  ì‹ë³„ìì…ë‹ˆë‹¤.<br>
                                QR ì½”ë“œ URLì—ì„œë„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            </p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons" style="justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeModal('loadClassModal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" id="loadClassButton" onclick="loadExistingClass()">ë¶ˆëŸ¬ì˜¤ê¸°</button>
            </div>
        </div>
    </div>

    <!-- Firebase ì„¤ì • -->
    <script type="module">
        // Firebase ì„¤ì •ê³¼ í•¨ìˆ˜ë“¤ì„ ì§ì ‘ í¬í•¨
        
        // Firebase import
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
        import { 
          getFirestore, 
          collection, 
          doc, 
          addDoc, 
          getDoc, 
          getDocs, 
          updateDoc, 
          setDoc,
          deleteDoc,
          query, 
          where, 
          orderBy,
          onSnapshot,
          serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

        import { 
          getDatabase, 
          ref, 
          set, 
          get, 
          push, 
          onValue, 
          off 
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
          apiKey: "AIzaSyBV1IFHlWjQ6ftVmnhX74YITKWCdsjdZLM",
          authDomain: "classroom-progress.firebaseapp.com",
          databaseURL: "https://classroom-progress-default-rtdb.asia-southeast1.firebasedatabase.app/",
          projectId: "classroom-progress",
          storageBucket: "classroom-progress.firebasestorage.app",
          messagingSenderId: "307617869427",
          appId: "1:307617869427:web:20a35dc705cc3fc3854406"
        };

        // Firebase ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const realtimeDb = getDatabase(app);

        // ì „ì—­ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.realtimeDb = realtimeDb;

        // Firebase í•¨ìˆ˜ë“¤ì„ ì „ì—­ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
        window.firebaseFunctions = {
          collection, doc, addDoc, getDoc, getDocs, updateDoc, setDoc, deleteDoc,
          query, where, orderBy, onSnapshot, serverTimestamp,
          ref, set: set, get: get, push, onValue, off
        };

        // Firebase í•¨ìˆ˜ë“¤ ì •ì˜
        
        // ì„¸ì…˜ ID ìƒì„± í•¨ìˆ˜
        function generateSessionId() {
          return 'session_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 5);
        }

        // í´ë˜ìŠ¤ ID ìƒì„± í•¨ìˆ˜  
        function generateClassId() {
          return 'class_' + Date.now().toString(36) + '_' + Math.random().toString(36).substr(2, 5);
        }

        // ìƒˆ ìˆ˜ì—… ìƒì„± í•¨ìˆ˜
        async function createNewClass(classData) {
          try {
            const classId = generateClassId();
            const sessionId = generateSessionId();
            
            const classDoc = {
              classId: classId,
              sessionId: sessionId,
              title: classData.title,
              mode: classData.mode,
              createdAt: serverTimestamp(),
              status: 'active',
              missions: {},
              todayMissions: []
            };
            
            await addDoc(collection(db, 'classes'), classDoc);
            
            console.log('ìƒˆ ìˆ˜ì—… ìƒì„± ì™„ë£Œ:', classId);
            return {
              success: true,
              classId: classId,
              sessionId: sessionId,
              message: 'ìƒˆ ìˆ˜ì—…ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤.'
            };
          } catch (error) {
            console.error('ìƒˆ ìˆ˜ì—… ìƒì„± ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // êµì‚¬ ëŒ€ì‹œë³´ë“œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getTeacherDashboardData(classId) {
          try {
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            const studentsData = [];
            
            progressSnapshot.forEach(doc => {
              const data = doc.data();
              studentsData.push({
                studentId: data.studentId,
                missions: data.missions || [],
                progress: data.progress || 0,
                helpNeeded: data.helpNeeded || 'NO',
                hasNewMessage: data.hasNewMessage || 'NO',
                unreadMemos: data.unreadMemos || 0
              });
            });
            
            return studentsData;
          } catch (error) {
            console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            return [];
          }
        }

        // í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getStudentData(studentId, classId) {
          try {
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            let studentData = { missions: [], messages: [] };
            
            if (!progressSnapshot.empty) {
              const data = progressSnapshot.docs[0].data();
              studentData.missions = data.missions || [];
            }
            
            const messagesQuery = query(
              collection(db, 'messages'),
              where('classId', '==', classId),
              where('recipient', 'in', [studentId, 'all'])
            );
            
            const messagesSnapshot = await getDocs(messagesQuery);
            const messages = [];
            
            messagesSnapshot.forEach(doc => {
              const data = doc.data();
              messages.push({
                text: data.message,
                timestamp: formatTimestamp(data.timestamp),
                rawTimestamp: data.timestamp
              });
            });
            
            messages.sort((a, b) => {
              const aTime = a.rawTimestamp?.toDate ? a.rawTimestamp.toDate() : new Date(a.rawTimestamp);
              const bTime = b.rawTimestamp?.toDate ? b.rawTimestamp.toDate() : new Date(b.rawTimestamp);
              return bTime - aTime;
            });
            
            studentData.messages = messages;
            
            return {
              success: true,
              data: studentData
            };
          } catch (error) {
            console.error('í•™ìƒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            return {
              success: false,
              data: { missions: [], messages: [] }
            };
          }
        }

        // í•™ìƒ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
        async function updateStudentProgress(studentId, classId, missionData, helpNeeded = null) {
          try {
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            
            const completedMissions = missionData.filter(m => m.completed).length;
            const totalMissions = missionData.length;
            const progress = totalMissions > 0 ? Math.round((completedMissions / totalMissions) * 100) : 0;
            
            const progressData = {
              classId: classId,
              studentId: studentId,
              missions: missionData,
              progress: progress,
              lastUpdate: serverTimestamp(),
              helpNeeded: helpNeeded !== null ? (helpNeeded ? 'YES' : 'NO') : 'NO',
              hasNewMessage: 'NO'
            };
            
            if (progressSnapshot.empty) {
              await setDoc(doc(collection(db, 'studentProgress')), progressData);
            } else {
              const docRef = progressSnapshot.docs[0].ref;
              await setDoc(docRef, progressData, { merge: true });
            }
            
            await sendRealtimeNotification(classId, 'progress-updated', { studentId, progress });
            
            return { success: true, progress: progress };
          } catch (error) {
            console.error('ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // ë¯¸ì…˜ ì €ì¥
        async function saveMissions(classId, missions) {
          try {
            const classQuery = query(
              collection(db, 'classes'),
              where('classId', '==', classId)
            );
            
            const classSnapshot = await getDocs(classQuery);
            
            if (!classSnapshot.empty) {
              const classDocRef = classSnapshot.docs[0].ref;
              
              const missionsObj = {};
              missions.forEach(mission => {
                missionsObj[mission.id] = {
                  text: mission.text,
                  description: mission.description || ''
                };
              });
              
              await setDoc(classDocRef, {
                missions: missionsObj
              }, { merge: true });
              
              await sendRealtimeNotification(classId, 'missions-updated', { missions: missionsObj });
            }
            
            return { success: true };
          } catch (error) {
            console.error('ë¯¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì €ì¥
        async function saveTodayMissions(classId, todayMissions) {
          try {
            const classQuery = query(
              collection(db, 'classes'),
              where('classId', '==', classId)
            );
            
            const classSnapshot = await getDocs(classQuery);
            
            if (!classSnapshot.empty) {
              const classDocRef = classSnapshot.docs[0].ref;
              
              await setDoc(classDocRef, {
                todayMissions: todayMissions
              }, { merge: true });
              
              await sendRealtimeNotification(classId, 'today-missions-updated', { todayMissions });
            }
            
            return { success: true };
          } catch (error) {
            console.error('ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // ë¯¸ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getMissions(classId) {
          try {
            const classQuery = query(
              collection(db, 'classes'),
              where('classId', '==', classId)
            );
            
            const classSnapshot = await getDocs(classQuery);
            
            if (!classSnapshot.empty) {
              const data = classSnapshot.docs[0].data();
              
              const missions = [];
              if (data.missions) {
                Object.keys(data.missions).forEach(id => {
                  const missionData = data.missions[id];
                  missions.push({
                    id: parseInt(id),
                    text: typeof missionData === 'string' ? missionData : missionData.text,
                    description: typeof missionData === 'string' ? '' : (missionData.description || '')
                  });
                });
              }
              
              missions.sort((a, b) => a.id - b.id);
              
              return {
                success: true,
                data: {
                  missions: missions,
                  todayMissions: data.todayMissions || [],
                  mode: data.mode || 'individual',
                  count: data.count || 35
                }
              };
            }
            
            return {
              success: true,
              data: { missions: [], todayMissions: [], mode: 'individual', count: 35 }
            };
          } catch (error) {
            console.error('ë¯¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
            return {
              success: false,
              data: { missions: [], todayMissions: [], mode: 'individual', count: 35 }
            };
          }
        }

        // ë„ì›€ ìš”ì²­ ì „ì†¡
        async function sendHelpRequest(studentId, classId) {
          try {
            await addDoc(collection(db, 'helpRequests'), {
              classId: classId,
              studentId: studentId,
              timestamp: serverTimestamp(),
              status: 'pending'
            });
            
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            if (!progressSnapshot.empty) {
              const docRef = progressSnapshot.docs[0].ref;
              await setDoc(docRef, {
                helpNeeded: 'YES'
              }, { merge: true });
            }
            
            await sendRealtimeNotification(classId, 'help-requested', { studentId });
            
            return { success: true };
          } catch (error) {
            console.error('ë„ì›€ ìš”ì²­ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // ë©”ì‹œì§€ ì „ì†¡
        async function sendMessage(classId, recipient, message) {
          try {
            await addDoc(collection(db, 'messages'), {
              classId: classId,
              recipient: recipient,
              message: message,
              sender: 'Teacher',
              timestamp: serverTimestamp()
            });
            
            await sendRealtimeNotification(classId, 'message-sent', { recipient, message });
            
            return { success: true };
          } catch (error) {
            console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡
        async function sendRealtimeNotification(classId, type, data = {}) {
          try {
            await addDoc(collection(db, 'notifications'), {
              classId: classId,
              type: type,
              timestamp: serverTimestamp(),
              timestampMs: Date.now(),
              data: data
            });
            
            console.log('ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡:', type, data);
          } catch (error) {
            console.error('ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:', error);
          }
        }

        // ì‹¤ì‹œê°„ ì•Œë¦¼ êµ¬ë…
        function subscribeToNotifications(classId, callback) {
          const notificationsQuery = query(
            collection(db, 'notifications'),
            where('classId', '==', classId)
          );
          
          const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
          
          return onSnapshot(notificationsQuery, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
              if (change.type === 'added') {
                const data = change.doc.data();
                
                if (data.timestampMs > fiveMinutesAgo) {
                  callback({
                    type: data.type,
                    timestamp: data.timestampMs,
                    data: data.data
                  });
                }
              }
            });
          });
        }

        // ì‹¤ì‹œê°„ ì§„í–‰ìƒí™© êµ¬ë…
        function subscribeToProgressUpdates(classId, callback) {
          const progressQuery = query(
            collection(db, 'studentProgress'),
            where('classId', '==', classId)
          );
          
          return onSnapshot(progressQuery, (querySnapshot) => {
            const progressData = [];
            querySnapshot.forEach((doc) => {
              const data = doc.data();
              progressData.push(data);
            });
            callback(progressData);
          });
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ í¬ë§· í•¨ìˆ˜
        function formatTimestamp(timestamp) {
          if (!timestamp) return '';
          
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // í´ë˜ìŠ¤ ì‚­ì œ ê¸°ëŠ¥
        async function deleteClass(classId) {
          try {
            let deletedCount = 0;
            
            async function deleteCollection(collectionName, description) {
              try {
                const q = query(
                  collection(db, collectionName),
                  where('classId', '==', classId)
                );
                
                const snapshot = await getDocs(q);
                
                for (let i = 0; i < snapshot.docs.length; i++) {
                  const doc = snapshot.docs[i];
                  await deleteDoc(doc.ref);
                  deletedCount++;
                  
                  if (i > 0 && i % 5 === 0) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                  }
                }
                
              } catch (error) {
                console.warn(`${description} ì‚­ì œ ì¤‘ ì˜¤ë¥˜:`, error.message);
              }
            }
            
            await deleteCollection('classes', 'í´ë˜ìŠ¤ ì •ë³´');
            await deleteCollection('studentProgress', 'í•™ìƒ ì§„í–‰ìƒí™©');
            await deleteCollection('messages', 'ë©”ì‹œì§€ ë°ì´í„°');
            await deleteCollection('notifications', 'ì•Œë¦¼ ë°ì´í„°');
            await deleteCollection('helpRequests', 'ë„ì›€ ìš”ì²­');
            
            return { 
              success: true, 
              message: `í´ë˜ìŠ¤ê°€ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤. (${deletedCount}ê°œ ë¬¸ì„œ ì‚­ì œ)`,
              deletedCount 
            };
            
          } catch (error) {
            console.error('í´ë˜ìŠ¤ ì‚­ì œ ì˜¤ë¥˜:', error);
            return { 
              success: false, 
              error: `ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ${error.message}`
            };
          }
        }

        // í™œì„± í´ë˜ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
        async function getActiveSessions() {
          try {
            const classesQuery = query(
              collection(db, 'classes'),
              orderBy('createdAt', 'desc')
            );
            
            const classesSnapshot = await getDocs(classesQuery);
            const sessions = [];
            
            classesSnapshot.forEach(doc => {
              const data = doc.data();
              sessions.push({
                sessionId: data.classId,
                classId: data.classId, 
                className: data.title,
                mode: data.mode,
                count: data.count || 35,
                date: data.createdAt,
                status: data.status || 'active'
              });
            });
            
            return {
              success: true,
              sessions: sessions
            };
          } catch (error) {
            console.error('í™œì„± ì„¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
            return {
              success: false,
              sessions: [],
              error: error.message
            };
          }
        }

        // í•™ìƒ ë¯¸ì…˜ ë©”ëª¨ ì €ì¥
        async function saveMissionMemo(studentId, classId, missionId, memoContent) {
          try {
            const classQuery = query(
              collection(db, 'classes'),
              where('classId', '==', classId)
            );
            
            const classSnapshot = await getDocs(classQuery);
            let missionText = 'ë¯¸ì…˜ ì œëª© ì—†ìŒ';
            
            if (!classSnapshot.empty) {
              const classData = classSnapshot.docs[0].data();
              if (classData.missions && classData.missions[missionId]) {
                const missionData = classData.missions[missionId];
                missionText = typeof missionData === 'string' ? missionData : missionData.text;
              }
            }
            
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            
            if (progressSnapshot.empty) {
              return { success: false, error: 'í•™ìƒ ì§„í–‰ìƒí™©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
            }
            
            const docRef = progressSnapshot.docs[0].ref;
            const existingData = progressSnapshot.docs[0].data();
            
            let memos = existingData.memos || [];
            
            const existingMemoIndex = memos.findIndex(m => m.missionId === missionId);
            
            const memoData = {
              missionId: missionId,
              missionText: missionText,
              content: memoContent,
              lastUpdate: new Date()
            };
            
            if (existingMemoIndex >= 0) {
              memos[existingMemoIndex] = memoData;
            } else {
              memos.push(memoData);
            }
            
            await updateDoc(docRef, {
              memos: memos,
              unreadMemos: (existingData.unreadMemos || 0) + 1,
              lastUpdate: new Date()
            });
            
            await addDoc(collection(db, 'studentMemos'), {
              classId: classId,
              studentId: studentId,
              missionId: missionId,
              missionText: missionText,
              content: memoContent,
              timestamp: new Date()
            });
            
            return { success: true };
            
          } catch (error) {
            console.error('ë¯¸ì…˜ ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // ì „ì—­ìœ¼ë¡œ í•¨ìˆ˜ë“¤ ë‚´ë³´ë‚´ê¸°
        window.classProgressFunctions = {
          createNewClass,
          getTeacherDashboardData,
          getStudentData,
          updateStudentProgress,
          saveMissions,
          saveTodayMissions,
          getMissions,
          sendHelpRequest,
          sendMessage,
          subscribeToNotifications,
          subscribeToProgressUpdates,
          getActiveSessions,
          deleteClass,
          saveMissionMemo
        };

        console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ');
        console.log('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ë“¤:', Object.keys(window.classProgressFunctions));
        
        console.log('Firebase ëª¨ë“ˆë“¤ ë¡œë“œ ì™„ë£Œ');
        
        // í•¨ìˆ˜ë“¤ì´ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        window.addEventListener('load', () => {
            console.log('window.classProgressFunctions:', window.classProgressFunctions);
            console.log('Firebase ì¤€ë¹„ ìƒíƒœ:', {
                firebaseDb: window.firebaseDb,
                realtimeDb: window.realtimeDb,
                functions: window.classProgressFunctions
            });
        });
    </script>

    <script>
        // Firebaseë¡œ ì™„ì „ ì „í™˜ - Apps Script URL ì œê±°
        let currentClassId = null; // í˜„ì¬ í™œì„± í´ë˜ìŠ¤ ID
        let currentClassData = null; // í˜„ì¬ í´ë˜ìŠ¤ì˜ ëª¨ë“œì™€ ê°œìˆ˜ ì •ë³´ ì €ì¥
        let currentModalStep = 1;
        let currentTab = 'individual';
        const BASE_URL = window.location.origin + window.location.pathname.replace('dashboard.html', '');
        let missions = {};
        let lastUpdateTime = null;
        let isVisible = true;

        document.addEventListener('DOMContentLoaded', function() {
            initializeStudentCards();
            initializeGroupCards();
            setupEventListeners();
            updateFullMissionDisplay({ 1: 'ë¯¸ì…˜1', 2: 'ë¯¸ì…˜2', 3: 'ë¯¸ì…˜3', 4: 'ë¯¸ì…˜4', 5: 'ë¯¸ì…˜5' });
            
            // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
            console.log('í˜ì´ì§€ ë¡œë“œ - ì´ˆê¸° ë°ì´í„° ë¡œë“œ');
            loadDashboardData();
            
            // íƒ­ì´ í™œì„±í™”ë˜ì–´ ìˆì„ ë•Œë§Œ ë¹ ë¥¸ ì—…ë°ì´íŠ¸
            document.addEventListener('visibilitychange', function() {
                isVisible = !document.hidden;
                if (isVisible) {
                    console.log('íƒ­ í™œì„±í™” - ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨');
                    loadDashboardData();
                }
            });
            
            // ğŸ”¥ Firebase ì‹¤ì‹œê°„ ì—°ê²° ì‹œì‘
            console.log('ğŸ”¥ Firebase ì‹¤ì‹œê°„ ì—°ê²° ì‹œì‘');
            startFirebaseConnections();
        });

        function setupEventListeners() {
            document.querySelectorAll('input[name="classMode"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    toggleModeInputs(this.value);
                });
            });
            
            // totalMissions ìš”ì†ŒëŠ” ë” ì´ìƒ ì¡´ì¬í•˜ì§€ ì•ŠìŒ (1ë‹¨ê³„ ëª¨ë‹¬ë¡œ ë³€ê²½)
        }

        function initializeStudentCards() {
            const grid = document.getElementById('individual-grid');
            grid.innerHTML = '';

            for (let i = 1; i <= 35; i++) {
                const card = createStudentCard(i, true);
                grid.appendChild(card);
            }
        }

        function initializeGroupCards() {
            const grid = document.getElementById('group-grid');
            grid.innerHTML = '';

            for (let i = 1; i <= 8; i++) {
                const card = createGroupCard(i, i <= 4);
                grid.appendChild(card);
            }
        }

        function createStudentCard(number, active = true) {
            const card = document.createElement('div');
            card.className = `student-card ${active ? 'progress-' + getRandomProgress() : 'inactive'}`;
            card.id = `student-${number}`;

            if (active) {
                const progress = getRandomProgress();
                card.innerHTML = `
                    <div class="student-number">${number}ë²ˆ</div>
                    <div class="progress-percent">${progress}%</div>
                    <div class="progress-status">
                        ${createStatusDots(5, Math.floor(progress / 20))}
                    </div>
                `;
            }

            return card;
        }

        function createGroupCard(number, active = true) {
            const card = document.createElement('div');
            card.className = `student-card ${active ? 'progress-' + getRandomProgress() : 'inactive'}`;
            card.id = `group-${number}`;

            if (active) {
                const progress = getRandomProgress();
                card.innerHTML = `
                    <div class="student-number">${number}ì¡°</div>
                    <div class="progress-percent">${progress}%</div>
                    <div class="progress-status">
                        ${createStatusDots(5, Math.floor(progress / 20))}
                    </div>
                `;
            }

            return card;
        }

        function createStatusDots(total, completed) {
            let dots = '';
            for (let i = 0; i < total; i++) {
                if (i < completed) {
                    dots += '<div class="status-dot completed"></div>';
                } else if (i === completed) {
                    dots += '<div class="status-dot in-progress"></div>';
                } else {
                    dots += '<div class="status-dot"></div>';
                }
            }
            return dots;
        }

        function getRandomProgress() {
            const progresses = [0, 20, 40, 60, 80, 100];
            return progresses[Math.floor(Math.random() * progresses.length)];
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.tab-btn[onclick="switchTab('${tabName}')"]`).classList.add('active');

            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName + '-tab').classList.add('active');

            currentTab = tabName;
        }

        function openQRModal() {
            const qrModal = document.getElementById('qrModal');
            const qrContainer = document.getElementById('qr-container');
            const qrUrlElement = document.getElementById('qr-url');
            
            // í˜„ì¬ í™œì„± í´ë˜ìŠ¤ IDë¥¼ URLì— í¬í•¨
            const activeClassId = getCurrentClassId();
            let url = BASE_URL + `student.html`;
            if (activeClassId) {
                url += `?classId=${activeClassId}`;
            }

            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
                text: url,
                width: 250,
                height: 250,
            });

            qrUrlElement.textContent = url;
            qrUrlElement.href = url;

            qrModal.style.display = 'block';
        }
        
        function getCurrentClassId() {
            // URLì—ì„œ classIdë¥¼ ê°€ì ¸ì˜¤ê±°ë‚˜ í˜„ì¬ í™œì„± classId ì‚¬ìš©
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('classId') || currentClassId;
        }

        function openMessageModal() {
            document.getElementById('messageInput').value = '';
            document.getElementById('messageModal').style.display = 'block';
        }

        function openNewClassModal() {
            document.getElementById('newClassModal').style.display = 'block';
            resetModalForm();
        }

        async function openLoadClassModal() {
            document.getElementById('loadClassModal').style.display = 'block';
            
            // ê¸°ë³¸ìœ¼ë¡œ ìˆ˜ì—… ëª©ë¡ íƒ­ì„ í™œì„±í™”í•˜ê³  ë°ì´í„° ë¡œë“œ
            switchLoadTab('list');
            await loadActiveClasses();
        }

        async function loadExistingClass() {
            const activeTab = document.querySelector('.tab-btn.active').textContent;
            let classId = null;
            let className = 'ìˆ˜ì—…';
            
            if (activeTab === 'ìˆ˜ì—… ëª©ë¡') {
                const selectedItem = document.querySelector('.class-item.selected');
                if (!selectedItem) {
                    alert('ë¶ˆëŸ¬ì˜¬ ìˆ˜ì—…ì„ ì„ íƒí•´ì£¼ì„¸ìš”.\n\nğŸ’¡ íŒ: ìˆ˜ì—…ì„ ë”ë¸”í´ë¦­í•˜ë©´ ë°”ë¡œ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                    return;
                }
                classId = selectedItem.dataset.classId;
                className = selectedItem.querySelector('.class-item-title').textContent;
                
                // ì„ íƒëœ í´ë˜ìŠ¤ë¥¼ ë°”ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
                await loadSelectedClass(classId, className);
                return;
                
            } else {
                classId = document.getElementById('loadClassId').value.trim();
                if (!classId) {
                    alert('í´ë˜ìŠ¤ IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }
                className = `í´ë˜ìŠ¤ ${classId}`;
                
                // IDë¡œ ì…ë ¥í•œ í´ë˜ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°
                await loadSelectedClass(classId, className);
                return;
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function resetModalForm() {
            document.getElementById('classTitle').value = '';
            document.getElementById('individual').checked = true;
            document.getElementById('studentCount').value = '35';
            document.getElementById('groupCount').value = '4';
            toggleModeInputs('individual');
        }

        // ëª¨ë‹¬ ë‹¨ê³„ ê´€ë ¨ í•¨ìˆ˜ë“¤ ì œê±°ë¨ (1ë‹¨ê³„ë¡œ ë‹¨ìˆœí™”)

        function toggleModeInputs(mode) {
            const studentGroup = document.getElementById('studentCountGroup');
            const groupGroup = document.getElementById('groupCountGroup');

            if (mode === 'individual') {
                studentGroup.style.display = 'block';
                groupGroup.style.display = 'none';
            } else {
                studentGroup.style.display = 'none';
                groupGroup.style.display = 'block';
            }
        }

        // updateStepSelects í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (1ë‹¨ê³„ ëª¨ë‹¬ë¡œ ë³€ê²½)

        // generateMissionInputs í•¨ìˆ˜ëŠ” ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (1ë‹¨ê³„ ëª¨ë‹¬ë¡œ ë³€ê²½)

        async function startNewClass() {
            console.log('startNewClass í•¨ìˆ˜ í˜¸ì¶œë¨');
            
            // Firebase í•¨ìˆ˜ ì‚¬ìš© ê°€ëŠ¥í•œì§€ í™•ì¸
            if (!window.classProgressFunctions) {
                console.error('Firebase í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤:', window.classProgressFunctions);
                alert('Firebase í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!window.classProgressFunctions.createNewClass) {
                console.error('createNewClass í•¨ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤:', window.classProgressFunctions);
                alert('createNewClass í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const title = document.getElementById('classTitle').value.trim();
            if (!title) {
                alert('ìˆ˜ì—… ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            const modeRadio = document.querySelector('input[name="classMode"]:checked');
            if (!modeRadio) {
                alert('ìˆ˜ì—… ëª¨ë“œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            const mode = modeRadio.value;
            
            const count = mode === 'individual' ?
                document.getElementById('studentCount').value :
                document.getElementById('groupCount').value;

            if (!count || count < 1) {
                alert(mode === 'individual' ? 'í•™ìƒ ìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.' : 'ì¡° ê°œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // Firebaseë¡œ ìƒˆ ìˆ˜ì—… ìƒì„±
            const classData = {
                title,
                mode,
                count: parseInt(count)
            };
            
            console.log('ìƒˆ ìˆ˜ì—… ì„¤ì •:', classData);
            console.log('Firebase ìƒíƒœ:', {
                firebaseDb: window.firebaseDb,
                functions: window.classProgressFunctions
            });
            
            try {
                console.log('createNewClass í•¨ìˆ˜ í˜¸ì¶œ ì¤‘...');
                const result = await window.classProgressFunctions.createNewClass(classData);
                
                if (result.success) {
                    console.log('ìƒˆ ìˆ˜ì—… ìƒì„± ì„±ê³µ:', result);
                    
                    // ìƒˆë¡œ ìƒì„±ëœ í´ë˜ìŠ¤ ID ì €ì¥
                    currentClassId = result.classId;
                    console.log('ìƒˆ í´ë˜ìŠ¤ ID ì €ì¥:', currentClassId);
                    
                    // í´ë˜ìŠ¤ ë°ì´í„° ì €ì¥
                    currentClassData = { mode: classData.mode, count: classData.count };
                    console.log('í´ë˜ìŠ¤ ë°ì´í„° ì €ì¥:', currentClassData);
                    
                    // í—¤ë”ì— ìˆ˜ì—… ì •ë³´ í‘œì‹œ
                    const pageTitle = document.querySelector('.header h1');
                    if (pageTitle) {
                        pageTitle.textContent = title;
                    }
                    
                    if (mode === 'individual') {
                        switchTab('individual');
                        updateIndividualView();
                    } else {
                        switchTab('group');
                        updateGroupView();
                    }

                    // ë¯¸ì…˜ ê´€ë¦¬ UI ì´ˆê¸°í™”
                    initializeMissionManagement();
                    
                    alert(`ìƒˆ ìˆ˜ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤!\ní´ë˜ìŠ¤ ID: ${result.classId}\n\nQR ì½”ë“œë¥¼ í†µí•´ í•™ìƒë“¤ì´ ì´ ìˆ˜ì—…ì— ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.`);
                    
                    // ì‹¤ì‹œê°„ ì—°ê²° ì‹œì‘
                    startFirebaseConnections();
                    
                    closeModal('newClassModal');
                } else {
                    console.error('ìƒˆ ìˆ˜ì—… ìƒì„± ì‹¤íŒ¨:', result.error);
                    alert('ìƒˆ ìˆ˜ì—… ì„¤ì • ì‹¤íŒ¨: ' + result.error);
                }
                
            } catch (error) {
                console.error('ìƒˆ ìˆ˜ì—… ìƒì„± ì˜¤ë¥˜:', error);
                alert('ìƒˆ ìˆ˜ì—… ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function updateIndividualView() {
            const grid = document.getElementById('individual-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 35; i++) {
                const card = createStudentCard(i, true);
                grid.appendChild(card);
            }
        }

        function updateGroupView() {
            const grid = document.getElementById('group-grid');
            grid.innerHTML = '';
            for (let i = 1; i <= 8; i++) {
                const card = createGroupCard(i, true);
                grid.appendChild(card);
            }
        }

        function updateFullMissionDisplay(missions, currentStep = 1) {
            const container = document.getElementById('all-mission-steps');
            container.innerHTML = '';
            for (const step in missions) {
                const missionDiv = document.createElement('div');
                let statusClass = '';
                if (parseInt(step) === currentStep) {
                    statusClass = 'current';
                } else if (parseInt(step) < currentStep) {
                    statusClass = 'completed';
                } else {
                    statusClass = 'pending';
                }
                missionDiv.className = `mission-step ${statusClass}`;
                missionDiv.innerHTML = `
                    <div class="mission-step-number">${step}</div>
                    <span>${missions[step]}</span>
                `;
                container.appendChild(missionDiv);
            }
        }
        
        async function loadDashboardData() {
            console.log('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì¤‘...', currentClassId ? `(í´ë˜ìŠ¤ ID: ${currentClassId})` : '(ê¸°ë³¸ í…œí”Œë¦¿)');
            
            if (!currentClassId) {
                console.log('í™œì„± í´ë˜ìŠ¤ ì—†ìŒ - ë¹ˆ ëŒ€ì‹œë³´ë“œ í‘œì‹œ');
                updateDashboardView([]);
                return;
            }
            
            if (!window.classProgressFunctions) {
                console.error('Firebase í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                updateDashboardView([]);
                return;
            }
            
            try {
                const studentsData = await window.classProgressFunctions.getTeacherDashboardData(currentClassId);
                console.log('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', studentsData.length, 'ëª… í•™ìƒ');
                updateDashboardView(studentsData);
                updateLastRefreshTime();
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                updateDashboardView([]);
            }
        }
        
        function updateLastRefreshTime() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            console.log(`ë§ˆì§€ë§‰ ìƒˆë¡œê³ ì¹¨: ${timeString}`);
            
            // ì„ íƒì : í—¤ë”ì— ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„ í‘œì‹œ
            const userInfo = document.querySelector('.user-info');
            if (userInfo && currentClassId) {
                const originalText = userInfo.textContent.split(' (')[0];
                userInfo.textContent = `${originalText} (ìµœê·¼ ì—…ë°ì´íŠ¸: ${timeString})`;
            }
        }
        
        function updateDashboardView(studentsData) {
            console.log('ëŒ€ì‹œë³´ë“œ ë·° ì—…ë°ì´íŠ¸ ì‹œì‘:', { mode: currentClassData?.mode, studentsData });
            
            // í˜„ì¬ ëª¨ë“œì— ë”°ë¼ ê·¸ë¦¬ë“œ ì„ íƒ
            if (currentClassData && currentClassData.mode === 'group') {
                // ì¡°ë³„ ëª¨ë“œ ì—…ë°ì´íŠ¸
                updateGroupDashboardView(studentsData);
            } else {
                // ê°œë³„ ëª¨ë“œ ì—…ë°ì´íŠ¸
                updateIndividualDashboardView(studentsData);
            }
        }
        
        function updateIndividualDashboardView(studentsData) {
            const individualGrid = document.getElementById('individual-grid');
            individualGrid.innerHTML = '';
            
            // ëª¨ë“  í•™ìƒ ìŠ¬ë¡¯ ìƒì„± (1~35ë²ˆ ê³ ì •)
            for (let studentNum = 1; studentNum <= 35; studentNum++) {
                const student = studentsData ? studentsData.find(s => parseInt(s.studentId) === studentNum) : null;
                const card = document.createElement('div');
                
                if (student) {
                    // í•™ìƒ ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° - ì‹¤ì œ ë°ì´í„° í‘œì‹œ
                    const progressClass = 'progress-' + Math.floor(student.progress / 20) * 20;
                    const helpIndicator = student.helpNeeded === 'YES' ? '<div class="help-indicator">ë„ì›€</div>' : '';
                    const memoBadge = (student.unreadMemos && student.unreadMemos > 0) ? 
                        `<div class="memo-badge">${student.unreadMemos}</div>` : '';
                    // ì ‘ì† ìƒíƒœì™€ ë„ì›€ ìš”ì²­ ìƒíƒœì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¡°í•©
                    let cardClasses = [progressClass];
                    
                    // í•™ìƒ/ì¡° ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì ‘ì†ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
                    if (student.missions && student.missions.length > 0) {
                        cardClasses.push('connected');
                    }
                    
                    // ë„ì›€ ìš”ì²­ì€ ìµœìš°ì„  í‘œì‹œ (ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬)
                    if (student.helpNeeded === 'YES') {
                        cardClasses.push('help-needed');
                    }
                    
                    card.className = `student-card ${cardClasses.join(' ')}`;
                    card.id = `student-${student.studentId}`;
                    
                    card.innerHTML = `
                        <div class="student-number">${student.studentId}</div>
                        <div class="progress-percent">${student.progress}%</div>
                        <div class="progress-status">
                            ${createStatusDots(student.missions.length, student.missions.filter(m => m.completed).length)}
                        </div>
                        ${helpIndicator}
                        ${memoBadge}
                    `;
                    
                    card.addEventListener('click', () => {
                        if (student.helpNeeded === 'YES') {
                            resolveHelp(student.studentId);
                        } else {
                            openStudentDetailModal(student.studentId, false);
                        }
                    });
                } else {
                    // í•™ìƒ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° - ê¸°ë³¸ í‘œì‹œ
                    card.className = `student-card progress-0`;
                    card.id = `student-${studentNum}`;
                    
                    card.innerHTML = `
                        <div class="student-number">${studentNum}</div>
                        <div class="progress-percent">0%</div>
                        <div class="progress-status">
                            ${createStatusDots(5, 0)}
                        </div>
                    `;
                }
                
                individualGrid.appendChild(card);
            }
            
            console.log('ê°œë³„ ëª¨ë“œ ëŒ€ì‹œë³´ë“œ ë·° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }
        
        function updateGroupDashboardView(studentsData) {
            const groupGrid = document.getElementById('group-grid');
            groupGrid.innerHTML = '';
            
            // ëª¨ë“  ì¡° ìŠ¬ë¡¯ ìƒì„± (1~8ì¡° ê³ ì •)
            for (let groupNum = 1; groupNum <= 8; groupNum++) {
                const groupData = studentsData ? studentsData.find(s => parseInt(s.studentId) === groupNum) : null;
                const card = document.createElement('div');
                
                if (groupData) {
                    // ì¡° ë°ì´í„°ê°€ ìˆëŠ” ê²½ìš° - ì‹¤ì œ ë°ì´í„° í‘œì‹œ
                    const progressClass = 'progress-' + Math.floor(groupData.progress / 20) * 20;
                    const helpIndicator = groupData.helpNeeded === 'YES' ? '<div class="help-indicator">ë„ì›€</div>' : '';
                    const memoBadge = (groupData.unreadMemos && groupData.unreadMemos > 0) ? 
                        `<div class="memo-badge">${groupData.unreadMemos}</div>` : '';
                    // ì ‘ì† ìƒíƒœì™€ ë„ì›€ ìš”ì²­ ìƒíƒœì— ë”°ë¥¸ í´ë˜ìŠ¤ ì¡°í•©
                    let cardClasses = [progressClass];
                    
                    // í•™ìƒ/ì¡° ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì ‘ì†ëœ ê²ƒìœ¼ë¡œ ê°„ì£¼
                    if (groupData.missions && groupData.missions.length > 0) {
                        cardClasses.push('connected');
                    }
                    
                    // ë„ì›€ ìš”ì²­ì€ ìµœìš°ì„  í‘œì‹œ (ë¹¨ê°„ìƒ‰ í…Œë‘ë¦¬)
                    if (groupData.helpNeeded === 'YES') {
                        cardClasses.push('help-needed');
                    }
                    
                    card.className = `student-card ${cardClasses.join(' ')}`;
                    card.id = `group-${groupData.studentId}`;
                    
                    card.innerHTML = `
                        <div class="student-number">${groupData.studentId}ì¡°</div>
                        <div class="progress-percent">${groupData.progress}%</div>
                        <div class="progress-status">
                            ${createStatusDots(groupData.missions.length, groupData.missions.filter(m => m.completed).length)}
                        </div>
                        ${helpIndicator}
                        ${memoBadge}
                    `;
                    
                    card.addEventListener('click', () => {
                        if (groupData.helpNeeded === 'YES') {
                            resolveHelp(groupData.studentId);
                        } else {
                            openStudentDetailModal(groupData.studentId, true);
                        }
                    });
                } else {
                    // ì¡° ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° - ê¸°ë³¸ í‘œì‹œ
                    card.className = `student-card progress-0`;
                    card.id = `group-${groupNum}`;
                    
                    card.innerHTML = `
                        <div class="student-number">${groupNum}ì¡°</div>
                        <div class="progress-percent">0%</div>
                        <div class="progress-status">
                            ${createStatusDots(5, 0)}
                        </div>
                    `;
                }
                
                groupGrid.appendChild(card);
            }
            
            console.log('ì¡°ë³„ ëª¨ë“œ ëŒ€ì‹œë³´ë“œ ë·° ì—…ë°ì´íŠ¸ ì™„ë£Œ');
        }

        async function sendMessage() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!currentClassId) {
                alert('í™œì„± í´ë˜ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            if (!window.classProgressFunctions) {
                alert('Firebase ì—°ê²°ì´ ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const result = await window.classProgressFunctions.sendMessage(currentClassId, 'all', message);
                if (result.success) {
                    alert('ë©”ì‹œì§€ê°€ ëª¨ë“  í•™ìƒì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì˜¤ë¥˜:', error);
                alert('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
            
            closeModal('messageModal');
            document.getElementById('messageInput').value = '';
        }

        window.addEventListener('click', function(event) {
            const newClassModal = document.getElementById('newClassModal');
            const qrModal = document.getElementById('qrModal');
            const messageModal = document.getElementById('messageModal');
            const loadClassModal = document.getElementById('loadClassModal');

            if (event.target === newClassModal) {
                closeModal('newClassModal');
            }
            if (event.target === qrModal) {
                closeModal('qrModal');
            }
            if (event.target === messageModal) {
                closeModal('messageModal');
            }
            if (event.target === loadClassModal) {
                closeModal('loadClassModal');
            }
        });

        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    if (modal.style.display === 'block') {
                        modal.style.display = 'none';
                    }
                });
            }
        });

        // ë¯¸ì…˜ ê´€ë¦¬ ì‹œìŠ¤í…œ
        let allMissions = [];
        let todayMissions = new Set();

        function initializeMissionManagement() {
            // ì„œë²„ì—ì„œ ê¸°ì¡´ ë¯¸ì…˜ ë°ì´í„° ë¡œë“œ
            loadMissionsFromServer();
        }

        async function addNewMission() {
            const newMissionId = allMissions.length > 0 ? Math.max(...allMissions.map(m => m.id)) + 1 : 1;
            const newMission = {
                id: newMissionId,
                text: `ë¯¸ì…˜ ${newMissionId} - ìƒˆë¡œìš´ í•™ìŠµ ê³¼ì œ`
            };
            
            allMissions.push(newMission);
            updateMissionDisplay();
            
            // Firebaseì— ì €ì¥
            const classId = getCurrentClassId();
            if (classId) {
                try {
                    await window.classProgressFunctions.saveMissions(classId, allMissions);
                    console.log('ìƒˆ ë¯¸ì…˜ ì¶”ê°€ë¨:', newMission);
                } catch (error) {
                    console.error('ë¯¸ì…˜ ì €ì¥ ì‹¤íŒ¨:', error);
                }
            }
            
            // ë°©ê¸ˆ ì¶”ê°€ëœ ë¯¸ì…˜ì˜ í…ìŠ¤íŠ¸ ì…ë ¥ ì¹¸ì— í¬ì»¤ìŠ¤
            setTimeout(() => {
                const newMissionInput = document.querySelector(`[data-mission-id="${newMissionId}"] input`);
                if (newMissionInput) {
                    newMissionInput.focus();
                    newMissionInput.select();
                }
            }, 100);
        }

        async function deleteMission(missionId) {
            const missionToDelete = allMissions.find(m => m.id === missionId);
            if (!missionToDelete) return;
            
            if (confirm(`"${missionToDelete.text}" ë¯¸ì…˜ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                // ë¡œì»¬ì—ì„œ ì œê±°
                allMissions = allMissions.filter(m => m.id !== missionId);
                todayMissions.delete(missionId);
                
                // ID ì¬ì •ë ¬ (ì„ íƒì‚¬í•­ - ê¸°ì¡´ ë°©ì‹ ìœ ì§€)
                allMissions.forEach((mission, index) => {
                    mission.id = index + 1;
                });
                
                // í™”ë©´ ì—…ë°ì´íŠ¸
                updateMissionDisplay();
                
                // Firebaseì— ì €ì¥
                const classId = getCurrentClassId();
                if (classId) {
                    try {
                        await window.classProgressFunctions.saveMissions(classId, allMissions);
                        await window.classProgressFunctions.saveTodayMissions(classId, Array.from(todayMissions));
                        console.log('ë¯¸ì…˜ ì‚­ì œë¨:', missionToDelete);
                    } catch (error) {
                        console.error('ë¯¸ì…˜ ì‚­ì œ ì €ì¥ ì‹¤íŒ¨:', error);
                    }
                }
            }
        }

        function toggleTodayMission(missionId) {
            if (todayMissions.has(missionId)) {
                todayMissions.delete(missionId);
            } else {
                todayMissions.add(missionId);
            }
            updateMissionDisplay();
            saveTodayMissionsToServer();
            
            // ğŸ”¥ Firebase ì‹¤ì‹œê°„ ì•Œë¦¼
            sendFirebaseNotification('mission-updated', { type: 'today-missions-changed' });
        }

        async function updateMissionText(missionId, newText) {
            const mission = allMissions.find(m => m.id === missionId);
            if (!mission) return;
            
            const oldText = mission.text;
            if (oldText === newText.trim()) return; // ë³€ê²½ì‚¬í•­ ì—†ìœ¼ë©´ íŒ¨ìŠ¤
            
            mission.text = newText.trim();
            console.log(`ë¯¸ì…˜ ${missionId} í…ìŠ¤íŠ¸ ë³€ê²½: "${oldText}" â†’ "${mission.text}"`);
            
            // Firebaseì— ì €ì¥
            const classId = getCurrentClassId();
            if (classId) {
                try {
                    await window.classProgressFunctions.saveMissions(classId, allMissions);
                    console.log('ë¯¸ì…˜ í…ìŠ¤íŠ¸ ë³€ê²½ ì €ì¥ ì™„ë£Œ');
                } catch (error) {
                    console.error('ë¯¸ì…˜ í…ìŠ¤íŠ¸ ë³€ê²½ ì €ì¥ ì‹¤íŒ¨:', error);
                    // ì €ì¥ ì‹¤íŒ¨ì‹œ ì›ë˜ í…ìŠ¤íŠ¸ë¡œ ë³µì›
                    mission.text = oldText;
                }
            }
        }

        function updateMissionDisplay() {
            const allStepsContainer = document.getElementById('all-mission-steps');

            // ì „ì²´ ë¯¸ì…˜ í‘œì‹œ
            if (allMissions.length === 0) {
                allStepsContainer.innerHTML = '<div class="empty-message">ë¯¸ì…˜ ì¶”ê°€ ë²„íŠ¼ì„ í´ë¦­í•˜ì—¬ ìƒˆ ë¯¸ì…˜ì„ ì¶”ê°€í•˜ì„¸ìš”.</div>';
            } else {
                allStepsContainer.innerHTML = '';
                allMissions.forEach(mission => {
                    const missionDiv = document.createElement('div');
                    missionDiv.className = 'mission-item';
                    missionDiv.draggable = true; // ë“œë˜ê·¸ ê°€ëŠ¥ ì„¤ì •
                    missionDiv.dataset.missionId = mission.id; // ë¯¸ì…˜ ID ì €ì¥
                    
                    if (todayMissions.has(mission.id)) {
                        missionDiv.classList.add('today-selected');
                    }
                    
                    // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
                    missionDiv.addEventListener('dragstart', handleDragStart);
                    missionDiv.addEventListener('dragover', handleDragOver);
                    missionDiv.addEventListener('drop', handleDrop);
                    missionDiv.addEventListener('dragend', handleDragEnd);
                    
                    missionDiv.innerHTML = `
                        <div class="drag-handle" title="ë“œë˜ê·¸í•˜ì—¬ ìˆœì„œ ë³€ê²½">â‹®â‹®</div>
                        <div class="mission-number ${todayMissions.has(mission.id) ? 'today-active' : ''}" 
                             onclick="toggleTodayMission(${mission.id})" 
                             title="í´ë¦­í•˜ì—¬ ì˜¤ëŠ˜ì˜ í• ì¼ë¡œ ì„¤ì •/í•´ì œ">${mission.id}</div>
                        <div class="mission-text">
                            <input type="text" 
                                   value="${mission.text}" 
                                   onblur="updateMissionText(${mission.id}, this.value)"
                                   onkeypress="if(event.key==='Enter') this.blur()"
                                   onclick="this.select()"
                                   placeholder="ë¯¸ì…˜ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”">
                        </div>
                        <div class="mission-actions">
                            <button class="btn-icon btn-add-detail" 
                                    onclick="openMissionDetailModal(${mission.id})" 
                                    title="ìƒì„¸ ë‚´ìš© ì¶”ê°€/í¸ì§‘">â•</button>
                            <button class="btn-icon btn-delete" 
                                    onclick="deleteMission(${mission.id})" 
                                    title="ì´ ë¯¸ì…˜ ì‚­ì œ">ğŸ—‘ï¸</button>
                        </div>
                    `;
                    allStepsContainer.appendChild(missionDiv);
                });
            }
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ê´€ë ¨ ë³€ìˆ˜ë“¤
        let draggedElement = null;
        let draggedMissionId = null;

        function handleDragStart(e) {
            draggedElement = e.target;
            draggedMissionId = parseInt(e.target.dataset.missionId);
            e.target.classList.add('dragging');
            
            // ë“œë˜ê·¸ ë°ì´í„° ì„¤ì •
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', e.target.outerHTML);
            
            // ë“œë˜ê·¸ ì‹œì‘í•  ë•Œ ë°˜íˆ¬ëª… íš¨ê³¼
            e.target.style.opacity = '0.5';
            
            console.log('ë“œë˜ê·¸ ì‹œì‘:', draggedMissionId);
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            
            const container = document.getElementById('all-mission-steps');
            const afterElement = getDragAfterElement(container, e.clientY);
            
            if (afterElement == null) {
                container.appendChild(draggedElement);
            } else {
                container.insertBefore(draggedElement, afterElement);
            }
        }

        async function handleDrop(e) {
            e.preventDefault();
            
            if (!draggedElement || !draggedMissionId) return;
            
            console.log('ë“œë¡­ ë°œìƒ');
            
            // ë“œë¡­ ìœ„ì¹˜ ê³„ì‚°
            const container = document.getElementById('all-mission-steps');
            const afterElement = getDragAfterElement(container, e.clientY);
            
            let newPosition = 0;
            if (afterElement) {
                const afterMissionId = parseInt(afterElement.dataset.missionId);
                newPosition = allMissions.findIndex(m => m.id === afterMissionId);
            } else {
                newPosition = allMissions.length;
            }
            
            // í˜„ì¬ ìœ„ì¹˜
            const currentPosition = allMissions.findIndex(m => m.id === draggedMissionId);
            
            if (currentPosition !== newPosition && currentPosition !== newPosition - 1) {
                console.log(`ë¯¸ì…˜ ${draggedMissionId} ì´ë™: ${currentPosition} â†’ ${newPosition}`);
                await reorderMissions(draggedMissionId, newPosition);
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('dragging');
            e.target.style.opacity = '1'; // íˆ¬ëª…ë„ ë³µì›
            
            draggedElement = null;
            draggedMissionId = null;
            
            console.log('ë“œë˜ê·¸ ì¢…ë£Œ');
        }

        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('.mission-item:not(.dragging)')];
            
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: Number.NEGATIVE_INFINITY }).element;
        }

        async function reorderMissions(draggedId, newIndex) {
            // ë“œë˜ê·¸ëœ ë¯¸ì…˜ ì°¾ê¸°
            const draggedMission = allMissions.find(m => m.id === draggedId);
            const oldIndex = allMissions.indexOf(draggedMission);
            
            // ë°°ì—´ì—ì„œ ì œê±°
            allMissions.splice(oldIndex, 1);
            // ìƒˆ ìœ„ì¹˜ì— ì‚½ì…
            allMissions.splice(newIndex, 0, draggedMission);
            
            // ID ì¬í• ë‹¹ (1ë¶€í„° ì‹œì‘)
            allMissions.forEach((mission, index) => {
                const oldId = mission.id;
                const newId = index + 1;
                
                // todayMissions Setë„ ì—…ë°ì´íŠ¸
                if (todayMissions.has(oldId)) {
                    todayMissions.delete(oldId);
                    todayMissions.add(newId);
                }
                
                mission.id = newId;
            });
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            updateMissionDisplay();
            
            // Firebaseì— ì €ì¥
            const classId = getCurrentClassId();
            if (classId) {
                try {
                    await window.classProgressFunctions.saveMissions(classId, allMissions);
                    await window.classProgressFunctions.saveTodayMissions(classId, Array.from(todayMissions));
                    console.log('ë¯¸ì…˜ ìˆœì„œ ë³€ê²½ ì €ì¥ ì™„ë£Œ');
                } catch (error) {
                    console.error('ë¯¸ì…˜ ìˆœì„œ ë³€ê²½ ì €ì¥ ì‹¤íŒ¨:', error);
                }
            }
            
            // ğŸ”¥ Firebase ì‹¤ì‹œê°„ ì•Œë¦¼
            sendFirebaseNotification('structure-updated', { type: 'missions-reordered', newOrder: allMissions.map(m => m.id) });
            
            console.log('ë¯¸ì…˜ ìˆœì„œ ë³€ê²½ ì™„ë£Œ:', allMissions);
        }

        // ğŸ”¥ Firebase ì•Œë¦¼ ì „ì†¡ í•¨ìˆ˜
        function sendFirebaseNotification(type, data = {}) {
            if (!currentClassId) {
                console.log('classIdê°€ ì—†ì–´ì„œ Firebase ì•Œë¦¼ ì „ì†¡ ì•ˆ í•¨');
                return;
            }
            
            try {
                const { ref, set } = window.firebaseFunctions;
                const realtimeDb = window.realtimeDb;
                const notificationRef = ref(realtimeDb, `classes/${currentClassId}/notifications`);
                
                const notification = {
                    type: type,
                    timestamp: Date.now(),
                    ...data
                };
                
                set(notificationRef, notification);
                console.log('ğŸ”¥ Firebase ì•Œë¦¼ ì „ì†¡:', notification);
            } catch (error) {
                console.error('Firebase ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨:', error);
            }
        }

        async function saveMissionsToServer() {
            if (!currentClassId || allMissions.length === 0) return;
            
            if (!window.classProgressFunctions) {
                console.error('Firebase í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }
            
            try {
                const result = await window.classProgressFunctions.saveMissions(currentClassId, allMissions);
                if (!result.success) {
                    console.error('ë¯¸ì…˜ ì €ì¥ ì‹¤íŒ¨:', result.error);
                }
            } catch (error) {
                console.error('ë¯¸ì…˜ ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        async function saveTodayMissionsToServer() {
            if (!currentClassId) return;
            
            if (!window.classProgressFunctions) {
                console.error('Firebase í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }
            
            try {
                const result = await window.classProgressFunctions.saveTodayMissions(currentClassId, Array.from(todayMissions));
                if (!result.success) {
                    console.error('ì˜¤ëŠ˜ì˜ í• ì¼ ì €ì¥ ì‹¤íŒ¨:', result.error);
                }
            } catch (error) {
                console.error('ì˜¤ëŠ˜ì˜ í• ì¼ ì €ì¥ ì˜¤ë¥˜:', error);
            }
        }

        async function loadMissionsFromServer() {
            if (!currentClassId) return;
            
            if (!window.classProgressFunctions) {
                console.error('Firebase í•¨ìˆ˜ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                return;
            }
            
            try {
                const result = await window.classProgressFunctions.getMissions(currentClassId);
                if (result.success) {
                    allMissions = result.data.missions || [];
                    todayMissions = new Set(result.data.todayMissions || []);
                    updateMissionDisplay();
                    console.log('ë¯¸ì…˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                } else {
                    console.error('ë¯¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', result.error);
                }
            } catch (error) {
                console.error('ë¯¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ìˆ˜ì—… ë¶ˆëŸ¬ì˜¤ê¸° ê´€ë ¨ í•¨ìˆ˜ë“¤
        function switchLoadTab(tabName) {
            // íƒ­ ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // íƒ­ ë‚´ìš© í‘œì‹œ/ìˆ¨ê¸°ê¸°
            document.querySelectorAll('.load-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            if (tabName === 'list') {
                document.querySelector('.tab-btn:first-child').classList.add('active');
                document.getElementById('class-list-tab').style.display = 'block';
                document.getElementById('loadClassButton').textContent = 'ì„ íƒí•œ ìˆ˜ì—… ë¶ˆëŸ¬ì˜¤ê¸°';
            } else {
                document.querySelector('.tab-btn:last-child').classList.add('active');
                document.getElementById('class-id-tab').style.display = 'block';
                document.getElementById('loadClassButton').textContent = 'í´ë˜ìŠ¤ IDë¡œ ë¶ˆëŸ¬ì˜¤ê¸°';
            }
        }
        
        async function loadActiveClasses() {
            const loadingEl = document.getElementById('class-list-loading');
            const containerEl = document.getElementById('class-list-container');
            
            loadingEl.style.display = 'block';
            containerEl.innerHTML = '';
            
            try {
                const result = await window.classProgressFunctions.getActiveSessions();
                
                loadingEl.style.display = 'none';
                
                if (result.success && result.sessions.length > 0) {
                    containerEl.innerHTML = '';
                    
                    result.sessions.forEach(session => {
                        const classItem = createClassItem(session);
                        containerEl.appendChild(classItem);
                    });
                } else {
                    containerEl.innerHTML = '<div class="empty-message">í™œì„± ìˆ˜ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
                
            } catch (error) {
                console.error('í™œì„± ìˆ˜ì—… ë¡œë“œ ì‹¤íŒ¨:', error);
                loadingEl.style.display = 'none';
                containerEl.innerHTML = '<div class="empty-message">ìˆ˜ì—… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        function createClassItem(session) {
            const div = document.createElement('div');
            div.className = 'class-item';
            div.dataset.classId = session.sessionId;
            
            const formatDate = (timestamp) => {
                if (!timestamp) return 'ì•Œ ìˆ˜ ì—†ìŒ';
                const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                return date.toLocaleString('ko-KR', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            };
            
            div.innerHTML = `
                <div class="class-item-title">${session.className || 'ì œëª© ì—†ëŠ” ìˆ˜ì—…'}</div>
                <div class="class-item-info">
                    <div class="class-item-meta">
                        <span class="class-item-badge ${session.mode === 'individual' ? 'individual' : 'team'}">
                            ${session.mode === 'individual' ? 'ê°œë³„' : 'ì¡°ë³„'}
                        </span>
                        <span>${session.count || 0}${session.mode === 'individual' ? 'ëª…' : 'ê°œ ì¡°'}</span>
                    </div>
                    <div class="class-item-date">${formatDate(session.date)}</div>
                </div>
                <button class="class-item-delete" onclick="event.stopPropagation(); deleteClassConfirm('${session.classId}', '${session.className || 'ì œëª© ì—†ëŠ” ìˆ˜ì—…'}')">ğŸ—‘ï¸</button>
            `;
            
            div.addEventListener('click', function() {
                // ë‹¤ë¥¸ ì„ íƒ í•´ì œ
                document.querySelectorAll('.class-item').forEach(item => {
                    item.classList.remove('selected');
                });
                
                // í˜„ì¬ í•­ëª© ì„ íƒ
                this.classList.add('selected');
            });
            
            // ë”ë¸”í´ë¦­ì‹œ ë°”ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
            div.addEventListener('dblclick', function() {
                const classId = this.dataset.classId;
                const className = session.className || 'ì œëª© ì—†ëŠ” ìˆ˜ì—…';
                console.log(`ğŸš€ ë”ë¸”í´ë¦­ìœ¼ë¡œ ìˆ˜ì—… ë°”ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°: ${classId} - ${className}`);
                loadSelectedClass(classId, className);
            });
            
            return div;
        }

        // ì„ íƒëœ í´ë˜ìŠ¤ ë°”ë¡œ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadSelectedClass(classId, className) {
            try {
                console.log(`ğŸ“š í´ë˜ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹œì‘: ${classId} - ${className}`);
                
                // í˜„ì¬ ì‘ì—… ì¤‘ì¸ í´ë˜ìŠ¤ ID ì„¤ì •
                currentClassId = classId;
                
                // í—¤ë”ì— í´ë˜ìŠ¤ ì •ë³´ í‘œì‹œ  
                const pageTitle = document.querySelector('.header h1');
                if (pageTitle) {
                    pageTitle.textContent = className;
                }
                
                // íƒ­ ì „í™˜ (ê°œë³„/ì¡°ë³„ ì¤‘ ì ì ˆí•œ íƒ­)
                const result = await window.classProgressFunctions.getActiveSessions();
                const classInfo = result.sessions?.find(s => s.classId === classId);
                
                if (classInfo && classInfo.mode === 'group') {
                    // í´ë˜ìŠ¤ ë°ì´í„° ì €ì¥
                    currentClassData = { mode: 'group', count: classInfo.count || 4 };
                    console.log('ì¡°ë³„ í´ë˜ìŠ¤ ë°ì´í„° ì €ì¥:', currentClassData);
                    switchTab('group');
                    updateGroupView();
                } else {
                    // í´ë˜ìŠ¤ ë°ì´í„° ì €ì¥
                    currentClassData = { mode: 'individual', count: classInfo?.count || 35 };
                    console.log('ê°œë³„ í´ë˜ìŠ¤ ë°ì´í„° ì €ì¥:', currentClassData);
                    switchTab('individual');
                    updateIndividualView();
                }
                
                // ë¯¸ì…˜ ê´€ë¦¬ UI ì´ˆê¸°í™”
                initializeMissionManagement();
                
                // Firebase ì‹¤ì‹œê°„ ì—°ê²° ì‹œì‘
                startFirebaseConnections();
                
                // ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ
                await loadDashboardData();
                
                // ëª¨ë‹¬ ë‹«ê¸°
                closeModal('loadClassModal');
                
                console.log(`âœ… í´ë˜ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì™„ë£Œ: ${className}`);
                
            } catch (error) {
                console.error('í´ë˜ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                alert(`í´ë˜ìŠ¤ ë¶ˆëŸ¬ì˜¤ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`);
            }
        }

        // í´ë˜ìŠ¤ ì‚­ì œ í™•ì¸ í•¨ìˆ˜
        async function deleteClassConfirm(classId, className) {
            const confirmed = confirm(`ì •ë§ë¡œ "${className}" ìˆ˜ì—…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâš ï¸ ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, ë‹¤ìŒ ë°ì´í„°ê°€ ëª¨ë‘ ì‚­ì œë©ë‹ˆë‹¤:\nâ€¢ ìˆ˜ì—… ì •ë³´\nâ€¢ ëª¨ë“  í•™ìƒ ì§„í–‰ìƒí™©\nâ€¢ ë¯¸ì…˜ ë°ì´í„°\nâ€¢ ë©”ì‹œì§€ ë‚´ì—­\nâ€¢ ë„ì›€ ìš”ì²­ ë‚´ì—­`);
            
            if (confirmed) {
                await deleteClassFromFirebase(classId, className);
            }
        }

        // Firebaseì—ì„œ í´ë˜ìŠ¤ ì™„ì „ ì‚­ì œ (ê°œì„ ëœ ë²„ì „)
        async function deleteClassFromFirebase(classId, className) {
            // ì‚­ì œ ì§„í–‰ ìƒíƒœ í‘œì‹œ
            const deleteButton = document.querySelector(`button[onclick*="${classId}"]`);
            if (deleteButton) {
                deleteButton.disabled = true;
                deleteButton.innerHTML = 'â³';
                deleteButton.style.opacity = '0.5';
            }
            
            try {
                console.log(`ğŸ—‘ï¸ í´ë˜ìŠ¤ ì‚­ì œ ì‹œì‘: ${classId} - ${className}`);
                
                // ì‚­ì œ ì§„í–‰ë¥  í‘œì‹œë¥¼ ìœ„í•œ ê°„ë‹¨í•œ ì•Œë¦¼
                const deleteNotification = setTimeout(() => {
                    console.log('â³ ì‚­ì œ ì§„í–‰ ì¤‘... (ëŒ€ëŸ‰ ë°ì´í„°ê°€ ìˆì„ ê²½ìš° ì‹œê°„ì´ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤)');
                }, 2000);
                
                const result = await window.classProgressFunctions.deleteClass(classId);
                
                clearTimeout(deleteNotification);
                
                if (result.success) {
                    const message = result.deletedCount 
                        ? `"${className}" ìˆ˜ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n(${result.deletedCount}ê°œì˜ ê´€ë ¨ ë°ì´í„° ì‚­ì œ)`
                        : `"${className}" ìˆ˜ì—…ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`;
                    
                    alert(message);
                    console.log('âœ… í´ë˜ìŠ¤ ì‚­ì œ ì„±ê³µ:', classId);
                    
                    // í˜„ì¬ í™œì„± í´ë˜ìŠ¤ê°€ ì‚­ì œëœ í´ë˜ìŠ¤ì¸ì§€ í™•ì¸
                    if (currentClassId === classId) {
                        currentClassId = null;
                        console.log('ğŸ”„ í™œì„± í´ë˜ìŠ¤ê°€ ì‚­ì œë¨ - ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”');
                        
                        // í—¤ë” ì œëª© ì´ˆê¸°í™”
                        const pageTitle = document.querySelector('.header h1');
                        if (pageTitle) {
                            pageTitle.textContent = 'í•™ìŠµ ì§„ë„íŒ ê´€ë¦¬ ì‹œìŠ¤í…œ';
                        }
                        
                        // ëŒ€ì‹œë³´ë“œ ì´ˆê¸°í™”
                        updateDashboardView([]);
                    }
                    
                    // ìˆ˜ì—… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                    await loadActiveClasses();
                    
                } else {
                    const errorMessage = `í´ë˜ìŠ¤ ì‚­ì œ ì‹¤íŒ¨: ${result.error}`;
                    if (result.deletedCount > 0) {
                        alert(`${errorMessage}\n\nì¼ë¶€ ë°ì´í„°ëŠ” ì‚­ì œë˜ì—ˆì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. (${result.deletedCount}ê°œ)`);
                    } else {
                        alert(errorMessage);
                    }
                    console.error('âŒ í´ë˜ìŠ¤ ì‚­ì œ ì‹¤íŒ¨:', result.error);
                    
                    // ë²„íŠ¼ ìƒíƒœ ë³µì›
                    if (deleteButton) {
                        deleteButton.disabled = false;
                        deleteButton.innerHTML = 'ğŸ—‘ï¸';
                        deleteButton.style.opacity = '0.7';
                    }
                }
                
            } catch (error) {
                console.error('âŒ í´ë˜ìŠ¤ ì‚­ì œ ì¤‘ ì˜ˆì™¸ ë°œìƒ:', error);
                alert(`í´ë˜ìŠ¤ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ${error.message}`);
                
                // ë²„íŠ¼ ìƒíƒœ ë³µì›
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = 'ğŸ—‘ï¸';
                    deleteButton.style.opacity = '0.7';
                }
            }
        }
        
        async function loadMissionsFromFirebase() {
            if (!currentClassId) {
                console.error('í˜„ì¬ í´ë˜ìŠ¤ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                console.log('Firebaseì—ì„œ ë¯¸ì…˜ ë°ì´í„° ë¡œë“œ ì¤‘...', currentClassId);
                
                const result = await window.classProgressFunctions.getMissions(currentClassId);
                
                if (result.success) {
                    // ì „ì²´ ë¯¸ì…˜ ì—…ë°ì´íŠ¸
                    if (result.data.missions && Array.isArray(result.data.missions)) {
                        console.log('ì „ì²´ ë¯¸ì…˜ ì—…ë°ì´íŠ¸ë¨:', result.data.missions);
                        allMissions.length = 0;
                        allMissions.push(...result.data.missions);
                    }
                    
                    // ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì—…ë°ì´íŠ¸
                    todayMissions.clear();
                    if (result.data.todayMissions && Array.isArray(result.data.todayMissions)) {
                        result.data.todayMissions.forEach(missionId => {
                            todayMissions.add(missionId);
                        });
                    }
                    
                    updateMissionDisplay();
                    console.log('ë¯¸ì…˜ ë°ì´í„° ë¡œë“œ ì™„ë£Œ');
                    
                } else {
                    console.error('ë¯¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', result.error);
                    // ë¹ˆ ë¯¸ì…˜ìœ¼ë¡œ ì´ˆê¸°í™”
                    allMissions.length = 0;
                    todayMissions.clear();
                    updateMissionDisplay();
                }
            } catch (error) {
                console.error('Firebase ë¯¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                throw error; // ìƒìœ„ì—ì„œ ì²˜ë¦¬í•˜ë„ë¡
            }
        }
        
        // Firebase ì‹¤ì‹œê°„ ì—°ê²° í•¨ìˆ˜ë“¤
        function startFirebaseConnections() {
            const classId = getCurrentClassId();
            if (!classId) {
                console.log('í´ë˜ìŠ¤ IDê°€ ì—†ì–´ì„œ ì‹¤ì‹œê°„ ì—°ê²°ì„ ì‹œì‘í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('Firebase ì‹¤ì‹œê°„ ì—°ê²° ì‹œì‘:', classId);
            
            // ì§„í–‰ìƒí™© ì‹¤ì‹œê°„ êµ¬ë…
            const progressUnsubscribe = window.classProgressFunctions.subscribeToProgressUpdates(
                classId, 
                (progressData) => {
                    console.log('ì‹¤ì‹œê°„ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸:', progressData);
                    updateDashboardView(progressData);
                }
            );
            
            // ì‹¤ì‹œê°„ ì•Œë¦¼ êµ¬ë…
            const notificationUnsubscribe = window.classProgressFunctions.subscribeToNotifications(
                classId,
                (notification) => {
                    console.log('ì‹¤ì‹œê°„ ì•Œë¦¼:', notification);
                    handleRealtimeNotification(notification);
                }
            );
            
            // ì •ë¦¬ í•¨ìˆ˜ë“¤ ì €ì¥
            window.firebaseUnsubscribes = {
                progress: progressUnsubscribe,
                notifications: notificationUnsubscribe
            };
        }
        
        function handleRealtimeNotification(notification) {
            switch(notification.type) {
                case 'help-requested':
                    console.log('ë„ì›€ ìš”ì²­ ì•Œë¦¼:', notification.data.studentId);
                    loadDashboardData(); // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                    break;
                case 'progress-updated':
                    console.log('ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸:', notification.data);
                    // ì´ë¯¸ subscribeToProgressUpdatesì—ì„œ ì²˜ë¦¬ë¨
                    break;
                case 'message-sent':
                    console.log('ë©”ì‹œì§€ ì „ì†¡ë¨');
                    break;
            }
        }
        
        async function resolveHelp(studentId) {
            if (!currentClassId) {
                alert('í´ë˜ìŠ¤ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const result = await window.classProgressFunctions.resolveHelpRequest(studentId, currentClassId);
                
                if (result.success) {
                    console.log(`${studentId}ë²ˆ í•™ìƒ ë„ì›€ ìš”ì²­ í•´ê²°ë¨`);
                    loadDashboardData(); // ëŒ€ì‹œë³´ë“œ ìƒˆë¡œê³ ì¹¨
                } else {
                    console.error('ë„ì›€ ìš”ì²­ í•´ê²° ì‹¤íŒ¨:', result.error);
                    alert('ë„ì›€ ìš”ì²­ í•´ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë„ì›€ ìš”ì²­ í•´ê²° ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë„ì›€ ìš”ì²­ í•´ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        
        async function loadDashboardDataFirebase() {
            const classId = getCurrentClassId();
            if (!classId) {
                console.log('í´ë˜ìŠ¤ IDê°€ ì—†ì–´ì„œ ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¡œë“œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            console.log('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì¤‘...', classId);
            
            try {
                const studentsData = await window.classProgressFunctions.getTeacherDashboardData(classId);
                console.log('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì„±ê³µ:', studentsData.length, 'ëª…');
                updateDashboardView(studentsData);
                updateLastRefreshTime();
            } catch (error) {
                console.error('ëŒ€ì‹œë³´ë“œ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                updateDashboardView([]);
            }
        }
        
        // Firebase ë²„ì „ ë©”ì‹œì§€ ì „ì†¡ í•¨ìˆ˜ë¡œ ê¸°ì¡´ í•¨ìˆ˜ ì˜¤ë²„ë¼ì´ë“œ
        window.sendMessage = async function() {
            const message = document.getElementById('messageInput').value.trim();
            if (!message) {
                alert('ë©”ì‹œì§€ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const classId = getCurrentClassId();
            if (!classId) {
                alert('í´ë˜ìŠ¤ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            try {
                const result = await window.classProgressFunctions.sendMessage(classId, 'all', message);
                if (result.success) {
                    alert('ë©”ì‹œì§€ê°€ ëª¨ë“  í•™ìƒì—ê²Œ ì „ì†¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closeModal('messageModal');
                    document.getElementById('messageInput').value = '';
                } else {
                    alert('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨: ' + result.error);
                }
            } catch (error) {
                alert('ë©”ì‹œì§€ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };
        
        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            if (window.firebaseUnsubscribes) {
                if (window.firebaseUnsubscribes.progress) {
                    window.firebaseUnsubscribes.progress();
                }
                if (window.firebaseUnsubscribes.notifications) {
                    window.firebaseUnsubscribes.notifications();
                }
            }
        });
        
        // ë¯¸ì…˜ ìƒì„¸ë‚´ìš© ê´€ë ¨ í•¨ìˆ˜ë“¤
        let currentEditingMissionId = null;
        
        function openMissionDetailModal(missionId) {
            currentEditingMissionId = missionId;
            const mission = allMissions.find(m => m.id === missionId);
            
            if (mission) {
                document.getElementById('missionDetailTitle').value = mission.text;
                document.getElementById('missionDetailContent').value = mission.description || '';
                document.getElementById('missionDetailModal').style.display = 'flex';
            }
        }
        
        function closeMissionDetailModal() {
            document.getElementById('missionDetailModal').style.display = 'none';
            currentEditingMissionId = null;
        }
        
        async function saveMissionDetail() {
            if (!currentEditingMissionId) return;
            
            const description = document.getElementById('missionDetailContent').value.trim();
            
            try {
                // allMissions ë°°ì—´ì—ì„œ í•´ë‹¹ ë¯¸ì…˜ ì°¾ì•„ì„œ description ì¶”ê°€
                const missionIndex = allMissions.findIndex(m => m.id === currentEditingMissionId);
                if (missionIndex !== -1) {
                    allMissions[missionIndex].description = description;
                }
                
                // Firebaseì— ì €ì¥
                const result = await window.classProgressFunctions.saveMissions(currentClassId, allMissions);
                
                if (result.success) {
                    console.log('ë¯¸ì…˜ ìƒì„¸ë‚´ìš© ì €ì¥ ì„±ê³µ');
                    closeMissionDetailModal();
                    updateMissionDisplay();
                } else {
                    console.error('ë¯¸ì…˜ ìƒì„¸ë‚´ìš© ì €ì¥ ì‹¤íŒ¨:', result.error);
                    alert('ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë¯¸ì…˜ ìƒì„¸ë‚´ìš© ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // í•™ìƒ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ ê´€ë¦¬
        let currentViewingStudent = null;
        
        async function openStudentDetailModal(studentId, isGroup = false) {
            currentViewingStudent = { id: studentId, isGroup };
            
            // í•™ìƒ/ì¡° ì •ë³´ í‘œì‹œ
            const studentLabel = isGroup ? `${studentId}ì¡°` : `${studentId}ë²ˆ`;
            document.getElementById('studentDetailLabel').textContent = studentLabel;
            
            // ë©”ì‹œì§€/ë©”ëª¨ ì •ë³´ ë¡œë“œ (í†µí•©)
            await loadStudentMessages(studentId, isGroup);
            
            // ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('studentDetailModal').style.display = 'flex';
        }
        
        function closeStudentDetailModal() {
            document.getElementById('studentDetailModal').style.display = 'none';
            currentViewingStudent = null;
        }
        
        async function loadStudentMessages(studentId, isGroup = false) {
            try {
                // ê¸°ì¡´ ë©”ëª¨ ë°ì´í„°ë¥¼ ë©”ì‹œì§€ë¡œ í™œìš©
                const { collection, query, where, getDocs } = window.firebaseFunctions;
                const studentMemosRef = collection(window.firebaseDb, 'studentMemos');
                
                const messagesQuery = query(
                    studentMemosRef,
                    where('classId', '==', currentClassId),
                    where('studentId', '==', studentId.toString())
                );
                
                const querySnapshot = await getDocs(messagesQuery);
                const messages = [];
                let unreadCount = 0;
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    messages.push({
                        id: doc.id,
                        content: data.content,
                        timestamp: data.timestamp?.toDate() || new Date(),
                        isRead: data.isRead || false,
                        type: data.type || 'question',
                        missionText: data.missionText || 'ì¼ë°˜ ë©”ì‹œì§€'
                    });
                    
                    if (!data.isRead) {
                        unreadCount++;
                    }
                });
                
                // ìµœì‹ ìˆœìœ¼ë¡œ ì •ë ¬
                messages.sort((a, b) => b.timestamp - a.timestamp);
                
                // ë©”ì‹œì§€ ëª©ë¡ í‘œì‹œ
                displayStudentMessages(messages, unreadCount);
                
            } catch (error) {
                console.error('í•™ìƒ ë©”ì‹œì§€ ë¡œë“œ ì‹¤íŒ¨:', error);
                document.getElementById('studentMessagesList').innerHTML = 
                    '<div class="empty-message">ë©”ì‹œì§€ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>';
            }
        }
        
        function displayStudentMessages(messages, unreadCount) {
            const container = document.getElementById('studentMessagesList');
            const countBadge = document.getElementById('unreadMessageCount');
            const markAllBtn = document.getElementById('markAllReadBtn');
            
            // ë¯¸ì½ìŒ ì¹´ìš´íŠ¸ í‘œì‹œ
            if (unreadCount > 0) {
                countBadge.textContent = unreadCount;
                countBadge.style.display = 'inline-flex';
                markAllBtn.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
                markAllBtn.style.display = 'none';
            }
            
            if (messages.length === 0) {
                container.innerHTML = '<div class="empty-message">ë©”ì‹œì§€/ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
                return;
            }
            
            let html = '';
            messages.forEach(message => {
                const readStatus = message.isRead ? 'ì½ìŒ' : 'ë¯¸ì½ìŒ';
                const readClass = message.isRead ? 'read' : 'unread';
                const typeText = message.missionText || 'ë©”ì‹œì§€';
                
                html += `
                    <div class="message-item ${readClass}" data-message-id="${message.id}">
                        <div class="message-header">
                            <span class="message-type">[${typeText}]</span>
                            <span class="message-date">${message.timestamp.toLocaleString('ko-KR')}</span>
                            <span class="message-status ${readClass}">${readStatus}</span>
                        </div>
                        <div class="message-content">${message.content}</div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        async function markMessageAsRead(messageId) {
            try {
                const { doc, updateDoc } = window.firebaseFunctions;
                const messageRef = doc(window.firebaseDb, 'studentMemos', messageId);
                
                await updateDoc(messageRef, {
                    isRead: true,
                    readAt: new Date()
                });
                
                // UI ì—…ë°ì´íŠ¸
                const messageElement = document.querySelector(`[data-message-id="${messageId}"]`);
                if (messageElement) {
                    messageElement.classList.remove('unread');
                    messageElement.classList.add('read');
                    messageElement.querySelector('.message-status').textContent = 'ì½ìŒ';
                    messageElement.querySelector('.message-status').className = 'message-status read';
                }
                
                // ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
                updateUnreadMessageCount();
                
                // í•™ìƒì˜ unreadMemos ì¹´ìš´íŠ¸ ê°ì†Œ
                if (currentViewingStudent) {
                    try {
                        const unreadCount = document.querySelectorAll('.message-item.unread').length;
                        const isGroup = currentViewingStudent.isGroup;
                        const collectionName = isGroup ? 'groups' : 'students';
                        const studentDocRef = doc(window.firebaseDb, 'classData', currentClassId, collectionName, currentViewingStudent.id.toString());
                        
                        await updateDoc(studentDocRef, {
                            unreadMemos: unreadCount
                        });
                    } catch (updateError) {
                        console.log('unreadMemos ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', updateError);
                    }
                }
                
                // UIë§Œ ì—…ë°ì´íŠ¸ (loadDashboardData ì œê±°)
                
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ë©”ì‹œì§€ ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        function updateUnreadMessageCount() {
            const unreadMessages = document.querySelectorAll('.message-item.unread');
            const countBadge = document.getElementById('unreadMessageCount');
            const markAllBtn = document.getElementById('markAllReadBtn');
            const unreadCount = unreadMessages.length;
            
            if (unreadCount > 0) {
                countBadge.textContent = unreadCount;
                countBadge.style.display = 'inline-flex';
                markAllBtn.style.display = 'inline-block';
            } else {
                countBadge.style.display = 'none';
                markAllBtn.style.display = 'none';
            }
        }
        
        async function markAllMessagesAsRead() {
            if (!currentViewingStudent) return;
            
            const unreadMessages = document.querySelectorAll('.message-item.unread');
            const confirmMessage = `ë¯¸ì½ìŒ ë©”ì‹œì§€ ${unreadMessages.length}ê°œë¥¼ ëª¨ë‘ ì½ìŒ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`;
            
            if (!confirm(confirmMessage)) return;
            
            try {
                const { doc, updateDoc } = window.firebaseFunctions;
                const promises = [];
                
                // ëª¨ë“  ë¯¸ì½ìŒ ë©”ì‹œì§€ë¥¼ ì½ìŒìœ¼ë¡œ ì²˜ë¦¬
                unreadMessages.forEach(messageElement => {
                    const messageId = messageElement.getAttribute('data-message-id');
                    const messageRef = doc(window.firebaseDb, 'studentMemos', messageId);
                    
                    promises.push(updateDoc(messageRef, {
                        isRead: true,
                        readAt: new Date()
                    }));
                });
                
                // ëª¨ë“  ì—…ë°ì´íŠ¸ ì‹¤í–‰
                await Promise.all(promises);
                
                // í•™ìƒì˜ unreadMemos ì¹´ìš´íŠ¸ë¥¼ 0ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                try {
                    const isGroup = currentViewingStudent.isGroup;
                    const collectionName = isGroup ? 'groups' : 'students';
                    const studentDocRef = doc(window.firebaseDb, 'classData', currentClassId, collectionName, currentViewingStudent.id.toString());
                    
                    await updateDoc(studentDocRef, {
                        unreadMemos: 0
                    });
                } catch (updateError) {
                    console.log('unreadMemos ì—…ë°ì´íŠ¸ ì‹¤íŒ¨ (ë¬¸ì„œê°€ ì—†ì„ ìˆ˜ ìˆìŒ):', updateError);
                }
                
                // UI ì—…ë°ì´íŠ¸
                unreadMessages.forEach(messageElement => {
                    messageElement.classList.remove('unread');
                    messageElement.classList.add('read');
                    messageElement.querySelector('.message-status').textContent = 'ì½ìŒ';
                    messageElement.querySelector('.message-status').className = 'message-status read';
                });
                
                // ì¹´ìš´íŠ¸ ë° ë²„íŠ¼ ì—…ë°ì´íŠ¸
                updateUnreadMessageCount();
                
                // ì§ì ‘ ë°°ì§€ ì œê±° (ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸)
                const studentCard = document.getElementById(`student-${currentViewingStudent.id}`) || 
                                  document.getElementById(`group-${currentViewingStudent.id}`);
                if (studentCard) {
                    const badge = studentCard.querySelector('.memo-badge');
                    if (badge) {
                        badge.remove();
                    }
                }
                
                alert('ëª¨ë“  ë©”ì‹œì§€ê°€ ì½ìŒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                
            } catch (error) {
                console.error('ì¼ê´„ ì½ìŒ ì²˜ë¦¬ ì‹¤íŒ¨:', error);
                alert('ì¼ê´„ ì½ìŒ ì²˜ë¦¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        async function loadStudentMemos(studentId, isGroup = false) {
            try {
                const { collection, query, where, getDocs } = window.firebaseFunctions;
                const studentMemosRef = collection(window.firebaseDb, 'studentMemos');
                
                const memosQuery = query(
                    studentMemosRef,
                    where('classId', '==', currentClassId),
                    where('studentId', '==', studentId.toString())
                );
                
                const querySnapshot = await getDocs(memosQuery);
                const memos = [];
                
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    memos.push({
                        id: doc.id,
                        missionId: data.missionId,
                        missionText: data.missionText || 'ë¯¸ì…˜ ì œëª© ì—†ìŒ',
                        content: data.content,
                        timestamp: data.timestamp?.toDate() || new Date()
                    });
                });
                
                // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œì—ì„œ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
                memos.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime());
                
                displayStudentMemos(memos);
                
                // ì½ì§€ ì•Šì€ ë©”ëª¨ ìˆ˜ ì´ˆê¸°í™”
                if (memos.length > 0) {
                    await resetUnreadMemos(studentId, isGroup);
                }
                
            } catch (error) {
                console.error('í•™ìƒ ë©”ëª¨ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('studentMemosList').innerHTML = '<p>ë©”ëª¨ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
            }
        }
        
        function displayStudentMemos(memos) {
            const container = document.getElementById('studentMemosList');
            
            if (memos.length === 0) {
                container.innerHTML = '<p>ì‘ì„±ëœ ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            const memosHtml = memos.map(memo => {
                const dateStr = memo.timestamp.toLocaleDateString('ko-KR', {
                    month: 'short',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                return `
                    <div class="memo-item">
                        <div class="memo-header">
                            <span class="memo-mission">${memo.missionText}</span>
                            <span class="memo-date">${dateStr}</span>
                        </div>
                        <div class="memo-content">${memo.content}</div>
                    </div>
                `;
            }).join('');
            
            container.innerHTML = memosHtml;
        }
        
        async function resetUnreadMemos(studentId, isGroup = false) {
            try {
                const { doc, updateDoc } = window.firebaseFunctions;
                const dataType = isGroup ? 'groups' : 'students';
                const docRef = doc(window.firebaseDb, 'classData', currentClassId, dataType, studentId.toString());
                
                await updateDoc(docRef, {
                    unreadMemos: 0
                });
                
                // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
                loadDashboardData();
                
            } catch (error) {
                console.error('ì½ì§€ ì•Šì€ ë©”ëª¨ ìˆ˜ ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
        }
    </script>

    <!-- ë¯¸ì…˜ ìƒì„¸ë‚´ìš© ì…ë ¥ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="missionDetailModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">ë¯¸ì…˜ ìƒì„¸ ë‚´ìš©</h3>
                <button class="close-btn" onclick="closeMissionDetailModal()">&times;</button>
            </div>
            
            <div class="modal-step">
                <div class="form-group">
                    <label class="form-label">ë¯¸ì…˜ ì œëª©</label>
                    <input type="text" class="form-input" id="missionDetailTitle" readonly>
                </div>
                
                <div class="form-group">
                    <label class="form-label">ìƒì„¸ ì„¤ëª…</label>
                    <textarea class="form-input" id="missionDetailContent" 
                              placeholder="í•™ìƒë“¤ì´ ë³¼ ìˆ˜ ìˆëŠ” ìì„¸í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”...&#10;ì˜ˆ: êµê³¼ì„œ 15~18í˜ì´ì§€ì˜ 1~5ë²ˆ ë¬¸ì œë¥¼ í’€ê³ , í’€ì´ê³¼ì •ì„ ë…¸íŠ¸ì— ìì„¸íˆ ì ì–´ì£¼ì„¸ìš”."
                              rows="6"></textarea>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-secondary" onclick="closeMissionDetailModal()">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="saveMissionDetail()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <!-- í•™ìƒ ìƒì„¸ ì •ë³´ ëª¨ë‹¬ -->
    <div class="modal-overlay" id="studentDetailModal" style="display: none;">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">í•™ìƒ ìƒì„¸ ì •ë³´</h3>
                <button class="close-btn" onclick="closeStudentDetailModal()">&times;</button>
            </div>
            
            <div class="modal-step">
                <div class="form-group">
                    <label class="form-label" id="studentDetailLabel">í•™ìƒ ì •ë³´</label>
                </div>
                
                <div class="form-group">
                    <label class="form-label">í•™ìƒ ë©”ì‹œì§€/ë©”ëª¨ <span id="unreadMessageCount" class="memo-badge" style="position: relative; top: -2px; margin-left: 8px; display: none;">0</span></label>
                    <div id="studentMessagesList" class="memos-container">
                        <p>ë¡œë”© ì¤‘...</p>
                    </div>
                </div>
            </div>
            
            <div class="modal-buttons">
                <button class="btn btn-primary" id="markAllReadBtn" onclick="markAllMessagesAsRead()" style="display: none;">ì½ìŒ</button>
                <button class="btn btn-secondary" onclick="closeStudentDetailModal()">ë‹«ê¸°</button>
            </div>
        </div>
    </div>
</body>
</html>