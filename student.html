
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë‚˜ì˜ í•™ìŠµ ì§„ë„</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #e0f7fa, #c5e1e5);
            color: #37474f;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
        }

        .page-header {
            width: 100%;
            background-color: white;
            color: #333;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: baseline;
            gap: 15px;
        }

        .page-header h1 {
            margin: 0 0 4px 0;
            font-size: 20px;
            color: #333;
            font-weight: 700;
        }
        
        .header-functions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-info {
            font-size: 18px;
            font-weight: 500;
            color: #374151;
            background: rgba(59, 130, 246, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        /* í•™ìŠµ ë‚´ìš© íŒ¨ë„ ìŠ¤íƒ€ì¼ */
        .panel-content {
            display: flex;
            flex-direction: column;
        }
        
        .mission-detail-section {
            flex: 1;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eceff1;
        }
        
        .mission-detail-section h3 {
            color: #00acc1;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .mission-detail-content {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00acc1;
            min-height: 80px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .mission-memo-section {
            flex: 1;
        }
        
        .mission-memo-section h3 {
            color: #00acc1;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .mission-memo-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #eceff1;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .mission-memo-section textarea:focus {
            outline: none;
            border-color: #00acc1;
        }
        
        .save-memo-btn {
            background-color: #00acc1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .save-memo-btn:hover:not(:disabled) {
            background-color: #00838f;
        }
        
        .save-memo-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* ë³¸ë¬¸ ì˜ì—­ ì „ì²´ë¥¼ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ */
        .content-wrapper {
            width: 100%;
            max-width: 1600px; /* ìµœëŒ€ ë„ˆë¹„ëŠ” ìœ ì§€ */
            padding: 30px; /* ì¢Œìš° ì—¬ë°± ë‹¤ì‹œ ì¶”ê°€ */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .main-container {
            width: 100%;
            display: none;
            gap: 25px;
            flex-grow: 1;
            /* ê¸°ì¡´ main-containerì˜ paddingì„ content-wrapperë¡œ ì´ë™ */
        }
        
        .panel {
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            flex: 1;
            overflow-y: auto;
            padding: 40px;
        }
        
        .panel-overall {
            flex: 0 0 300px;
            min-width: 300px;
        }

        .panel-today {
            flex: 0 0 400px;
            min-width: 400px;
        }

        .panel-functions {
            flex: 1;
            min-width: 400px;
        }

        .header {
            margin-bottom: 35px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #00acc1;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            color: #607d8b;
        }

        .progress-wrapper {
            margin-bottom: 30px;
            text-align: center;
        }

        .progress-text {
            font-size: 18px;
            font-weight: 500;
            color: #00acc1;
            margin-bottom: 12px;
        }

        .progress-container {
            width: 100%;
            height: 12px;
            background-color: #eceff1;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00acc1 0%, #00838f 100%);
            border-radius: 6px;
            transition: width 0.4s ease-in-out;
            width: 0%;
        }

        .mission-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        .mission-item {
            padding: 18px;
            background-color: #f0f4f4;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .mission-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #b2ebf2;
        }

        .mission-item.completed {
            background-color: #e0f2f1;
            border-color: #80cbc4;
        }

        .mission-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #b0bec5;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 20px;
            flex-shrink: 0;
            transition: all 0.2s ease;
            font-size: 18px;
            color: transparent;
        }

        .mission-item.completed .mission-checkbox {
            background-color: #00acc1;
            border-color: #00acc1;
            color: white;
        }

        .mission-text {
            flex-grow: 1;
            font-size: 17px;
            font-weight: 500;
            color: #455a64;
            line-height: 1.5;
        }
        
        .all-mission-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eceff1;
            display: flex;
            align-items: center;
            font-size: 13.5px;
            color: #607d8b;
        }
        
        .all-mission-item:last-child {
            border-bottom: none;
        }
        
        .all-mission-item .step-number {
            font-weight: 700;
            color: #78909c;
            margin-right: 10px;
            width: 25px;
            flex-shrink: 0;
        }
        
        .all-mission-item.current {
            background-color: #fffde7;
            border-radius: 8px;
        }
        
        .all-mission-item.current .step-number {
            color: #ffb300;
        }
        
        .function-button {
            width: 100%;
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 10px;
        }

        .help-button {
            background-color: #ef4444;
        }

        .help-button:hover {
            background-color: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }
        
        .message-inbox-button {
            background-color: #2196f3;
            width: 100%;
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 10px;
            white-space: nowrap;
            position: relative;
        }
        
        .message-inbox-button:hover {
            background-color: #1976d2;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            transform: translateY(-2px);
        }
        
        .message-inbox-button.new-message {
            position: relative;
        }
        
        .message-inbox-button.new-message::after {
            content: attr(data-unread-count);
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            z-index: 10;
        }
        
        .message-inbox-button.new-message[data-unread-count="0"]::after {
            display: none;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .modal h2 {
            font-size: 22px;
            margin-bottom: 15px;
            color: #37474f;
        }
        
        .modal input {
            width: 250px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #cfd8dc;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .modal button {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            color: white;
            background-color: #00acc1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .modal button:hover {
            background-color: #00838f;
        }

        .message-modal-content {
            width: 90%;
            max-width: 500px;
            max-height: 60vh;
            overflow-y: auto;
            text-align: left;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .message-modal-content ul {
            list-style: none;
            padding: 0;
        }
        
        .message-modal-content li {
            background: linear-gradient(145deg, #f8fafc, #ffffff);
            border: 1px solid #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            line-height: 1.5;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .message-modal-content li:hover {
            background: linear-gradient(145deg, #f1f5f9, #f8fafc);
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .message-modal-content li.unread {
            background: linear-gradient(145deg, #eff6ff, #dbeafe);
            border-color: #3b82f6;
            font-weight: 500;
        }
        
        .message-modal-content .timestamp {
            display: block;
            font-size: 11px;
            color: #6b7280;
            margin-top: 8px;
            font-weight: normal;
        }
        
        .message-modal-content .message-text {
            color: #374151;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .close-button {
            margin-top: 20px;
            padding: 8px 16px;
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-button:hover {
            background-color: #374151;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        @media (max-width: 600px) {
            .main-container {
                flex-direction: column;
                padding: 15px;
            }

            .panel {
                padding: 20px;
            }
            
            .page-header {
                padding: 15px 20px;
            }

            .header-left {
                gap: 10px;
            }

            .page-header h1 {
                font-size: 20px;
            }
            
            .user-info {
                font-size: 16px;
                padding: 2px 8px;
            }

            .header-functions {
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="modal-overlay" id="studentIdModal">
        <div class="modal">
            <h2>í•™ìŠµ ì‹œì‘</h2>
            <p id="modalDescription" style="margin-bottom: 15px;">ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            <select id="studentIdInput" style="width: 250px; padding: 12px; font-size: 16px; border: 1px solid #cfd8dc; border-radius: 8px; margin-bottom: 15px;">
                <option value="">ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
                <option value="23">23</option>
                <option value="24">24</option>
                <option value="25">25</option>
                <option value="26">26</option>
                <option value="27">27</option>
                <option value="28">28</option>
                <option value="29">29</option>
                <option value="30">30</option>
                <option value="31">31</option>
                <option value="32">32</option>
                <option value="33">33</option>
                <option value="34">34</option>
                <option value="35">35</option>
            </select>
            <button onclick="startMission()">ì‹œì‘í•˜ê¸°</button>
        </div>
    </div>

    <div class="modal-overlay" id="messageModal" style="display: none;">
        <div class="modal">
            <h2>ì„ ìƒë‹˜ ë©”ì‹œì§€</h2>
            <div class="message-modal-content">
                <ul id="messageList"></ul>
            </div>
            <button class="close-button" onclick="closeMessageModal()">ë‹«ê¸°</button>
        </div>
    </div>
    
    <div class="page-header" id="pageHeader" style="display: none;">
        <div class="header-left">
            <h1 id="pageTitle">ë‚˜ì˜ í•™ìŠµ ì§„ë„</h1>
            <div class="user-info" id="userInfo"></div>
        </div>
        <div class="header-functions">
            <button class="function-button help-button" id="helpButton" onclick="sendHelpRequest()">ë„ì™€ì£¼ì„¸ìš”!</button>
            <button class="function-button help-cancel-button" id="helpCancelButton" onclick="cancelHelpRequest()" style="display: none; background-color: #6b7280;">ë„ì›€ ì·¨ì†Œ</button>
            <button class="message-inbox-button" id="messageButton" onclick="showMessageModal()">ì„ ìƒë‹˜ ë©”ì‹œì§€ ë³´ê¸°</button>
        </div>
    </div>
    
    <div class="content-wrapper">
        <div class="main-container" id="mainContainer">
            <div class="panel panel-overall">
                <div class="header">
                    <h1>ì „ì²´ ë¯¸ì…˜ ë‹¨ê³„</h1>
                </div>
                <div id="allMissionList">
                    </div>
            </div>

            <div class="panel panel-today">
                <div class="header">
                    <h1>ì˜¤ëŠ˜ì˜ í•™ìŠµ ë¯¸ì…˜</h1>
                    <p>ë¯¸ì…˜ì„ ì™„ë£Œí•˜ê³  ì§„í–‰ ìƒí™©ì„ ì„ ìƒë‹˜ê»˜ ì•Œë ¤ì£¼ì„¸ìš”!</p>
                </div>
                <div class="progress-wrapper">
                    <div class="progress-text"><span id="completed-count">0</span> / <span id="total-count">0</span>ê°œ ì™„ë£Œ</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
                <ul class="mission-list" id="missionList">
                    </ul>
            </div>

            <div class="panel panel-content">
                <div class="header">
                    <h1>í•™ìŠµ ë‚´ìš©</h1>
                    <p>ë¯¸ì…˜ì„ í´ë¦­í•˜ë©´ ìƒì„¸ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</p>
                </div>
                
                <!-- ìƒë‹¨: ë¯¸ì…˜ ìƒì„¸ë‚´ìš© -->
                <div class="mission-detail-section">
                    <h3>ë¯¸ì…˜ ìƒì„¸ ì„¤ëª…</h3>
                    <div id="missionDetailDisplay" class="mission-detail-content">
                        <p>ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ì—ì„œ ë¯¸ì…˜ì„ í´ë¦­í•˜ë©´ ì—¬ê¸°ì— ìì„¸í•œ ì„¤ëª…ì´ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
                    </div>
                </div>
                
                <!-- í•˜ë‹¨: í•™ìƒ ë©”ëª¨ -->
                <div class="mission-memo-section">
                    <h3>ë‚˜ì˜ ë©”ëª¨</h3>
                    <textarea id="missionMemoInput" 
                              placeholder="ì´ ë¯¸ì…˜ì„ ì–´ë–»ê²Œ ìˆ˜í–‰í–ˆëŠ”ì§€ ê°„ë‹¨íˆ ì ì–´ì£¼ì„¸ìš”..."
                              rows="4"></textarea>
                    <button id="saveMemoButton" class="save-memo-btn" onclick="saveMissionMemo()" disabled>ë©”ëª¨ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase ì„¤ì • -->
    <script type="module">
        // Firebase ì„¤ì •ê³¼ í•¨ìˆ˜ë“¤ì„ ì§ì ‘ í¬í•¨
        
        // Firebase import
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
        import { 
          getFirestore, 
          collection, 
          doc, 
          addDoc, 
          getDoc, 
          getDocs, 
          updateDoc, 
          setDoc,
          deleteDoc,
          query, 
          where, 
          orderBy,
          onSnapshot,
          serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

        import { 
          getDatabase, 
          ref, 
          set, 
          get, 
          push, 
          onValue, 
          off 
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
          apiKey: "AIzaSyBV1IFHlWjQ6ftVmnhX74YITKWCdsjdZLM",
          authDomain: "classroom-progress.firebaseapp.com",
          databaseURL: "https://classroom-progress-default-rtdb.asia-southeast1.firebasedatabase.app/",
          projectId: "classroom-progress",
          storageBucket: "classroom-progress.firebasestorage.app",
          messagingSenderId: "307617869427",
          appId: "1:307617869427:web:20a35dc705cc3fc3854406"
        };

        // Firebase ì•± ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const realtimeDb = getDatabase(app);

        // ì „ì—­ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.realtimeDb = realtimeDb;

        // Firebase í•¨ìˆ˜ë“¤ì„ ì „ì—­ìœ¼ë¡œ ë‚´ë³´ë‚´ê¸°
        window.firebaseFunctions = {
          collection, doc, addDoc, getDoc, getDocs, updateDoc, setDoc, deleteDoc,
          query, where, orderBy, onSnapshot, serverTimestamp,
          ref, set: set, get: get, push, onValue, off
        };

        // Firebase í•¨ìˆ˜ë“¤ ì •ì˜ (í•™ìƒìš© í•„ìˆ˜ í•¨ìˆ˜ë“¤ë§Œ)
        
        // í•™ìƒ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getStudentData(studentId, classId) {
          try {
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            let studentData = { missions: [], messages: [] };
            
            if (!progressSnapshot.empty) {
              const data = progressSnapshot.docs[0].data();
              studentData.missions = data.missions || [];
            }
            
            const messagesQuery = query(
              collection(db, 'messages'),
              where('classId', '==', classId),
              where('recipient', 'in', [studentId, 'all'])
            );
            
            const messagesSnapshot = await getDocs(messagesQuery);
            const messages = [];
            
            messagesSnapshot.forEach(doc => {
              const data = doc.data();
              messages.push({
                text: data.message,
                timestamp: formatTimestamp(data.timestamp),
                rawTimestamp: data.timestamp
              });
            });
            
            messages.sort((a, b) => {
              const aTime = a.rawTimestamp?.toDate ? a.rawTimestamp.toDate() : new Date(a.rawTimestamp);
              const bTime = b.rawTimestamp?.toDate ? b.rawTimestamp.toDate() : new Date(b.rawTimestamp);
              return bTime - aTime;
            });
            
            studentData.messages = messages;
            
            return {
              success: true,
              data: studentData
            };
          } catch (error) {
            console.error('í•™ìƒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            return {
              success: false,
              data: { missions: [], messages: [] }
            };
          }
        }

        // í•™ìƒ ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸
        async function updateStudentProgress(studentId, classId, missionData, helpNeeded = null) {
          try {
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            
            const completedMissions = missionData.filter(m => m.completed).length;
            const totalMissions = missionData.length;
            const progress = totalMissions > 0 ? Math.round((completedMissions / totalMissions) * 100) : 0;
            
            const progressData = {
              classId: classId,
              studentId: studentId,
              missions: missionData,
              progress: progress,
              lastUpdate: serverTimestamp(),
              helpNeeded: helpNeeded !== null ? (helpNeeded ? 'YES' : 'NO') : 'NO',
              hasNewMessage: 'NO'
            };
            
            if (progressSnapshot.empty) {
              await setDoc(doc(collection(db, 'studentProgress')), progressData);
            } else {
              const docRef = progressSnapshot.docs[0].ref;
              await setDoc(docRef, progressData, { merge: true });
            }
            
            await sendRealtimeNotification(classId, 'progress-updated', { studentId, progress });
            
            return { success: true, progress: progress };
          } catch (error) {
            console.error('ì§„í–‰ìƒí™© ì—…ë°ì´íŠ¸ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // ë¯¸ì…˜ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function getMissions(classId) {
          try {
            const classQuery = query(
              collection(db, 'classes'),
              where('classId', '==', classId)
            );
            
            const classSnapshot = await getDocs(classQuery);
            
            if (!classSnapshot.empty) {
              const data = classSnapshot.docs[0].data();
              
              const missions = [];
              if (data.missions) {
                Object.keys(data.missions).forEach(id => {
                  const missionData = data.missions[id];
                  missions.push({
                    id: parseInt(id),
                    text: typeof missionData === 'string' ? missionData : missionData.text,
                    description: typeof missionData === 'string' ? '' : (missionData.description || '')
                  });
                });
              }
              
              missions.sort((a, b) => a.id - b.id);
              
              return {
                success: true,
                data: {
                  missions: missions,
                  todayMissions: data.todayMissions || [],
                  mode: data.mode || 'individual',
                  count: data.count || 35
                }
              };
            }
            
            return {
              success: true,
              data: { missions: [], todayMissions: [], mode: 'individual', count: 35 }
            };
          } catch (error) {
            console.error('ë¯¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
            return {
              success: false,
              data: { missions: [], todayMissions: [], mode: 'individual', count: 35 }
            };
          }
        }

        // ë„ì›€ ìš”ì²­ ì „ì†¡
        async function sendHelpRequest(studentId, classId) {
          try {
            await addDoc(collection(db, 'helpRequests'), {
              classId: classId,
              studentId: studentId,
              timestamp: serverTimestamp(),
              status: 'pending'
            });
            
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            if (!progressSnapshot.empty) {
              const docRef = progressSnapshot.docs[0].ref;
              await setDoc(docRef, {
                helpNeeded: 'YES'
              }, { merge: true });
            }
            
            await sendRealtimeNotification(classId, 'help-requested', { studentId });
            
            return { success: true };
          } catch (error) {
            console.error('ë„ì›€ ìš”ì²­ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // í•™ìƒ ë¯¸ì…˜ ë©”ëª¨ ì €ì¥
        async function saveMissionMemo(studentId, classId, missionId, memoContent) {
          try {
            const classQuery = query(
              collection(db, 'classes'),
              where('classId', '==', classId)
            );
            
            const classSnapshot = await getDocs(classQuery);
            let missionText = 'ë¯¸ì…˜ ì œëª© ì—†ìŒ';
            
            if (!classSnapshot.empty) {
              const classData = classSnapshot.docs[0].data();
              if (classData.missions && classData.missions[missionId]) {
                const missionData = classData.missions[missionId];
                missionText = typeof missionData === 'string' ? missionData : missionData.text;
              }
            }
            
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            
            if (progressSnapshot.empty) {
              return { success: false, error: 'í•™ìƒ ì§„í–‰ìƒí™©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.' };
            }
            
            const docRef = progressSnapshot.docs[0].ref;
            const existingData = progressSnapshot.docs[0].data();
            
            let memos = existingData.memos || [];
            
            const existingMemoIndex = memos.findIndex(m => m.missionId === missionId);
            
            const memoData = {
              missionId: missionId,
              missionText: missionText,
              content: memoContent,
              lastUpdate: new Date()
            };
            
            if (existingMemoIndex >= 0) {
              memos[existingMemoIndex] = memoData;
            } else {
              memos.push(memoData);
            }
            
            await updateDoc(docRef, {
              memos: memos,
              unreadMemos: (existingData.unreadMemos || 0) + 1,
              lastUpdate: new Date()
            });
            
            await addDoc(collection(db, 'studentMemos'), {
              classId: classId,
              studentId: studentId,
              missionId: missionId,
              missionText: missionText,
              content: memoContent,
              timestamp: new Date()
            });
            
            return { success: true };
            
          } catch (error) {
            console.error('ë¯¸ì…˜ ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜:', error);
            return { success: false, error: error.message };
          }
        }

        // ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡
        async function sendRealtimeNotification(classId, type, data = {}) {
          try {
            await addDoc(collection(db, 'notifications'), {
              classId: classId,
              type: type,
              timestamp: serverTimestamp(),
              timestampMs: Date.now(),
              data: data
            });
            
            console.log('ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡:', type, data);
          } catch (error) {
            console.error('ì‹¤ì‹œê°„ ì•Œë¦¼ ì „ì†¡ ì˜¤ë¥˜:', error);
          }
        }

        // ì‹¤ì‹œê°„ ì•Œë¦¼ êµ¬ë…
        function subscribeToNotifications(classId, callback) {
          const notificationsQuery = query(
            collection(db, 'notifications'),
            where('classId', '==', classId)
          );
          
          const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
          
          return onSnapshot(notificationsQuery, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
              if (change.type === 'added') {
                const data = change.doc.data();
                
                if (data.timestampMs > fiveMinutesAgo) {
                  callback({
                    type: data.type,
                    timestamp: data.timestampMs,
                    data: data.data
                  });
                }
              }
            });
          });
        }

        // íƒ€ì„ìŠ¤íƒ¬í”„ í¬ë§· í•¨ìˆ˜
        function formatTimestamp(timestamp) {
          if (!timestamp) return '';
          
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // ì „ì—­ìœ¼ë¡œ í•¨ìˆ˜ë“¤ ë‚´ë³´ë‚´ê¸° (í•™ìƒìš© í•„ìˆ˜ í•¨ìˆ˜ë“¤ë§Œ)
        window.classProgressFunctions = {
          getStudentData,
          updateStudentProgress,
          getMissions,
          sendHelpRequest,
          saveMissionMemo,
          subscribeToNotifications
        };

        console.log('âœ… Firebase ì´ˆê¸°í™” ì™„ë£Œ (Student)');
        console.log('ğŸ“‹ ì‚¬ìš© ê°€ëŠ¥í•œ í•¨ìˆ˜ë“¤:', Object.keys(window.classProgressFunctions));
        
        console.log('Student.html Firebase ëª¨ë“ˆë“¤ ë¡œë“œ ì™„ë£Œ');
        
        // í•¨ìˆ˜ë“¤ì´ ì œëŒ€ë¡œ ë¡œë“œë˜ì—ˆëŠ”ì§€ í™•ì¸
        window.addEventListener('load', () => {
            console.log('Student Firebase ì¤€ë¹„ ìƒíƒœ:', {
                firebaseDb: window.firebaseDb,
                realtimeDb: window.realtimeDb,
                functions: window.classProgressFunctions
            });
        });
    </script>

    <script>
        // Firebaseë¡œ ì™„ì „ ì „í™˜ - Apps Script URL ì œê±°
        let studentId = null; 
        let currentClassId = null; // í´ë˜ìŠ¤ IDë¡œ ë³€ê²½
        const pageHeader = document.getElementById('pageHeader');
        const userInfo = document.getElementById('userInfo');
        
        // URLì—ì„œ í´ë˜ìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
        function getClassIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('classId');
        }
        const contentWrapper = document.getElementById('content-wrapper');
        const mainContainer = document.getElementById('mainContainer');
        const studentIdModal = document.getElementById('studentIdModal');
        const studentIdInput = document.getElementById('studentIdInput');
        const messageModal = document.getElementById('messageModal');

        let allMissions = [
            { id: 1, text: "ë‹¨ì› ì†Œê°œ ì˜ìƒ ì‹œì²­í•˜ê¸°" },
            { id: 2, text: "í…ìŠ¤íŠ¸ ì½ê³  í•µì‹¬ ë‚´ìš© ìš”ì•½í•˜ê¸°" },
            { id: 3, text: "êµê³¼ì„œ ë¬¸ì œ í’€ê¸° (1~5ë²ˆ)" },
            { id: 4, text: "ì¡°ë³„ í† ë¡  ì¤€ë¹„í•˜ê¸°" },
            { id: 5, text: "í† ë¡  ê²°ê³¼ ë°œí‘œí•˜ê¸°" },
            { id: 6, text: "ì‹¬í™” í•™ìŠµ ê³¼ì œ ì œì¶œí•˜ê¸°" },
            { id: 7, text: "ë‹¨ì› í‰ê°€ ë¬¸ì œ í’€ê¸°" },
            { id: 8, text: "ì˜¤ë‹µ ë…¸íŠ¸ ì •ë¦¬í•˜ê¸°" },
            { id: 9, text: "ì¹œêµ¬ì—ê²Œ í•™ìŠµ ë‚´ìš© ì„¤ëª…í•˜ê¸°" },
            { id: 10, text: "ë‹¨ì› ë§ˆë¬´ë¦¬ ë°œí‘œ ì¤€ë¹„í•˜ê¸°" }
        ];

        let todaysMissions = [
            { id: 3, text: "êµê³¼ì„œ ë¬¸ì œ í’€ê¸° (1~5ë²ˆ)", completed: false },
            { id: 4, text: "ì¡°ë³„ í† ë¡  ì¤€ë¹„í•˜ê¸°", completed: false },
            { id: 5, text: "í† ë¡  ê²°ê³¼ ë°œí‘œí•˜ê¸°", completed: false }
        ];

        let receivedMessages = [
            { text: "ê¹€ì² ìˆ˜ í•™ìƒ, ë¯¸ì…˜ 3ë²ˆ ì™„ë£Œë¥¼ ì¶•í•˜í•´ìš”! ë‹¤ìŒ ë¯¸ì…˜ë„ í˜ë‚´ì„¸ìš”!", timestamp: "2024-05-23 14:30" },
            { text: "ì˜¤ëŠ˜ì˜ í•™ìŠµ íƒœë„ê°€ ë§¤ìš° í›Œë¥­í•©ë‹ˆë‹¤. ì´ëŒ€ë¡œ ì­‰ ì§„í–‰í•˜ì„¸ìš”!", timestamp: "2024-05-23 11:15" },
        ];
        
        let lastMessageCount = 0;
        let unreadMessageCount = 0;
        let classMode = 'individual'; // 'individual' ë˜ëŠ” 'group'


        const missionListEl = document.getElementById('missionList');
        const allMissionListEl = document.getElementById('allMissionList');
        const completedCountEl = document.getElementById('completed-count');
        const totalCountEl = document.getElementById('total-count');
        const progressBarEl = document.getElementById('progressBar');
        const messageListEl = document.getElementById('messageList');

        let isVisible = true;
        let autoRefreshInterval = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // ë¨¼ì € í´ë˜ìŠ¤ ëª¨ë“œë¥¼ ë¡œë“œí•´ì„œ ëª¨ë‹¬ì„ ì„¤ì •
            currentClassId = getClassIdFromUrl();
            if (currentClassId) {
                await loadClassMode();
                // ëª¨ë“œ ë¡œë”© í›„ ëª¨ë‹¬ ì—…ë°ì´íŠ¸ í™•ì¸
                console.log('ëª¨ë‹¬ ì—…ë°ì´íŠ¸ í›„ classMode:', classMode);
                updateModalForMode();
            }
            
            studentIdModal.style.display = 'flex';
            
            studentIdInput.addEventListener('change', (event) => {
                // ë“œë¡­ë‹¤ìš´ ì„ íƒ ì‹œ ìë™ìœ¼ë¡œ ì‹œì‘í•˜ì§€ ì•Šê³ , ë²„íŠ¼ í´ë¦­ ëŒ€ê¸°
            });
            
            studentIdInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    startMission();
                }
            });

            // íƒ­ ê°€ì‹œì„± ë³€ê²½ ê°ì§€
            document.addEventListener('visibilitychange', function() {
                isVisible = !document.hidden;
                if (isVisible && studentId) {
                    console.log('íƒ­ í™œì„±í™” - ì¦‰ì‹œ ìƒˆë¡œê³ ì¹¨');
                    refreshStudentData();
                }
            });
        });

        async function loadStudentData() {
            try {
                // URLì—ì„œ í´ë˜ìŠ¤ ID ê°€ì ¸ì˜¤ê¸°
                currentClassId = getClassIdFromUrl();
                console.log('ì‚¬ìš©í•  í´ë˜ìŠ¤ ID:', currentClassId);
                
                if (!currentClassId) {
                    console.error('í´ë˜ìŠ¤ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }
                
                // Firebaseì—ì„œ í´ë˜ìŠ¤ ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ ëª¨ë“œ í™•ì¸
                await loadClassMode();
                
                // Firebaseì—ì„œ ë¯¸ì…˜ ë°ì´í„°ë¥¼ ë¨¼ì € ê°€ì ¸ì˜¤ê¸°
                await loadMissionsFromFirebase();
                
                // í•™ìƒ ì§„í–‰ìƒí™© ë°ì´í„° ë¡œë“œ
                await loadStudentProgressData();
                
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                // ê¸°ë³¸ ë°ì´í„°ë¡œ ë Œë”ë§
                renderTodaysMissions();
                renderAllMissions();
                updateProgress();
            }
        }

        let groupCount = 8; // ê¸°ë³¸ ì¡° ê°œìˆ˜
        let individualCount = 35; // ê¸°ë³¸ í•™ìƒ ìˆ˜
        
        async function loadClassMode() {
            try {
                console.log('Firebaseì—ì„œ í´ë˜ìŠ¤ ëª¨ë“œ ë¡œë“œ ì¤‘...');
                
                const result = await window.classProgressFunctions.getMissions(currentClassId);
                
                if (result.success && result.data.mode) {
                    classMode = result.data.mode;
                    console.log('í´ë˜ìŠ¤ ëª¨ë“œ ë¡œë“œë¨:', classMode);
                    
                    // ëª¨ë“œë³„ ê°œìˆ˜ ê°€ì ¸ì˜¤ê¸°
                    if (result.data.count) {
                        if (classMode === 'group') {
                            groupCount = parseInt(result.data.count);
                            console.log('ì¡° ê°œìˆ˜ ë¡œë“œë¨:', groupCount);
                        } else {
                            individualCount = parseInt(result.data.count);
                            console.log('í•™ìƒ ìˆ˜ ë¡œë“œë¨:', individualCount);
                        }
                    }
                    
                    // ëª¨ë“œì— ë”°ë¼ ëª¨ë‹¬ ì—…ë°ì´íŠ¸
                    updateModalForMode();
                } else {
                    console.log('í´ë˜ìŠ¤ ëª¨ë“œ ì •ë³´ ì—†ìŒ, ê¸°ë³¸ê°’ ì‚¬ìš© (individual)');
                }
            } catch (error) {
                console.error('Firebase í´ë˜ìŠ¤ ëª¨ë“œ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        function updateModalForMode() {
            const modalDescription = document.getElementById('modalDescription');
            const studentIdInput = document.getElementById('studentIdInput');
            
            console.log('updateModalForMode ì‹¤í–‰, classMode:', classMode);
            
            if (classMode === 'group') {
                // ì¡°ë³„ ëª¨ë“œë¡œ ëª¨ë‹¬ ì—…ë°ì´íŠ¸
                modalDescription.textContent = 'ì¡°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                
                // ì„¤ì •ëœ ì¡° ê°œìˆ˜ë§Œí¼ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë™ì  ìƒì„±
                let groupOptions = '<option value="">ì¡°ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                for(let i = 1; i <= groupCount; i++) {
                    groupOptions += `<option value="${i}">${i}ì¡°</option>`;
                }
                studentIdInput.innerHTML = groupOptions;
                console.log(`ì¡°ë³„ ëª¨ë“œë¡œ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì™„ë£Œ (${groupCount}ê°œ ì¡°)`);
            } else {
                // ê°œë³„ ëª¨ë“œ (ê¸°ë³¸ê°’)
                modalDescription.textContent = 'ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.';
                
                // ê°œë³„ ëª¨ë“œ ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ë™ì  ìƒì„±
                let individualOptions = '<option value="">ë²ˆí˜¸ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
                for(let i = 1; i <= individualCount; i++) {
                    individualOptions += `<option value="${i}">${i}</option>`;
                }
                studentIdInput.innerHTML = individualOptions;
                console.log(`ê°œë³„ ëª¨ë“œë¡œ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ì™„ë£Œ (${individualCount}ëª…)`);
            }
        }

        async function loadMissionsFromFirebase() {
            try {
                console.log('Firebaseì—ì„œ ë¯¸ì…˜ ë°ì´í„° ë¡œë“œ ì¤‘...');
                
                const result = await window.classProgressFunctions.getMissions(currentClassId);
                
                if (result.success) {
                    // ì „ì²´ ë¯¸ì…˜ ì—…ë°ì´íŠ¸
                    if (result.data.missions && Array.isArray(result.data.missions)) {
                        console.log('ì „ì²´ ë¯¸ì…˜ ì—…ë°ì´íŠ¸ë¨:', result.data.missions);
                        allMissions.length = 0;
                        allMissions.push(...result.data.missions);
                    }
                    
                    // ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì—…ë°ì´íŠ¸
                    if (result.data.todayMissions && Array.isArray(result.data.todayMissions)) {
                        console.log('ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ IDë“¤:', result.data.todayMissions);
                        console.log('ì „ì²´ ë¯¸ì…˜ ëª©ë¡:', allMissions);
                        todaysMissions.length = 0;
                        
                        // todayMissions ID ë°°ì—´ì„ ë°”íƒ•ìœ¼ë¡œ ì‹¤ì œ ë¯¸ì…˜ ê°ì²´ ìƒì„±
                        result.data.todayMissions.forEach(missionId => {
                            const mission = allMissions.find(m => m.id === missionId);
                            if (mission) {
                                console.log(`ì˜¤ëŠ˜ì˜ ë¯¸ì…˜ ì¶”ê°€: ${missionId} - ${mission.text}`);
                                todaysMissions.push({
                                    id: mission.id,
                                    text: mission.text,
                                    completed: false // ê¸°ë³¸ê°’, ë‚˜ì¤‘ì— í•™ìƒ ì§„í–‰ìƒí™©ìœ¼ë¡œ ì—…ë°ì´íŠ¸
                                });
                            } else {
                                console.log(`ë¯¸ì…˜ ${missionId}ë¥¼ ì „ì²´ ë¯¸ì…˜ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                            }
                        });
                        console.log('ìµœì¢… todaysMissions:', todaysMissions);
                    } else {
                        console.log('Firebaseì—ì„œ todayMissions ë°ì´í„° ì—†ìŒ ë˜ëŠ” ì˜ëª»ëœ í˜•ì‹');
                    }
                    
                    renderTodaysMissions();
                    renderAllMissions();
                    updateProgress();
                    
                } else {
                    console.error('ë¯¸ì…˜ ë¡œë“œ ì‹¤íŒ¨:', result.error);
                    // ê¸°ë³¸ ë°ì´í„°ë¡œ ë Œë”ë§
                    renderTodaysMissions();
                    renderAllMissions();
                    updateProgress();
                }
            } catch (error) {
                console.error('Firebase ë¯¸ì…˜ ë¡œë“œ ì˜¤ë¥˜:', error);
                renderTodaysMissions();
                renderAllMissions();
                updateProgress();
            }
        }

        async function loadStudentProgressData() {
            try {
                console.log('Firebaseì—ì„œ í•™ìƒ ë°ì´í„° ë¡œë“œ ì¤‘...');
                
                const result = await window.classProgressFunctions.getStudentData(studentId, currentClassId);
                
                console.log('ë°›ì€ í•™ìƒ ë°ì´í„°:', result);
                
                if (result.success && result.data) {
                    console.log('í•™ìƒ ë°ì´í„° ì²˜ë¦¬ ì‹œì‘');
                    console.log('Firebase ë¯¸ì…˜ ë°ì´í„°:', result.data.missions);
                    console.log('í˜„ì¬ todaysMissions:', todaysMissions);
                    
                    // í•™ìƒì˜ ë¯¸ì…˜ ì™„ë£Œ ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (result.data.missions && Array.isArray(result.data.missions)) {
                        result.data.missions.forEach(serverMission => {
                            console.log(`Firebase ë¯¸ì…˜ ${serverMission.id}: ${serverMission.completed}`);
                            
                            const localMission = todaysMissions.find(m => m.id === serverMission.id);
                            if (localMission) {
                                console.log(`ë¡œì»¬ ë¯¸ì…˜ ${localMission.id} ì—…ë°ì´íŠ¸: ${serverMission.completed}`);
                                localMission.completed = serverMission.completed || false;
                            } else {
                                console.log(`ë¡œì»¬ ë¯¸ì…˜ ${serverMission.id}ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ`);
                            }
                        });
                    } else {
                        console.log('Firebaseì—ì„œ ë¯¸ì…˜ ë°ì´í„° ì—†ìŒ');
                    }
                    
                    if (result.data.messages) {
                        console.log('ë°›ì€ ë©”ì‹œì§€:', result.data.messages);
                        const newMessageCount = result.data.messages.length;
                        
                        // ìƒˆ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                        if (newMessageCount > lastMessageCount && lastMessageCount > 0) {
                            const newMessages = newMessageCount - lastMessageCount;
                            console.log('ìƒˆ ë©”ì‹œì§€ ê°ì§€!', newMessages, 'ê°œ');
                            unreadMessageCount += newMessages;
                            updateMessageNotification();
                        }
                        
                        receivedMessages = result.data.messages;
                        lastMessageCount = newMessageCount;
                    }
                    
                    renderTodaysMissions();
                    updateProgress();
                } else {
                    console.error('í•™ìƒ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', result.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜');
                }
                
            } catch (error) {
                console.error('Firebase í•™ìƒ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function startMission() {
            const studentIdInputVal = studentIdInput.value;
            if (studentIdInputVal) {
                studentId = studentIdInputVal;
                studentIdModal.style.display = 'none';
                pageHeader.style.display = 'flex';
                mainContainer.style.display = 'flex';
                
                if (classMode === 'group') {
                    userInfo.textContent = studentId + 'ì¡°';
                } else {
                    userInfo.textContent = studentId + 'ë²ˆ';
                }
                
                // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
                loadStudentData();
                window.missionsLoaded = true; // ì²« ë¡œë”© ì™„ë£Œ í”Œë˜ê·¸
                
                // í•™ìƒ ì ‘ì† ì¦‰ì‹œ Firebaseì— ì´ˆê¸° ì§„í–‰ìƒí™© ìƒì„±
                setTimeout(() => {
                    createInitialStudentProgress();
                }, 1000);
                
                // ì´ˆê¸° ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì„¤ì • (ìƒˆ ë©”ì‹œì§€ ì•Œë¦¼ ë°©ì§€)
                setTimeout(() => {
                    lastMessageCount = receivedMessages.length;
                    console.log('ì´ˆê¸° ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì„¤ì •:', lastMessageCount);
                    window.lastNotificationTime = Date.now(); // Firebase ì•Œë¦¼ ì´ˆê¸°í™”
                }, 2000);
                
                // ğŸ”¥ Firebase ì‹¤ì‹œê°„ ì—°ê²° ì‹œì‘!
                startFirebaseListeners();
                
                // ë°±ì—… ìƒˆë¡œê³ ì¹¨ ì‹œì‘ (60ì´ˆë§ˆë‹¤ - Firebase ì‹¤íŒ¨ì‹œ ëŒ€ë¹„)
                startBackupRefresh();
            } else {
                if (classMode === 'group') {
                    alert('ì¡°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                } else {
                    alert('ë²ˆí˜¸ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!');
                }
            }
        }

        function startFirebaseListeners() {
            if (!currentClassId) {
                console.error('í´ë˜ìŠ¤ IDê°€ ì—†ì–´ì„œ Firebase ì—°ê²° ë¶ˆê°€');
                return;
            }
            
            console.log('Firebase ì‹¤ì‹œê°„ ì—°ê²° ì‹œì‘:', currentClassId);
            
            // ì‹¤ì‹œê°„ ì•Œë¦¼ êµ¬ë…
            const notificationUnsubscribe = window.classProgressFunctions.subscribeToNotifications(
                currentClassId,
                async (notification) => {
                    console.log('Firebase ì•Œë¦¼ ë°›ìŒ:', notification);
                    
                    if (notification.timestamp > window.lastNotificationTime) {
                        // ì•Œë¦¼ íƒ€ì…ì— ë”°ë¼ ì²˜ë¦¬
                        switch(notification.type) {
                            case 'missions-updated':
                            case 'today-missions-updated':
                                console.log('ë¯¸ì…˜ êµ¬ì¡° ë³€ê²½ - ë°ì´í„° ìƒˆë¡œê³ ì¹¨');
                                await reloadMissionsAndKeepProgress();
                                break;
                            case 'message-sent':
                                console.log('ìƒˆ ë©”ì‹œì§€ - ë©”ì‹œì§€ ìƒˆë¡œê³ ì¹¨');
                                loadStudentProgressData();
                                break;
                        }
                        
                        window.lastNotificationTime = notification.timestamp;
                    }
                }
            );
            
            // ì •ë¦¬ í•¨ìˆ˜ ì €ì¥
            window.firebaseUnsubscribe = notificationUnsubscribe;
            
            console.log('ğŸ”¥ Firebase ì‹¤ì‹œê°„ ì—°ê²° ì™„ë£Œ!');
        }
        
        // ë°±ì—…ìš© ê°€ë²¼ìš´ ìƒˆë¡œê³ ì¹¨ (60ì´ˆë§ˆë‹¤ - Firebase ì‹¤íŒ¨ì‹œ ëŒ€ë¹„)
        function startBackupRefresh() {
            setInterval(() => {
                if (isVisible && studentId) {
                    console.log('ë°±ì—… ìƒˆë¡œê³ ì¹¨ (60ì´ˆë§ˆë‹¤)');
                    loadStudentMessagesOnly();
                }
            }, 60000); // 60ì´ˆë§ˆë‹¤
        }

        function refreshStudentData() {
            // ë¯¸ì…˜ ëª©ë¡ì€ í•œ ë²ˆë§Œ ë¡œë“œí•˜ê³ , ì´í›„ì—ëŠ” í•™ìƒ ì§„í–‰ìƒí™©ê³¼ ë©”ì‹œì§€ë§Œ ì²´í¬
            if (!window.missionsLoaded) {
                console.log('ìµœì´ˆ ë¯¸ì…˜ ë°ì´í„° ë¡œë“œ');
                loadMissionsFromServer();
                window.missionsLoaded = true;
            } else {
                console.log('ë¯¸ì…˜ ë°ì´í„° ì´ë¯¸ ë¡œë“œë¨, ë©”ì‹œì§€ë§Œ ìƒˆë¡œê³ ì¹¨');
                // ë©”ì‹œì§€ë§Œ ì²´í¬ (í•™ìƒ ì§„í–‰ìƒí™©ì€ ë¯¸ì…˜ í´ë¦­í•  ë•Œë§Œ ì—…ë°ì´íŠ¸)
                loadStudentMessagesOnly();
            }
        }

        async function loadStudentMessagesOnly() {
            if (!studentId || !currentClassId || !window.classProgressFunctions) {
                console.log('í•„ìš”í•œ ë°ì´í„°ê°€ ì—†ìŒ:', { studentId, currentClassId, functions: window.classProgressFunctions });
                return;
            }
            
            try {
                const result = await window.classProgressFunctions.getStudentData(studentId, currentClassId);
                console.log('Firebase ë©”ì‹œì§€ ì „ìš© ì‘ë‹µ:', result);
                
                if (result.success && result.data && result.data.messages) {
                    const newMessageCount = result.data.messages.length;
                    
                    // ìƒˆ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                    if (newMessageCount > lastMessageCount && lastMessageCount > 0) {
                        const newMessages = newMessageCount - lastMessageCount;
                        console.log('ìƒˆ ë©”ì‹œì§€ ê°ì§€!', newMessages, 'ê°œ');
                        unreadMessageCount += newMessages;
                        updateMessageNotification();
                    }
                    
                    receivedMessages = result.data.messages;
                    lastMessageCount = newMessageCount;
                } else {
                    console.log('ë©”ì‹œì§€ ì²´í¬ ì‹¤íŒ¨ ë˜ëŠ” ë°ì´í„° ì—†ìŒ');
                }
            } catch (error) {
                console.error('ë©”ì‹œì§€ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        function renderTodaysMissions() {
            missionListEl.innerHTML = '';
            todaysMissions.forEach(mission => {
                const li = document.createElement('li');
                li.className = 'mission-item';
                if (mission.completed) {
                    li.classList.add('completed');
                }
                li.innerHTML = `
                    <div class="mission-checkbox" onclick="event.stopPropagation(); toggleMission(${mission.id})">${mission.completed ? 'âœ”' : ''}</div>
                    <span class="mission-text" onclick="showMissionDetail(${mission.id})">${mission.text}</span>
                `;
                missionListEl.appendChild(li);
            });
            totalCountEl.textContent = todaysMissions.length;
        }
        
        function renderAllMissions() {
            allMissionListEl.innerHTML = '';
            allMissions.forEach(mission => {
                const div = document.createElement('div');
                let className = 'all-mission-item';
                if (todaysMissions.some(m => m.id === mission.id)) {
                    className += ' current';
                }
                div.className = className;
                div.innerHTML = `
                    <span class="step-number">${mission.id}.</span>
                    <span>${mission.text}</span>
                `;
                allMissionListEl.appendChild(div);
            });
        }

        function renderMessages() {
            messageListEl.innerHTML = '';
            if (receivedMessages.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<span>ì•„ì§ ë„ì°©í•œ ë©”ì‹œì§€ê°€ ì—†ìŠµë‹ˆë‹¤.</span>';
                messageListEl.appendChild(li);
                return;
            }
            receivedMessages.forEach(message => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${message.text}</span>
                    <span class="timestamp">${message.timestamp}</span>
                `;
                messageListEl.appendChild(li);
            });
        }
        
        function updateMessageNotification() {
            const messageButton = document.getElementById('messageButton');
            
            if (unreadMessageCount > 0) {
                messageButton.classList.add('new-message');
                messageButton.setAttribute('data-unread-count', unreadMessageCount);
                
                if (unreadMessageCount === 1) {
                    messageButton.textContent = 'ìƒˆ ë©”ì‹œì§€ ìˆìŒ! ğŸ“¨';
                } else {
                    messageButton.textContent = `ìƒˆ ë©”ì‹œì§€ ${unreadMessageCount}ê°œ! ğŸ“¨`;
                }
            } else {
                messageButton.classList.remove('new-message');
                messageButton.removeAttribute('data-unread-count');
                messageButton.textContent = 'ì„ ìƒë‹˜ ë©”ì‹œì§€ ë³´ê¸° âœ‰ï¸';
            }
        }

        function showMessageModal() {
            renderMessages();
            messageModal.style.display = 'flex';
            
            // ë©”ì‹œì§€ ëª¨ë‹¬ì„ ì—´ë©´ ì½ì§€ ì•Šì€ ë©”ì‹œì§€ ì¹´ìš´íŠ¸ ì´ˆê¸°í™”
            markMessagesAsRead();
        }

        function closeMessageModal() {
            messageModal.style.display = 'none';
        }
        
        function markMessagesAsRead() {
            unreadMessageCount = 0;
            updateMessageNotification();
            console.log('ëª¨ë“  ë©”ì‹œì§€ ì½ìŒìœ¼ë¡œ ì²˜ë¦¬');
        }

        function toggleMission(id) {
            const mission = todaysMissions.find(m => m.id === id);
            if (mission) {
                mission.completed = !mission.completed;
                renderTodaysMissions();
                updateProgress();
                sendProgressUpdate(studentId, todaysMissions);
            }
        }

        function updateProgress() {
            const completedMissions = todaysMissions.filter(m => m.completed).length;
            const totalMissions = todaysMissions.length;
            const progress = (completedMissions / totalMissions) * 100;
            
            completedCountEl.textContent = completedMissions;
            progressBarEl.style.width = `${progress}%`;
        }

        async function sendProgressUpdate(studentId, missionData) {
            try {
                console.log('Firebase ì§„í–‰ ìƒí™© ì „ì†¡ ë°ì´í„°:', {
                    studentId: studentId,
                    classId: currentClassId,
                    missionData: missionData
                });
                
                const result = await window.classProgressFunctions.updateStudentProgress(
                    studentId, 
                    currentClassId, 
                    missionData
                );
                
                if (result.success) {
                    console.log('ì§„í–‰ ìƒí™© ì „ì†¡ ì„±ê³µ');
                    console.log(`${studentId}ë²ˆ í•™ìƒ ì§„í–‰ ìƒí™© ì—…ë°ì´íŠ¸ ì™„ë£Œ (ì§„í–‰ë¥ : ${result.progress}%)`);
                } else {
                    console.error('ì§„í–‰ ìƒí™© ì „ì†¡ ì‹¤íŒ¨:', result.error);
                    alert('ì§„í–‰ ìƒí™© ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
                
            } catch (error) {
                console.error('ì „ì†¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
                alert('ì§„í–‰ ìƒí™© ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        }

        async function sendHelpRequest() {
            if (!studentId) {
                alert('ë¨¼ì € ì´ë¦„ì„ ì…ë ¥í•˜ê³  ì‹œì‘í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!currentClassId) {
                alert('í´ë˜ìŠ¤ IDê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            const helpButton = document.querySelector('.help-button');
            const originalText = helpButton.innerHTML;
            
            helpButton.disabled = true;
            helpButton.innerHTML = 'ìš”ì²­ ì¤‘...';

            try {
                // ë„ì›€ ìš”ì²­ì„ ë³´ë‚´ë©´ì„œ ì§„í–‰ìƒí™©ë„ ì—…ë°ì´íŠ¸
                await window.classProgressFunctions.updateStudentProgress(
                    studentId, 
                    currentClassId, 
                    todaysMissions,
                    true // helpNeededë¥¼ trueë¡œ ì„¤ì •
                );
                const result = await window.classProgressFunctions.sendHelpRequest(studentId, currentClassId);
                
                if (result.success) {
                    console.log('ë„ì›€ ìš”ì²­ ì „ì†¡ ì„±ê³µ');
                    helpButton.innerHTML = 'ì„ ìƒë‹˜ê»˜ ì „ì†¡ ì™„ë£Œ! âœ…';
                    helpButton.style.display = 'none'; // ë„ì›€ ìš”ì²­ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    document.getElementById('helpCancelButton').style.display = 'block'; // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ê¸°
                    alert(`${studentId}${classMode === 'group' ? 'ì¡°' : 'ë²ˆ'}, ì„ ìƒë‹˜ê»˜ ë„ì›€ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ê³§ ë°©ë¬¸í•˜ì‹¤ ê±°ì˜ˆìš”!`);
                } else {
                    console.error('ë„ì›€ ìš”ì²­ ì „ì†¡ ì‹¤íŒ¨:', result.error);
                    alert('ë„ì›€ ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }

                setTimeout(() => {
                    helpButton.disabled = false;
                    helpButton.innerHTML = originalText;
                }, 5000);
                
            } catch (error) {
                console.error('ë„ì›€ ìš”ì²­ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
                alert('ë„ì›€ ìš”ì²­ ì „ì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                helpButton.disabled = false;
                helpButton.innerHTML = originalText;
            }
        }

        // ì‹¤ì‹œê°„ ë¯¸ì…˜ ì—…ë°ì´íŠ¸ ì‹œ ì§„í–‰ìƒí™©ì„ ìœ ì§€í•˜ë©´ì„œ ìƒˆë¡œê³ ì¹¨
        async function reloadMissionsAndKeepProgress() {
            console.log('ğŸ”„ ë¯¸ì…˜ êµ¬ì¡° ë³€ê²½ - ì§„í–‰ìƒí™© ìœ ì§€í•˜ë©° ìƒˆë¡œê³ ì¹¨');
            
            // í˜„ì¬ ì§„í–‰ìƒí™© ì €ì¥
            const currentProgress = {};
            todaysMissions.forEach(mission => {
                currentProgress[mission.id] = mission.completed;
            });
            console.log('í˜„ì¬ ì§„í–‰ìƒí™© ì €ì¥:', currentProgress);
            
            // ìƒˆ ë¯¸ì…˜ êµ¬ì¡° ë¡œë“œ
            await loadMissionsFromFirebase();
            
            // ì§„í–‰ìƒí™© ë³µì›
            todaysMissions.forEach(mission => {
                if (currentProgress.hasOwnProperty(mission.id)) {
                    mission.completed = currentProgress[mission.id];
                    console.log(`ë¯¸ì…˜ ${mission.id} ì§„í–‰ìƒí™© ë³µì›: ${mission.completed}`);
                }
            });
            
            // í™”ë©´ ì—…ë°ì´íŠ¸
            renderTodaysMissions();
            renderAllMissions();
            updateProgress();
            
            console.log('âœ… ë¯¸ì…˜ ìƒˆë¡œê³ ì¹¨ ì™„ë£Œ - ì§„í–‰ìƒí™© ìœ ì§€ë¨');
        }

        async function cancelHelpRequest() {
            if (!studentId || !currentClassId) {
                alert('í•™ìƒ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const helpCancelButton = document.getElementById('helpCancelButton');
            const helpButton = document.getElementById('helpButton');
            const originalText = helpCancelButton.innerHTML;
            
            helpCancelButton.disabled = true;
            helpCancelButton.innerHTML = 'ì·¨ì†Œ ì¤‘...';
            
            try {
                // Firebaseì—ì„œ ë„ì›€ ìš”ì²­ ìƒíƒœë¥¼ í•´ì œ
                const result = await window.classProgressFunctions.updateStudentProgress(
                    studentId, 
                    currentClassId, 
                    todaysMissions,
                    false // helpNeededë¥¼ falseë¡œ ì„¤ì •
                );
                
                if (result.success) {
                    console.log('ë„ì›€ ìš”ì²­ ì·¨ì†Œ ì„±ê³µ');
                    helpCancelButton.style.display = 'none'; // ì·¨ì†Œ ë²„íŠ¼ ìˆ¨ê¸°ê¸°
                    helpButton.style.display = 'block'; // ë„ì›€ ìš”ì²­ ë²„íŠ¼ ë‹¤ì‹œ ë³´ì´ê¸°
                    helpButton.innerHTML = 'ë„ì™€ì£¼ì„¸ìš”! âœ‹';
                    alert('ë„ì›€ ìš”ì²­ì„ ì·¨ì†Œí–ˆìŠµë‹ˆë‹¤.');
                } else {
                    console.error('ë„ì›€ ìš”ì²­ ì·¨ì†Œ ì‹¤íŒ¨:', result.error);
                    alert('ë„ì›€ ìš”ì²­ ì·¨ì†Œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ë„ì›€ ìš”ì²­ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ë„ì›€ ìš”ì²­ ì·¨ì†Œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                helpCancelButton.disabled = false;
                helpCancelButton.innerHTML = originalText;
            }
        }
        
        // í˜„ì¬ ì„ íƒëœ ë¯¸ì…˜ ID
        let currentSelectedMissionId = null;
        
        // ë¯¸ì…˜ ìƒì„¸ ë‚´ìš© í‘œì‹œ
        function showMissionDetail(missionId) {
            currentSelectedMissionId = missionId;
            const mission = allMissions.find(m => m.id === missionId);
            const missionDetailDisplay = document.getElementById('missionDetailDisplay');
            const missionMemoInput = document.getElementById('missionMemoInput');
            const saveMemoButton = document.getElementById('saveMemoButton');
            
            if (mission) {
                // ìƒì„¸ ë‚´ìš© í‘œì‹œ
                if (mission.description && mission.description.trim()) {
                    missionDetailDisplay.innerHTML = `
                        <h4>${mission.text}</h4>
                        <p>${mission.description.replace(/\n/g, '<br>')}</p>
                    `;
                } else {
                    missionDetailDisplay.innerHTML = `
                        <h4>${mission.text}</h4>
                        <p><em>ì„ ìƒë‹˜ì´ ì•„ì§ ìƒì„¸ ì„¤ëª…ì„ ì¶”ê°€í•˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</em></p>
                    `;
                }
                
                // ê¸°ì¡´ ë©”ëª¨ ë¶ˆëŸ¬ì˜¤ê¸°
                loadStudentMemo(missionId);
                
                // ì €ì¥ ë²„íŠ¼ í™œì„±í™”
                saveMemoButton.disabled = false;
                
                // ë©”ëª¨ ì…ë ¥ ì‹œ ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                missionMemoInput.oninput = function() {
                    saveMemoButton.disabled = false;
                    saveMemoButton.textContent = 'ë©”ëª¨ ì €ì¥';
                };
            }
        }
        
        // í•™ìƒ ë©”ëª¨ ë¡œë“œ
        async function loadStudentMemo(missionId) {
            try {
                const result = await window.classProgressFunctions.getStudentData(studentId, currentClassId);
                if (result.success && result.data && result.data.memos) {
                    const memo = result.data.memos.find(m => m.missionId === missionId);
                    if (memo) {
                        document.getElementById('missionMemoInput').value = memo.content || '';
                    } else {
                        document.getElementById('missionMemoInput').value = '';
                    }
                }
            } catch (error) {
                console.error('ë©”ëª¨ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }
        
        // ë¯¸ì…˜ ë©”ëª¨ ì €ì¥
        async function saveMissionMemo() {
            if (!currentSelectedMissionId || !studentId || !currentClassId) {
                alert('ë¯¸ì…˜ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const memoContent = document.getElementById('missionMemoInput').value.trim();
            const saveMemoButton = document.getElementById('saveMemoButton');
            
            saveMemoButton.disabled = true;
            saveMemoButton.textContent = 'ì €ì¥ ì¤‘...';
            
            try {
                // Firebaseì— ë©”ëª¨ ì €ì¥
                const result = await window.classProgressFunctions.saveMissionMemo(
                    studentId, 
                    currentClassId, 
                    currentSelectedMissionId, 
                    memoContent
                );
                
                if (result.success) {
                    saveMemoButton.textContent = 'ì €ì¥ ì™„ë£Œ!';
                    setTimeout(() => {
                        saveMemoButton.textContent = 'ë©”ëª¨ ì €ì¥';
                        saveMemoButton.disabled = true;
                    }, 1500);
                } else {
                    console.error('ë©”ëª¨ ì €ì¥ ì‹¤íŒ¨:', result.error);
                    alert('ë©”ëª¨ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    saveMemoButton.disabled = false;
                    saveMemoButton.textContent = 'ë©”ëª¨ ì €ì¥';
                }
            } catch (error) {
                console.error('ë©”ëª¨ ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ë©”ëª¨ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                saveMemoButton.disabled = false;
                saveMemoButton.textContent = 'ë©”ëª¨ ì €ì¥';
            }
        }
        
        // í•™ìƒ ì ‘ì† ì‹œ ì´ˆê¸° ì§„í–‰ìƒí™©ì„ Firebaseì— ìƒì„±
        async function createInitialStudentProgress() {
            if (!studentId || !currentClassId || !window.classProgressFunctions) {
                console.log('ì´ˆê¸° ì§„í–‰ìƒí™© ìƒì„± ë¶ˆê°€:', { studentId, currentClassId, functions: window.classProgressFunctions });
                return;
            }

            try {
                console.log('í•™ìƒ ì´ˆê¸° ì§„í–‰ìƒí™© ìƒì„± ì¤‘...', { studentId, currentClassId });
                
                // ë¹ˆ ë¯¸ì…˜ ë°ì´í„°ë¡œ ì´ˆê¸° ì§„í–‰ìƒí™© ìƒì„± (0% ì§„í–‰ë¥ )
                const initialMissionData = todaysMissions.map(mission => ({
                    id: mission.id,
                    text: mission.text,
                    completed: false
                }));

                const result = await window.classProgressFunctions.updateStudentProgress(
                    studentId, 
                    currentClassId, 
                    initialMissionData
                );

                if (result.success) {
                    console.log('âœ… ì´ˆê¸° ì§„í–‰ìƒí™© ìƒì„± ì„±ê³µ:', result);
                } else {
                    console.error('âŒ ì´ˆê¸° ì§„í–‰ìƒí™© ìƒì„± ì‹¤íŒ¨:', result.error);
                }
            } catch (error) {
                console.error('ì´ˆê¸° ì§„í–‰ìƒí™© ìƒì„± ì˜¤ë¥˜:', error);
            }
        }
    </script>
</body>
</html>
