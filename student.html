
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>나의 학습 진도</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Sans KR', sans-serif;
            background: linear-gradient(135deg, #e0f7fa, #c5e1e5);
            color: #37474f;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            min-height: 100vh;
        }

        .page-header {
            width: 100%;
            background-color: white;
            color: #333;
            padding: 10px 15px;
            border-radius: 6px;
            box-shadow: 0 1px 5px rgba(0,0,0,0.1);
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 50;
        }

        .header-left {
            display: flex;
            align-items: baseline;
            gap: 15px;
        }

        .page-header h1 {
            margin: 0 0 4px 0;
            font-size: 20px;
            color: #333;
            font-weight: 700;
        }
        
        .header-functions {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .user-info {
            font-size: 18px;
            font-weight: 500;
            color: #374151;
            background: rgba(59, 130, 246, 0.1);
            padding: 4px 12px;
            border-radius: 20px;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }
        
        /* 학습 내용 패널 스타일 */
        .panel-content {
            display: flex;
            flex-direction: column;
        }
        
        .mission-detail-section {
            flex: 1;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eceff1;
        }
        
        .mission-detail-section h3 {
            color: #00acc1;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .mission-detail-content {
            background-color: #f8fafc;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #00acc1;
            min-height: 80px;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .mission-memo-section {
            flex: 1;
        }
        
        .mission-memo-section h3 {
            color: #00acc1;
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .mission-memo-section textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #eceff1;
            border-radius: 8px;
            font-family: inherit;
            font-size: 14px;
            resize: vertical;
            margin-bottom: 10px;
        }
        
        .mission-memo-section textarea:focus {
            outline: none;
            border-color: #00acc1;
        }
        
        .save-memo-btn {
            background-color: #00acc1;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .save-memo-btn:hover:not(:disabled) {
            background-color: #00838f;
        }
        
        .save-memo-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        /* 본문 영역 전체를 감싸는 컨테이너 */
        .content-wrapper {
            width: 100%;
            max-width: 1600px; /* 최대 너비는 유지 */
            padding: 30px; /* 좌우 여백 다시 추가 */
            display: flex;
            flex-direction: column;
            flex-grow: 1;
        }

        .main-container {
            width: 100%;
            display: none;
            gap: 25px;
            flex-grow: 1;
            /* 기존 main-container의 padding을 content-wrapper로 이동 */
        }
        
        .panel {
            background-color: #fff;
            border-radius: 16px;
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
            flex: 1;
            overflow-y: auto;
            padding: 40px;
        }
        
        .panel-overall {
            flex: 0 0 300px;
            min-width: 300px;
        }

        .panel-today {
            flex: 0 0 400px;
            min-width: 400px;
        }

        .panel-functions {
            flex: 1;
            min-width: 400px;
        }

        .header {
            margin-bottom: 35px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: 700;
            color: #00acc1;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            color: #607d8b;
        }

        .progress-wrapper {
            margin-bottom: 30px;
            text-align: center;
        }

        .progress-text {
            font-size: 18px;
            font-weight: 500;
            color: #00acc1;
            margin-bottom: 12px;
        }

        .progress-container {
            width: 100%;
            height: 12px;
            background-color: #eceff1;
            border-radius: 6px;
            overflow: hidden;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #00acc1 0%, #00838f 100%);
            border-radius: 6px;
            transition: width 0.4s ease-in-out;
            width: 0%;
        }

        .mission-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        .mission-item {
            padding: 18px;
            background-color: #f0f4f4;
            border-radius: 12px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .mission-item:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border-color: #b2ebf2;
        }

        .mission-item.completed {
            background-color: #e0f2f1;
            border-color: #80cbc4;
        }

        .mission-checkbox {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: 2px solid #b0bec5;
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 20px;
            flex-shrink: 0;
            transition: all 0.2s ease;
            font-size: 18px;
            color: transparent;
        }

        .mission-item.completed .mission-checkbox {
            background-color: #00acc1;
            border-color: #00acc1;
            color: white;
        }

        .mission-text {
            flex-grow: 1;
            font-size: 17px;
            font-weight: 500;
            color: #455a64;
            line-height: 1.5;
        }
        
        .all-mission-item {
            padding: 12px 15px;
            border-bottom: 1px solid #eceff1;
            display: flex;
            align-items: center;
            font-size: 13.5px;
            color: #607d8b;
        }
        
        .all-mission-item:last-child {
            border-bottom: none;
        }
        
        .all-mission-item .step-number {
            font-weight: 700;
            color: #78909c;
            margin-right: 10px;
            width: 25px;
            flex-shrink: 0;
        }
        
        .all-mission-item.current {
            background-color: #fffde7;
            border-radius: 8px;
        }
        
        .all-mission-item.current .step-number {
            color: #ffb300;
        }
        
        .function-button {
            width: 100%;
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 10px;
        }

        .help-button {
            background-color: #ef4444;
        }

        .help-button:hover {
            background-color: #dc2626;
            box-shadow: 0 4px 12px rgba(239, 68, 68, 0.3);
            transform: translateY(-2px);
        }
        
        .message-inbox-button {
            background-color: #2196f3;
            width: 100%;
            padding: 8px 14px;
            margin: 3px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            margin-bottom: 10px;
            white-space: nowrap;
            position: relative;
        }
        
        .message-inbox-button:hover {
            background-color: #1976d2;
            box-shadow: 0 4px 12px rgba(33, 150, 243, 0.3);
            transform: translateY(-2px);
        }
        
        .message-inbox-button.new-message {
            position: relative;
        }
        
        .message-inbox-button.new-message::after {
            content: attr(data-unread-count);
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: #ef4444;
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 11px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 2px solid white;
            z-index: 10;
        }
        
        .message-inbox-button.new-message[data-unread-count="0"]::after {
            display: none;
        }
        
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .modal {
            background-color: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        .modal h2 {
            font-size: 22px;
            margin-bottom: 15px;
            color: #37474f;
        }
        
        .modal input {
            width: 250px;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #cfd8dc;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .modal button {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            color: white;
            background-color: #00acc1;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .modal button:hover {
            background-color: #00838f;
        }

        .message-modal-content {
            width: 90%;
            max-width: 500px;
            max-height: 60vh;
            overflow-y: auto;
            text-align: left;
            padding: 20px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .message-modal-content ul {
            list-style: none;
            padding: 0;
        }
        
        .message-modal-content li {
            background: linear-gradient(145deg, #f8fafc, #ffffff);
            border: 1px solid #e5e7eb;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 12px;
            line-height: 1.5;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .message-modal-content li:hover {
            background: linear-gradient(145deg, #f1f5f9, #f8fafc);
            border-color: #3b82f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .message-modal-content li.unread {
            background: linear-gradient(145deg, #eff6ff, #dbeafe);
            border-color: #3b82f6;
            font-weight: 500;
        }
        
        .message-modal-content .timestamp {
            display: block;
            font-size: 11px;
            color: #6b7280;
            margin-top: 8px;
            font-weight: normal;
        }
        
        .message-modal-content .message-text {
            color: #374151;
            font-size: 14px;
            line-height: 1.6;
        }
        
        .close-button {
            margin-top: 20px;
            padding: 8px 16px;
            background-color: #6b7280;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 13px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .close-button:hover {
            background-color: #374151;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        @media (max-width: 600px) {
            .main-container {
                flex-direction: column;
                padding: 15px;
            }

            .panel {
                padding: 20px;
            }
            
            .page-header {
                padding: 15px 20px;
            }

            .header-left {
                gap: 10px;
            }

            .page-header h1 {
                font-size: 20px;
            }
            
            .user-info {
                font-size: 16px;
                padding: 2px 8px;
            }

            .header-functions {
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="modal-overlay" id="studentIdModal">
        <div class="modal">
            <h2>학습 시작</h2>
            <p id="modalDescription" style="margin-bottom: 15px;">번호를 선택해주세요.</p>
            <select id="studentIdInput" style="width: 250px; padding: 12px; font-size: 16px; border: 1px solid #cfd8dc; border-radius: 8px; margin-bottom: 15px;">
                <option value="">번호를 선택하세요</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
                <option value="10">10</option>
                <option value="11">11</option>
                <option value="12">12</option>
                <option value="13">13</option>
                <option value="14">14</option>
                <option value="15">15</option>
                <option value="16">16</option>
                <option value="17">17</option>
                <option value="18">18</option>
                <option value="19">19</option>
                <option value="20">20</option>
                <option value="21">21</option>
                <option value="22">22</option>
                <option value="23">23</option>
                <option value="24">24</option>
                <option value="25">25</option>
                <option value="26">26</option>
                <option value="27">27</option>
                <option value="28">28</option>
                <option value="29">29</option>
                <option value="30">30</option>
                <option value="31">31</option>
                <option value="32">32</option>
                <option value="33">33</option>
                <option value="34">34</option>
                <option value="35">35</option>
            </select>
            <button onclick="startMission()">시작하기</button>
        </div>
    </div>

    <div class="modal-overlay" id="messageModal" style="display: none;">
        <div class="modal">
            <h2>선생님 메시지</h2>
            <div class="message-modal-content">
                <ul id="messageList"></ul>
            </div>
            <button class="close-button" onclick="closeMessageModal()">닫기</button>
        </div>
    </div>
    
    <div class="page-header" id="pageHeader" style="display: none;">
        <div class="header-left">
            <h1 id="pageTitle">나의 학습 진도</h1>
            <div class="user-info" id="userInfo"></div>
        </div>
        <div class="header-functions">
            <button class="function-button help-button" id="helpButton" onclick="sendHelpRequest()">도와주세요!</button>
            <button class="function-button help-cancel-button" id="helpCancelButton" onclick="cancelHelpRequest()" style="display: none; background-color: #6b7280;">도움 취소</button>
            <button class="message-inbox-button" id="messageButton" onclick="showMessageModal()">선생님 메시지 보기</button>
        </div>
    </div>
    
    <div class="content-wrapper">
        <div class="main-container" id="mainContainer">
            <div class="panel panel-overall">
                <div class="header">
                    <h1>전체 미션 단계</h1>
                </div>
                <div id="allMissionList">
                    </div>
            </div>

            <div class="panel panel-today">
                <div class="header">
                    <h1>오늘의 학습 미션</h1>
                    <p>미션을 완료하고 진행 상황을 선생님께 알려주세요!</p>
                </div>
                <div class="progress-wrapper">
                    <div class="progress-text"><span id="completed-count">0</span> / <span id="total-count">0</span>개 완료</div>
                    <div class="progress-container">
                        <div class="progress-bar" id="progressBar"></div>
                    </div>
                </div>
                <ul class="mission-list" id="missionList">
                    </ul>
            </div>

            <div class="panel panel-content">
                <div class="header">
                    <h1>학습 내용</h1>
                    <p>미션을 클릭하면 상세 내용을 확인할 수 있습니다</p>
                </div>
                
                <!-- 상단: 미션 상세내용 -->
                <div class="mission-detail-section">
                    <h3>미션 상세 설명</h3>
                    <div id="missionDetailDisplay" class="mission-detail-content">
                        <p>오늘의 미션에서 미션을 클릭하면 여기에 자세한 설명이 나타납니다.</p>
                    </div>
                </div>
                
                <!-- 하단: 학생 메모 -->
                <div class="mission-memo-section">
                    <h3>나의 메모</h3>
                    <textarea id="missionMemoInput" 
                              placeholder="이 미션을 어떻게 수행했는지 간단히 적어주세요..."
                              rows="4"></textarea>
                    <button id="saveMemoButton" class="save-memo-btn" onclick="saveMissionMemo()" disabled>메모 저장</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase 설정 -->
    <script type="module">
        // Firebase 설정과 함수들을 직접 포함
        
        // Firebase import
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
        import { 
          getFirestore, 
          collection, 
          doc, 
          addDoc, 
          getDoc, 
          getDocs, 
          updateDoc, 
          setDoc,
          deleteDoc,
          query, 
          where, 
          orderBy,
          onSnapshot,
          serverTimestamp 
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';

        import { 
          getDatabase, 
          ref, 
          set, 
          get, 
          push, 
          onValue, 
          off 
        } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js';

        // Firebase 설정
        const firebaseConfig = {
          apiKey: "AIzaSyBV1IFHlWjQ6ftVmnhX74YITKWCdsjdZLM",
          authDomain: "classroom-progress.firebaseapp.com",
          databaseURL: "https://classroom-progress-default-rtdb.asia-southeast1.firebasedatabase.app/",
          projectId: "classroom-progress",
          storageBucket: "classroom-progress.firebasestorage.app",
          messagingSenderId: "307617869427",
          appId: "1:307617869427:web:20a35dc705cc3fc3854406"
        };

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const realtimeDb = getDatabase(app);

        // 전역으로 내보내기
        window.firebaseApp = app;
        window.firebaseDb = db;
        window.realtimeDb = realtimeDb;

        // Firebase 함수들을 전역으로 내보내기
        window.firebaseFunctions = {
          collection, doc, addDoc, getDoc, getDocs, updateDoc, setDoc, deleteDoc,
          query, where, orderBy, onSnapshot, serverTimestamp,
          ref, set: set, get: get, push, onValue, off
        };

        // Firebase 함수들 정의 (학생용 필수 함수들만)
        
        // 학생 데이터 가져오기
        async function getStudentData(studentId, classId) {
          try {
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            let studentData = { missions: [], messages: [] };
            
            if (!progressSnapshot.empty) {
              const data = progressSnapshot.docs[0].data();
              studentData.missions = data.missions || [];
            }
            
            const messagesQuery = query(
              collection(db, 'messages'),
              where('classId', '==', classId),
              where('recipient', 'in', [studentId, 'all'])
            );
            
            const messagesSnapshot = await getDocs(messagesQuery);
            const messages = [];
            
            messagesSnapshot.forEach(doc => {
              const data = doc.data();
              messages.push({
                text: data.message,
                timestamp: formatTimestamp(data.timestamp),
                rawTimestamp: data.timestamp
              });
            });
            
            messages.sort((a, b) => {
              const aTime = a.rawTimestamp?.toDate ? a.rawTimestamp.toDate() : new Date(a.rawTimestamp);
              const bTime = b.rawTimestamp?.toDate ? b.rawTimestamp.toDate() : new Date(b.rawTimestamp);
              return bTime - aTime;
            });
            
            studentData.messages = messages;
            
            return {
              success: true,
              data: studentData
            };
          } catch (error) {
            console.error('학생 데이터 로드 오류:', error);
            return {
              success: false,
              data: { missions: [], messages: [] }
            };
          }
        }

        // 학생 진행상황 업데이트
        async function updateStudentProgress(studentId, classId, missionData, helpNeeded = null) {
          try {
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            
            const completedMissions = missionData.filter(m => m.completed).length;
            const totalMissions = missionData.length;
            const progress = totalMissions > 0 ? Math.round((completedMissions / totalMissions) * 100) : 0;
            
            const progressData = {
              classId: classId,
              studentId: studentId,
              missions: missionData,
              progress: progress,
              lastUpdate: serverTimestamp(),
              helpNeeded: helpNeeded !== null ? (helpNeeded ? 'YES' : 'NO') : 'NO',
              hasNewMessage: 'NO'
            };
            
            if (progressSnapshot.empty) {
              await setDoc(doc(collection(db, 'studentProgress')), progressData);
            } else {
              const docRef = progressSnapshot.docs[0].ref;
              await setDoc(docRef, progressData, { merge: true });
            }
            
            await sendRealtimeNotification(classId, 'progress-updated', { studentId, progress });
            
            return { success: true, progress: progress };
          } catch (error) {
            console.error('진행상황 업데이트 오류:', error);
            return { success: false, error: error.message };
          }
        }

        // 미션 데이터 가져오기
        async function getMissions(classId) {
          try {
            const classQuery = query(
              collection(db, 'classes'),
              where('classId', '==', classId)
            );
            
            const classSnapshot = await getDocs(classQuery);
            
            if (!classSnapshot.empty) {
              const data = classSnapshot.docs[0].data();
              
              const missions = [];
              if (data.missions) {
                Object.keys(data.missions).forEach(id => {
                  const missionData = data.missions[id];
                  missions.push({
                    id: parseInt(id),
                    text: typeof missionData === 'string' ? missionData : missionData.text,
                    description: typeof missionData === 'string' ? '' : (missionData.description || '')
                  });
                });
              }
              
              missions.sort((a, b) => a.id - b.id);
              
              return {
                success: true,
                data: {
                  missions: missions,
                  todayMissions: data.todayMissions || [],
                  mode: data.mode || 'individual',
                  count: data.count || 35
                }
              };
            }
            
            return {
              success: true,
              data: { missions: [], todayMissions: [], mode: 'individual', count: 35 }
            };
          } catch (error) {
            console.error('미션 로드 오류:', error);
            return {
              success: false,
              data: { missions: [], todayMissions: [], mode: 'individual', count: 35 }
            };
          }
        }

        // 도움 요청 전송
        async function sendHelpRequest(studentId, classId) {
          try {
            await addDoc(collection(db, 'helpRequests'), {
              classId: classId,
              studentId: studentId,
              timestamp: serverTimestamp(),
              status: 'pending'
            });
            
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            if (!progressSnapshot.empty) {
              const docRef = progressSnapshot.docs[0].ref;
              await setDoc(docRef, {
                helpNeeded: 'YES'
              }, { merge: true });
            }
            
            await sendRealtimeNotification(classId, 'help-requested', { studentId });
            
            return { success: true };
          } catch (error) {
            console.error('도움 요청 오류:', error);
            return { success: false, error: error.message };
          }
        }

        // 학생 미션 메모 저장
        async function saveMissionMemo(studentId, classId, missionId, memoContent) {
          try {
            const classQuery = query(
              collection(db, 'classes'),
              where('classId', '==', classId)
            );
            
            const classSnapshot = await getDocs(classQuery);
            let missionText = '미션 제목 없음';
            
            if (!classSnapshot.empty) {
              const classData = classSnapshot.docs[0].data();
              if (classData.missions && classData.missions[missionId]) {
                const missionData = classData.missions[missionId];
                missionText = typeof missionData === 'string' ? missionData : missionData.text;
              }
            }
            
            const progressQuery = query(
              collection(db, 'studentProgress'),
              where('classId', '==', classId),
              where('studentId', '==', studentId)
            );
            
            const progressSnapshot = await getDocs(progressQuery);
            
            if (progressSnapshot.empty) {
              return { success: false, error: '학생 진행상황을 찾을 수 없습니다.' };
            }
            
            const docRef = progressSnapshot.docs[0].ref;
            const existingData = progressSnapshot.docs[0].data();
            
            let memos = existingData.memos || [];
            
            const existingMemoIndex = memos.findIndex(m => m.missionId === missionId);
            
            const memoData = {
              missionId: missionId,
              missionText: missionText,
              content: memoContent,
              lastUpdate: new Date()
            };
            
            if (existingMemoIndex >= 0) {
              memos[existingMemoIndex] = memoData;
            } else {
              memos.push(memoData);
            }
            
            await updateDoc(docRef, {
              memos: memos,
              unreadMemos: (existingData.unreadMemos || 0) + 1,
              lastUpdate: new Date()
            });
            
            await addDoc(collection(db, 'studentMemos'), {
              classId: classId,
              studentId: studentId,
              missionId: missionId,
              missionText: missionText,
              content: memoContent,
              timestamp: new Date()
            });
            
            return { success: true };
            
          } catch (error) {
            console.error('미션 메모 저장 오류:', error);
            return { success: false, error: error.message };
          }
        }

        // 실시간 알림 전송
        async function sendRealtimeNotification(classId, type, data = {}) {
          try {
            await addDoc(collection(db, 'notifications'), {
              classId: classId,
              type: type,
              timestamp: serverTimestamp(),
              timestampMs: Date.now(),
              data: data
            });
            
            console.log('실시간 알림 전송:', type, data);
          } catch (error) {
            console.error('실시간 알림 전송 오류:', error);
          }
        }

        // 실시간 알림 구독
        function subscribeToNotifications(classId, callback) {
          const notificationsQuery = query(
            collection(db, 'notifications'),
            where('classId', '==', classId)
          );
          
          const fiveMinutesAgo = Date.now() - (5 * 60 * 1000);
          
          return onSnapshot(notificationsQuery, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
              if (change.type === 'added') {
                const data = change.doc.data();
                
                if (data.timestampMs > fiveMinutesAgo) {
                  callback({
                    type: data.type,
                    timestamp: data.timestampMs,
                    data: data.data
                  });
                }
              }
            });
          });
        }

        // 타임스탬프 포맷 함수
        function formatTimestamp(timestamp) {
          if (!timestamp) return '';
          
          const date = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
          
          const year = date.getFullYear();
          const month = String(date.getMonth() + 1).padStart(2, '0');
          const day = String(date.getDate()).padStart(2, '0');
          const hours = String(date.getHours()).padStart(2, '0');
          const minutes = String(date.getMinutes()).padStart(2, '0');
          
          return `${year}-${month}-${day} ${hours}:${minutes}`;
        }

        // 전역으로 함수들 내보내기 (학생용 필수 함수들만)
        window.classProgressFunctions = {
          getStudentData,
          updateStudentProgress,
          getMissions,
          sendHelpRequest,
          saveMissionMemo,
          subscribeToNotifications
        };

        console.log('✅ Firebase 초기화 완료 (Student)');
        console.log('📋 사용 가능한 함수들:', Object.keys(window.classProgressFunctions));
        
        console.log('Student.html Firebase 모듈들 로드 완료');
        
        // 함수들이 제대로 로드되었는지 확인
        window.addEventListener('load', () => {
            console.log('Student Firebase 준비 상태:', {
                firebaseDb: window.firebaseDb,
                realtimeDb: window.realtimeDb,
                functions: window.classProgressFunctions
            });
        });
    </script>

    <script>
        // Firebase로 완전 전환 - Apps Script URL 제거
        let studentId = null; 
        let currentClassId = null; // 클래스 ID로 변경
        const pageHeader = document.getElementById('pageHeader');
        const userInfo = document.getElementById('userInfo');
        
        // URL에서 클래스 ID 가져오기
        function getClassIdFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get('classId');
        }
        const contentWrapper = document.getElementById('content-wrapper');
        const mainContainer = document.getElementById('mainContainer');
        const studentIdModal = document.getElementById('studentIdModal');
        const studentIdInput = document.getElementById('studentIdInput');
        const messageModal = document.getElementById('messageModal');

        let allMissions = [
            { id: 1, text: "단원 소개 영상 시청하기" },
            { id: 2, text: "텍스트 읽고 핵심 내용 요약하기" },
            { id: 3, text: "교과서 문제 풀기 (1~5번)" },
            { id: 4, text: "조별 토론 준비하기" },
            { id: 5, text: "토론 결과 발표하기" },
            { id: 6, text: "심화 학습 과제 제출하기" },
            { id: 7, text: "단원 평가 문제 풀기" },
            { id: 8, text: "오답 노트 정리하기" },
            { id: 9, text: "친구에게 학습 내용 설명하기" },
            { id: 10, text: "단원 마무리 발표 준비하기" }
        ];

        let todaysMissions = [
            { id: 3, text: "교과서 문제 풀기 (1~5번)", completed: false },
            { id: 4, text: "조별 토론 준비하기", completed: false },
            { id: 5, text: "토론 결과 발표하기", completed: false }
        ];

        let receivedMessages = [
            { text: "김철수 학생, 미션 3번 완료를 축하해요! 다음 미션도 힘내세요!", timestamp: "2024-05-23 14:30" },
            { text: "오늘의 학습 태도가 매우 훌륭합니다. 이대로 쭉 진행하세요!", timestamp: "2024-05-23 11:15" },
        ];
        
        let lastMessageCount = 0;
        let unreadMessageCount = 0;
        let classMode = 'individual'; // 'individual' 또는 'group'


        const missionListEl = document.getElementById('missionList');
        const allMissionListEl = document.getElementById('allMissionList');
        const completedCountEl = document.getElementById('completed-count');
        const totalCountEl = document.getElementById('total-count');
        const progressBarEl = document.getElementById('progressBar');
        const messageListEl = document.getElementById('messageList');

        let isVisible = true;
        let autoRefreshInterval = null;

        document.addEventListener('DOMContentLoaded', async () => {
            // 먼저 클래스 모드를 로드해서 모달을 설정
            currentClassId = getClassIdFromUrl();
            if (currentClassId) {
                await loadClassMode();
                // 모드 로딩 후 모달 업데이트 확인
                console.log('모달 업데이트 후 classMode:', classMode);
                updateModalForMode();
            }
            
            studentIdModal.style.display = 'flex';
            
            studentIdInput.addEventListener('change', (event) => {
                // 드롭다운 선택 시 자동으로 시작하지 않고, 버튼 클릭 대기
            });
            
            studentIdInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    startMission();
                }
            });

            // 탭 가시성 변경 감지
            document.addEventListener('visibilitychange', function() {
                isVisible = !document.hidden;
                if (isVisible && studentId) {
                    console.log('탭 활성화 - 즉시 새로고침');
                    refreshStudentData();
                }
            });
        });

        async function loadStudentData() {
            try {
                // URL에서 클래스 ID 가져오기
                currentClassId = getClassIdFromUrl();
                console.log('사용할 클래스 ID:', currentClassId);
                
                if (!currentClassId) {
                    console.error('클래스 ID가 없습니다.');
                    return;
                }
                
                // Firebase에서 클래스 정보를 가져와서 모드 확인
                await loadClassMode();
                
                // Firebase에서 미션 데이터를 먼저 가져오기
                await loadMissionsFromFirebase();
                
                // 학생 진행상황 데이터 로드
                await loadStudentProgressData();
                
            } catch (error) {
                console.error('데이터 로드 중 오류:', error);
                // 기본 데이터로 렌더링
                renderTodaysMissions();
                renderAllMissions();
                updateProgress();
            }
        }

        let groupCount = 8; // 기본 조 개수
        let individualCount = 35; // 기본 학생 수
        
        async function loadClassMode() {
            try {
                console.log('Firebase에서 클래스 모드 로드 중...');
                
                const result = await window.classProgressFunctions.getMissions(currentClassId);
                
                if (result.success && result.data.mode) {
                    classMode = result.data.mode;
                    console.log('클래스 모드 로드됨:', classMode);
                    
                    // 모드별 개수 가져오기
                    if (result.data.count) {
                        if (classMode === 'group') {
                            groupCount = parseInt(result.data.count);
                            console.log('조 개수 로드됨:', groupCount);
                        } else {
                            individualCount = parseInt(result.data.count);
                            console.log('학생 수 로드됨:', individualCount);
                        }
                    }
                    
                    // 모드에 따라 모달 업데이트
                    updateModalForMode();
                } else {
                    console.log('클래스 모드 정보 없음, 기본값 사용 (individual)');
                }
            } catch (error) {
                console.error('Firebase 클래스 모드 로드 오류:', error);
            }
        }
        
        function updateModalForMode() {
            const modalDescription = document.getElementById('modalDescription');
            const studentIdInput = document.getElementById('studentIdInput');
            
            console.log('updateModalForMode 실행, classMode:', classMode);
            
            if (classMode === 'group') {
                // 조별 모드로 모달 업데이트
                modalDescription.textContent = '조를 선택해주세요.';
                
                // 설정된 조 개수만큼 드롭다운 옵션 동적 생성
                let groupOptions = '<option value="">조를 선택하세요</option>';
                for(let i = 1; i <= groupCount; i++) {
                    groupOptions += `<option value="${i}">${i}조</option>`;
                }
                studentIdInput.innerHTML = groupOptions;
                console.log(`조별 모드로 드롭다운 업데이트 완료 (${groupCount}개 조)`);
            } else {
                // 개별 모드 (기본값)
                modalDescription.textContent = '번호를 선택해주세요.';
                
                // 개별 모드 드롭다운 옵션 동적 생성
                let individualOptions = '<option value="">번호를 선택하세요</option>';
                for(let i = 1; i <= individualCount; i++) {
                    individualOptions += `<option value="${i}">${i}</option>`;
                }
                studentIdInput.innerHTML = individualOptions;
                console.log(`개별 모드로 드롭다운 업데이트 완료 (${individualCount}명)`);
            }
        }

        async function loadMissionsFromFirebase() {
            try {
                console.log('Firebase에서 미션 데이터 로드 중...');
                
                const result = await window.classProgressFunctions.getMissions(currentClassId);
                
                if (result.success) {
                    // 전체 미션 업데이트
                    if (result.data.missions && Array.isArray(result.data.missions)) {
                        console.log('전체 미션 업데이트됨:', result.data.missions);
                        allMissions.length = 0;
                        allMissions.push(...result.data.missions);
                    }
                    
                    // 오늘의 미션 업데이트
                    if (result.data.todayMissions && Array.isArray(result.data.todayMissions)) {
                        console.log('오늘의 미션 ID들:', result.data.todayMissions);
                        console.log('전체 미션 목록:', allMissions);
                        todaysMissions.length = 0;
                        
                        // todayMissions ID 배열을 바탕으로 실제 미션 객체 생성
                        result.data.todayMissions.forEach(missionId => {
                            const mission = allMissions.find(m => m.id === missionId);
                            if (mission) {
                                console.log(`오늘의 미션 추가: ${missionId} - ${mission.text}`);
                                todaysMissions.push({
                                    id: mission.id,
                                    text: mission.text,
                                    completed: false // 기본값, 나중에 학생 진행상황으로 업데이트
                                });
                            } else {
                                console.log(`미션 ${missionId}를 전체 미션에서 찾을 수 없음`);
                            }
                        });
                        console.log('최종 todaysMissions:', todaysMissions);
                    } else {
                        console.log('Firebase에서 todayMissions 데이터 없음 또는 잘못된 형식');
                    }
                    
                    renderTodaysMissions();
                    renderAllMissions();
                    updateProgress();
                    
                } else {
                    console.error('미션 로드 실패:', result.error);
                    // 기본 데이터로 렌더링
                    renderTodaysMissions();
                    renderAllMissions();
                    updateProgress();
                }
            } catch (error) {
                console.error('Firebase 미션 로드 오류:', error);
                renderTodaysMissions();
                renderAllMissions();
                updateProgress();
            }
        }

        async function loadStudentProgressData() {
            try {
                console.log('Firebase에서 학생 데이터 로드 중...');
                
                const result = await window.classProgressFunctions.getStudentData(studentId, currentClassId);
                
                console.log('받은 학생 데이터:', result);
                
                if (result.success && result.data) {
                    console.log('학생 데이터 처리 시작');
                    console.log('Firebase 미션 데이터:', result.data.missions);
                    console.log('현재 todaysMissions:', todaysMissions);
                    
                    // 학생의 미션 완료 상태 업데이트
                    if (result.data.missions && Array.isArray(result.data.missions)) {
                        result.data.missions.forEach(serverMission => {
                            console.log(`Firebase 미션 ${serverMission.id}: ${serverMission.completed}`);
                            
                            const localMission = todaysMissions.find(m => m.id === serverMission.id);
                            if (localMission) {
                                console.log(`로컬 미션 ${localMission.id} 업데이트: ${serverMission.completed}`);
                                localMission.completed = serverMission.completed || false;
                            } else {
                                console.log(`로컬 미션 ${serverMission.id}를 찾을 수 없음`);
                            }
                        });
                    } else {
                        console.log('Firebase에서 미션 데이터 없음');
                    }
                    
                    if (result.data.messages) {
                        console.log('받은 메시지:', result.data.messages);
                        const newMessageCount = result.data.messages.length;
                        
                        // 새 메시지가 있는지 확인
                        if (newMessageCount > lastMessageCount && lastMessageCount > 0) {
                            const newMessages = newMessageCount - lastMessageCount;
                            console.log('새 메시지 감지!', newMessages, '개');
                            unreadMessageCount += newMessages;
                            updateMessageNotification();
                        }
                        
                        receivedMessages = result.data.messages;
                        lastMessageCount = newMessageCount;
                    }
                    
                    renderTodaysMissions();
                    updateProgress();
                } else {
                    console.error('학생 데이터 로드 실패:', result.error || '알 수 없는 오류');
                }
                
            } catch (error) {
                console.error('Firebase 학생 데이터 로드 오류:', error);
            }
        }

        function startMission() {
            const studentIdInputVal = studentIdInput.value;
            if (studentIdInputVal) {
                studentId = studentIdInputVal;
                studentIdModal.style.display = 'none';
                pageHeader.style.display = 'flex';
                mainContainer.style.display = 'flex';
                
                if (classMode === 'group') {
                    userInfo.textContent = studentId + '조';
                } else {
                    userInfo.textContent = studentId + '번';
                }
                
                // 초기 데이터 로드
                loadStudentData();
                window.missionsLoaded = true; // 첫 로딩 완료 플래그
                
                // 학생 접속 즉시 Firebase에 초기 진행상황 생성
                setTimeout(() => {
                    createInitialStudentProgress();
                }, 1000);
                
                // 초기 메시지 카운트 설정 (새 메시지 알림 방지)
                setTimeout(() => {
                    lastMessageCount = receivedMessages.length;
                    console.log('초기 메시지 카운트 설정:', lastMessageCount);
                    window.lastNotificationTime = Date.now(); // Firebase 알림 초기화
                }, 2000);
                
                // 🔥 Firebase 실시간 연결 시작!
                startFirebaseListeners();
                
                // 백업 새로고침 시작 (60초마다 - Firebase 실패시 대비)
                startBackupRefresh();
            } else {
                if (classMode === 'group') {
                    alert('조를 선택해주세요!');
                } else {
                    alert('번호를 선택해주세요!');
                }
            }
        }

        function startFirebaseListeners() {
            if (!currentClassId) {
                console.error('클래스 ID가 없어서 Firebase 연결 불가');
                return;
            }
            
            console.log('Firebase 실시간 연결 시작:', currentClassId);
            
            // 실시간 알림 구독
            const notificationUnsubscribe = window.classProgressFunctions.subscribeToNotifications(
                currentClassId,
                async (notification) => {
                    console.log('Firebase 알림 받음:', notification);
                    
                    if (notification.timestamp > window.lastNotificationTime) {
                        // 알림 타입에 따라 처리
                        switch(notification.type) {
                            case 'missions-updated':
                            case 'today-missions-updated':
                                console.log('미션 구조 변경 - 데이터 새로고침');
                                await reloadMissionsAndKeepProgress();
                                break;
                            case 'message-sent':
                                console.log('새 메시지 - 메시지 새로고침');
                                loadStudentProgressData();
                                break;
                        }
                        
                        window.lastNotificationTime = notification.timestamp;
                    }
                }
            );
            
            // 정리 함수 저장
            window.firebaseUnsubscribe = notificationUnsubscribe;
            
            console.log('🔥 Firebase 실시간 연결 완료!');
        }
        
        // 백업용 가벼운 새로고침 (60초마다 - Firebase 실패시 대비)
        function startBackupRefresh() {
            setInterval(() => {
                if (isVisible && studentId) {
                    console.log('백업 새로고침 (60초마다)');
                    loadStudentMessagesOnly();
                }
            }, 60000); // 60초마다
        }

        function refreshStudentData() {
            // 미션 목록은 한 번만 로드하고, 이후에는 학생 진행상황과 메시지만 체크
            if (!window.missionsLoaded) {
                console.log('최초 미션 데이터 로드');
                loadMissionsFromServer();
                window.missionsLoaded = true;
            } else {
                console.log('미션 데이터 이미 로드됨, 메시지만 새로고침');
                // 메시지만 체크 (학생 진행상황은 미션 클릭할 때만 업데이트)
                loadStudentMessagesOnly();
            }
        }

        async function loadStudentMessagesOnly() {
            if (!studentId || !currentClassId || !window.classProgressFunctions) {
                console.log('필요한 데이터가 없음:', { studentId, currentClassId, functions: window.classProgressFunctions });
                return;
            }
            
            try {
                const result = await window.classProgressFunctions.getStudentData(studentId, currentClassId);
                console.log('Firebase 메시지 전용 응답:', result);
                
                if (result.success && result.data && result.data.messages) {
                    const newMessageCount = result.data.messages.length;
                    
                    // 새 메시지가 있는지 확인
                    if (newMessageCount > lastMessageCount && lastMessageCount > 0) {
                        const newMessages = newMessageCount - lastMessageCount;
                        console.log('새 메시지 감지!', newMessages, '개');
                        unreadMessageCount += newMessages;
                        updateMessageNotification();
                    }
                    
                    receivedMessages = result.data.messages;
                    lastMessageCount = newMessageCount;
                } else {
                    console.log('메시지 체크 실패 또는 데이터 없음');
                }
            } catch (error) {
                console.error('메시지 로드 오류:', error);
            }
        }

        function renderTodaysMissions() {
            missionListEl.innerHTML = '';
            todaysMissions.forEach(mission => {
                const li = document.createElement('li');
                li.className = 'mission-item';
                if (mission.completed) {
                    li.classList.add('completed');
                }
                li.innerHTML = `
                    <div class="mission-checkbox" onclick="event.stopPropagation(); toggleMission(${mission.id})">${mission.completed ? '✔' : ''}</div>
                    <span class="mission-text" onclick="showMissionDetail(${mission.id})">${mission.text}</span>
                `;
                missionListEl.appendChild(li);
            });
            totalCountEl.textContent = todaysMissions.length;
        }
        
        function renderAllMissions() {
            allMissionListEl.innerHTML = '';
            allMissions.forEach(mission => {
                const div = document.createElement('div');
                let className = 'all-mission-item';
                if (todaysMissions.some(m => m.id === mission.id)) {
                    className += ' current';
                }
                div.className = className;
                div.innerHTML = `
                    <span class="step-number">${mission.id}.</span>
                    <span>${mission.text}</span>
                `;
                allMissionListEl.appendChild(div);
            });
        }

        function renderMessages() {
            messageListEl.innerHTML = '';
            if (receivedMessages.length === 0) {
                const li = document.createElement('li');
                li.innerHTML = '<span>아직 도착한 메시지가 없습니다.</span>';
                messageListEl.appendChild(li);
                return;
            }
            receivedMessages.forEach(message => {
                const li = document.createElement('li');
                li.innerHTML = `
                    <span>${message.text}</span>
                    <span class="timestamp">${message.timestamp}</span>
                `;
                messageListEl.appendChild(li);
            });
        }
        
        function updateMessageNotification() {
            const messageButton = document.getElementById('messageButton');
            
            if (unreadMessageCount > 0) {
                messageButton.classList.add('new-message');
                messageButton.setAttribute('data-unread-count', unreadMessageCount);
                
                if (unreadMessageCount === 1) {
                    messageButton.textContent = '새 메시지 있음! 📨';
                } else {
                    messageButton.textContent = `새 메시지 ${unreadMessageCount}개! 📨`;
                }
            } else {
                messageButton.classList.remove('new-message');
                messageButton.removeAttribute('data-unread-count');
                messageButton.textContent = '선생님 메시지 보기 ✉️';
            }
        }

        function showMessageModal() {
            renderMessages();
            messageModal.style.display = 'flex';
            
            // 메시지 모달을 열면 읽지 않은 메시지 카운트 초기화
            markMessagesAsRead();
        }

        function closeMessageModal() {
            messageModal.style.display = 'none';
        }
        
        function markMessagesAsRead() {
            unreadMessageCount = 0;
            updateMessageNotification();
            console.log('모든 메시지 읽음으로 처리');
        }

        function toggleMission(id) {
            const mission = todaysMissions.find(m => m.id === id);
            if (mission) {
                mission.completed = !mission.completed;
                renderTodaysMissions();
                updateProgress();
                sendProgressUpdate(studentId, todaysMissions);
            }
        }

        function updateProgress() {
            const completedMissions = todaysMissions.filter(m => m.completed).length;
            const totalMissions = todaysMissions.length;
            const progress = (completedMissions / totalMissions) * 100;
            
            completedCountEl.textContent = completedMissions;
            progressBarEl.style.width = `${progress}%`;
        }

        async function sendProgressUpdate(studentId, missionData) {
            try {
                console.log('Firebase 진행 상황 전송 데이터:', {
                    studentId: studentId,
                    classId: currentClassId,
                    missionData: missionData
                });
                
                const result = await window.classProgressFunctions.updateStudentProgress(
                    studentId, 
                    currentClassId, 
                    missionData
                );
                
                if (result.success) {
                    console.log('진행 상황 전송 성공');
                    console.log(`${studentId}번 학생 진행 상황 업데이트 완료 (진행률: ${result.progress}%)`);
                } else {
                    console.error('진행 상황 전송 실패:', result.error);
                    alert('진행 상황 전송에 실패했습니다.');
                }
                
            } catch (error) {
                console.error('전송 중 오류가 발생했습니다:', error);
                alert('진행 상황 전송에 실패했습니다.');
            }
        }

        async function sendHelpRequest() {
            if (!studentId) {
                alert('먼저 이름을 입력하고 시작해주세요.');
                return;
            }
            
            if (!currentClassId) {
                alert('클래스 ID가 없습니다.');
                return;
            }

            const helpButton = document.querySelector('.help-button');
            const originalText = helpButton.innerHTML;
            
            helpButton.disabled = true;
            helpButton.innerHTML = '요청 중...';

            try {
                // 도움 요청을 보내면서 진행상황도 업데이트
                await window.classProgressFunctions.updateStudentProgress(
                    studentId, 
                    currentClassId, 
                    todaysMissions,
                    true // helpNeeded를 true로 설정
                );
                const result = await window.classProgressFunctions.sendHelpRequest(studentId, currentClassId);
                
                if (result.success) {
                    console.log('도움 요청 전송 성공');
                    helpButton.innerHTML = '선생님께 전송 완료! ✅';
                    helpButton.style.display = 'none'; // 도움 요청 버튼 숨기기
                    document.getElementById('helpCancelButton').style.display = 'block'; // 취소 버튼 보이기
                    alert(`${studentId}${classMode === 'group' ? '조' : '번'}, 선생님께 도움 요청을 보냈습니다. 곧 방문하실 거예요!`);
                } else {
                    console.error('도움 요청 전송 실패:', result.error);
                    alert('도움 요청 전송에 실패했습니다.');
                }

                setTimeout(() => {
                    helpButton.disabled = false;
                    helpButton.innerHTML = originalText;
                }, 5000);
                
            } catch (error) {
                console.error('도움 요청 전송 중 오류 발생:', error);
                alert('도움 요청 전송에 실패했습니다.');
                helpButton.disabled = false;
                helpButton.innerHTML = originalText;
            }
        }

        // 실시간 미션 업데이트 시 진행상황을 유지하면서 새로고침
        async function reloadMissionsAndKeepProgress() {
            console.log('🔄 미션 구조 변경 - 진행상황 유지하며 새로고침');
            
            // 현재 진행상황 저장
            const currentProgress = {};
            todaysMissions.forEach(mission => {
                currentProgress[mission.id] = mission.completed;
            });
            console.log('현재 진행상황 저장:', currentProgress);
            
            // 새 미션 구조 로드
            await loadMissionsFromFirebase();
            
            // 진행상황 복원
            todaysMissions.forEach(mission => {
                if (currentProgress.hasOwnProperty(mission.id)) {
                    mission.completed = currentProgress[mission.id];
                    console.log(`미션 ${mission.id} 진행상황 복원: ${mission.completed}`);
                }
            });
            
            // 화면 업데이트
            renderTodaysMissions();
            renderAllMissions();
            updateProgress();
            
            console.log('✅ 미션 새로고침 완료 - 진행상황 유지됨');
        }

        async function cancelHelpRequest() {
            if (!studentId || !currentClassId) {
                alert('학생 정보가 없습니다.');
                return;
            }
            
            const helpCancelButton = document.getElementById('helpCancelButton');
            const helpButton = document.getElementById('helpButton');
            const originalText = helpCancelButton.innerHTML;
            
            helpCancelButton.disabled = true;
            helpCancelButton.innerHTML = '취소 중...';
            
            try {
                // Firebase에서 도움 요청 상태를 해제
                const result = await window.classProgressFunctions.updateStudentProgress(
                    studentId, 
                    currentClassId, 
                    todaysMissions,
                    false // helpNeeded를 false로 설정
                );
                
                if (result.success) {
                    console.log('도움 요청 취소 성공');
                    helpCancelButton.style.display = 'none'; // 취소 버튼 숨기기
                    helpButton.style.display = 'block'; // 도움 요청 버튼 다시 보이기
                    helpButton.innerHTML = '도와주세요! ✋';
                    alert('도움 요청을 취소했습니다.');
                } else {
                    console.error('도움 요청 취소 실패:', result.error);
                    alert('도움 요청 취소에 실패했습니다.');
                }
            } catch (error) {
                console.error('도움 요청 취소 중 오류:', error);
                alert('도움 요청 취소 중 오류가 발생했습니다.');
            } finally {
                helpCancelButton.disabled = false;
                helpCancelButton.innerHTML = originalText;
            }
        }
        
        // 현재 선택된 미션 ID
        let currentSelectedMissionId = null;
        
        // 미션 상세 내용 표시
        function showMissionDetail(missionId) {
            currentSelectedMissionId = missionId;
            const mission = allMissions.find(m => m.id === missionId);
            const missionDetailDisplay = document.getElementById('missionDetailDisplay');
            const missionMemoInput = document.getElementById('missionMemoInput');
            const saveMemoButton = document.getElementById('saveMemoButton');
            
            if (mission) {
                // 상세 내용 표시
                if (mission.description && mission.description.trim()) {
                    missionDetailDisplay.innerHTML = `
                        <h4>${mission.text}</h4>
                        <p>${mission.description.replace(/\n/g, '<br>')}</p>
                    `;
                } else {
                    missionDetailDisplay.innerHTML = `
                        <h4>${mission.text}</h4>
                        <p><em>선생님이 아직 상세 설명을 추가하지 않았습니다.</em></p>
                    `;
                }
                
                // 기존 메모 불러오기
                loadStudentMemo(missionId);
                
                // 저장 버튼 활성화
                saveMemoButton.disabled = false;
                
                // 메모 입력 시 저장 버튼 상태 업데이트
                missionMemoInput.oninput = function() {
                    saveMemoButton.disabled = false;
                    saveMemoButton.textContent = '메모 저장';
                };
            }
        }
        
        // 학생 메모 로드
        async function loadStudentMemo(missionId) {
            try {
                const result = await window.classProgressFunctions.getStudentData(studentId, currentClassId);
                if (result.success && result.data && result.data.memos) {
                    const memo = result.data.memos.find(m => m.missionId === missionId);
                    if (memo) {
                        document.getElementById('missionMemoInput').value = memo.content || '';
                    } else {
                        document.getElementById('missionMemoInput').value = '';
                    }
                }
            } catch (error) {
                console.error('메모 로드 오류:', error);
            }
        }
        
        // 미션 메모 저장
        async function saveMissionMemo() {
            if (!currentSelectedMissionId || !studentId || !currentClassId) {
                alert('미션을 먼저 선택해주세요.');
                return;
            }
            
            const memoContent = document.getElementById('missionMemoInput').value.trim();
            const saveMemoButton = document.getElementById('saveMemoButton');
            
            saveMemoButton.disabled = true;
            saveMemoButton.textContent = '저장 중...';
            
            try {
                // Firebase에 메모 저장
                const result = await window.classProgressFunctions.saveMissionMemo(
                    studentId, 
                    currentClassId, 
                    currentSelectedMissionId, 
                    memoContent
                );
                
                if (result.success) {
                    saveMemoButton.textContent = '저장 완료!';
                    setTimeout(() => {
                        saveMemoButton.textContent = '메모 저장';
                        saveMemoButton.disabled = true;
                    }, 1500);
                } else {
                    console.error('메모 저장 실패:', result.error);
                    alert('메모 저장에 실패했습니다.');
                    saveMemoButton.disabled = false;
                    saveMemoButton.textContent = '메모 저장';
                }
            } catch (error) {
                console.error('메모 저장 오류:', error);
                alert('메모 저장 중 오류가 발생했습니다.');
                saveMemoButton.disabled = false;
                saveMemoButton.textContent = '메모 저장';
            }
        }
        
        // 학생 접속 시 초기 진행상황을 Firebase에 생성
        async function createInitialStudentProgress() {
            if (!studentId || !currentClassId || !window.classProgressFunctions) {
                console.log('초기 진행상황 생성 불가:', { studentId, currentClassId, functions: window.classProgressFunctions });
                return;
            }

            try {
                console.log('학생 초기 진행상황 생성 중...', { studentId, currentClassId });
                
                // 빈 미션 데이터로 초기 진행상황 생성 (0% 진행률)
                const initialMissionData = todaysMissions.map(mission => ({
                    id: mission.id,
                    text: mission.text,
                    completed: false
                }));

                const result = await window.classProgressFunctions.updateStudentProgress(
                    studentId, 
                    currentClassId, 
                    initialMissionData
                );

                if (result.success) {
                    console.log('✅ 초기 진행상황 생성 성공:', result);
                } else {
                    console.error('❌ 초기 진행상황 생성 실패:', result.error);
                }
            } catch (error) {
                console.error('초기 진행상황 생성 오류:', error);
            }
        }
    </script>
</body>
</html>
